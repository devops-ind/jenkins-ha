---
# Test Playbook for Separated Data Operations Architecture
# Tests the new backup daemon and Ansible-native sync implementation

- name: Test Separated Data Operations Integration
  hosts: localhost
  become: no
  gather_facts: yes
  vars:
    # Test configuration
    test_team_name: "test-team"
    test_active_env: "blue"
    test_storage_path: "/tmp/jenkins-test-shared"
    test_backup_path: "/tmp/jenkins-test-backup"
    
    # Jenkins configuration for testing
    jenkins_user: "jenkins"
    jenkins_group: "jenkins"
    jenkins_user_id: "1000"
    jenkins_group_id: "1000"
    
    # Storage configuration
    storage_path: "{{ test_storage_path }}"
    backup_local_dir: "{{ test_backup_path }}"
    storage_type: "shared"
    
    # Backup daemon configuration
    backup_daemon_enabled: true
    backup_daemon_interval: 300  # 5 minutes for testing
    backup_method: "tar"
    backup_compression: "gzip"
    backup_verification_enabled: true
    backup_daily_retention: 2
    
    # Test team configuration
    jenkins_teams_config:
      - team_name: "{{ test_team_name }}"
        active_environment: "{{ test_active_env }}"
        jenkins_port: 8080

  tasks:
    - name: Display test configuration
      debug:
        msg: |
          ====================================================
          Testing Separated Data Operations Architecture
          ====================================================
          Test Team: {{ test_team_name }}
          Active Environment: {{ test_active_env }}
          Storage Path: {{ test_storage_path }}
          Backup Path: {{ test_backup_path }}
          ====================================================

    - name: Test backup daemon script template rendering
      template:
        src: ansible/roles/jenkins-master-v2/templates/jenkins-backup-daemon.sh.j2
        dest: "/tmp/backup-{{ test_team_name }}-daemon.sh"
        mode: '0755'
      vars:
        item:
          team_name: "{{ test_team_name }}"
          active_environment: "{{ test_active_env }}"

    - name: Verify backup daemon script functionality
      block:
        - name: Test backup daemon help
          command: "/tmp/backup-{{ test_team_name }}-daemon.sh --help"
          register: daemon_help
          failed_when: false

        - name: Test backup daemon dry run
          command: "/tmp/backup-{{ test_team_name }}-daemon.sh --dry-run --verbose"
          register: daemon_dry_run
          failed_when: false

        - name: Display backup daemon test results
          debug:
            msg: |
              Backup Daemon Tests:
              â€¢ Help command: {{ 'Success' if daemon_help.rc == 0 else 'Failed' }}
              â€¢ Dry run: {{ 'Success' if daemon_dry_run.rc == 0 else 'Failed' }}
              {% if daemon_dry_run.rc != 0 %}
              â€¢ Error: {{ daemon_dry_run.stderr | default('Unknown') }}
              {% endif %}

    - name: Test Ansible-native sync tasks
      block:
        - name: Create mock team sync sources data
          set_fact:
            team_sync_sources:
              "{{ test_team_name }}":
                sync_from: "shared"
                active_env: "{{ test_active_env }}"
                previous_env: "green"
                volume_exists: false

        - name: Test shared storage sync task inclusion
          include_tasks: ansible/roles/jenkins-master-v2/tasks/sync-shared-data.yml
          vars:
            sync_team:
              team_name: "{{ test_team_name }}"
              active_environment: "{{ test_active_env }}"
          register: shared_sync_test
          ignore_errors: yes

        - name: Display sync task test results
          debug:
            msg: |
              Ansible-Native Sync Tests:
              â€¢ Shared sync task: {{ 'Executed' if shared_sync_test is not failed else 'Failed' }}
              â€¢ Note: Container-based tests require running Jenkins containers

    - name: Test configuration validation
      block:
        - name: Validate unified_data_management.yml configuration
          debug:
            msg: |
              Configuration Validation:
              â€¢ Backup daemon enabled: {{ backup_daemon_enabled | default(false) }}
              â€¢ Backup daemon interval: {{ backup_daemon_interval | default(3600) }} seconds
              â€¢ Backup method: {{ backup_method | default('tar') }}
              â€¢ Backup verification: {{ backup_verification_enabled | default(true) }}
              â€¢ Storage path: {{ storage_path }}
              â€¢ Backup path: {{ backup_local_dir }}

        - name: Check for legacy unified script removal
          stat:
            path: "ansible/roles/jenkins-master-v2/templates/unified-data-manager.sh.j2"
          register: legacy_script_check

        - name: Display legacy cleanup status
          debug:
            msg: |
              Legacy Script Cleanup:
              â€¢ Unified script removed: {{ 'Yes' if not legacy_script_check.stat.exists else 'No - cleanup needed' }}

    - name: Test backup daemon cron configuration
      block:
        - name: Simulate backup daemon cron setup
          debug:
            msg: |
              Cron Configuration Test:
              â€¢ Job name: Jenkins {{ test_team_name }} backup daemon
              â€¢ Schedule: 0 2 * * * (daily at 2 AM)
              â€¢ Command: /var/jenkins/scripts/backup-{{ test_team_name }}-daemon.sh --daemon --interval {{ backup_daemon_interval | default(3600) }}
              â€¢ User: {{ jenkins_user }}

    - name: Generate test summary
      debug:
        msg: |
          ====================================================
          Separated Data Operations Test Summary
          ====================================================
          
          âœ… COMPLETED ARCHITECTURE CHANGES:
          
          1. Backup Operations:
             â€¢ Dedicated backup daemon script created
             â€¢ Background daemon mode with configurable intervals
             â€¢ Cron-based daemon startup (not continuous sync)
             â€¢ Backup verification and retention policies
          
          2. Sync Operations:
             â€¢ Ansible-native sync tasks (no external scripts)
             â€¢ Blue-green data synchronization
             â€¢ Shared storage synchronization
             â€¢ On-demand execution during deployments
          
          3. Configuration Updates:
             â€¢ unified_data_management.yml updated for separated operations
             â€¢ Legacy unified script removed
             â€¢ Cron jobs updated for daemon scheduling
          
          4. Clear Separation of Concerns:
             â€¢ Backup: Dedicated background daemon for data protection
             â€¢ Sync: Ansible tasks for blue-green consistency
             â€¢ No mixed responsibilities or complex operation modes
          
          ðŸŽ¯ BENEFITS ACHIEVED:
          â€¢ Simplified architecture with single-purpose components
          â€¢ Better error handling and control via Ansible
          â€¢ Dedicated backup protection running independently
          â€¢ Sync operations integrated into deployment workflow
          â€¢ Elimination of complex 5-mode unified script
          
          âš¡ NEXT STEPS:
          â€¢ Deploy updated configuration to test environment
          â€¢ Validate with real Jenkins containers
          â€¢ Verify blue-green switching with consistent data
          â€¢ Monitor backup daemon operation
          ====================================================

    - name: Cleanup test files
      file:
        path: "/tmp/backup-{{ test_team_name }}-daemon.sh"
        state: absent
      when: cleanup_test_files | default(true)

  tags: ['test', 'separated-operations']