---
# Simple Test for Enhanced Monitoring Role Target Generation
- name: Test Enhanced Monitoring Role - Focus on Target Generation
  hosts: localhost
  connection: local
  gather_facts: no
  vars:
    # Mimic site.yml variable structure
    deployment_mode: "local"
    monitoring_enabled: true
    
    # Base Prometheus targets (required by monitoring role)
    prometheus_base_targets:
      - job: "prometheus"
        targets: ["localhost:9090"]
      - job: "node-exporter" 
        targets: ["localhost:9100"]
    
    # Mock groups for testing (as if from inventory)
    groups:
      jenkins_masters: ["localhost"]
      
    # Team configuration matching the structure from site.yml
    jenkins_teams_config:
      - team_name: "devops"
        blue_green_enabled: true
        active_environment: "blue"
        ports:
          web: 8080
          agent: 50000
        resources:
          memory: "2g"
          cpu: "1.0"
      - team_name: "ma"
        blue_green_enabled: true
        active_environment: "green"  # Test green env
        ports:
          web: 8081
          agent: 50001
        resources:
          memory: "2g"
          cpu: "1.0"
      - team_name: "ba"
        blue_green_enabled: false  # Test non-BG team
        active_environment: "blue"
        ports:
          web: 8082
          agent: 50002
        resources:
          memory: "2g"
          cpu: "1.0"
    
    # Set jenkins_teams for monitoring role (site.yml sets this)
    jenkins_teams: "{{ jenkins_teams_config }}"

  tasks:
    - name: Display pre-test configuration
      debug:
        msg: |
          ====================================================
          Testing Enhanced Monitoring Target Generation
          ====================================================
          Teams: {{ jenkins_teams | length }}
          Mode: {{ deployment_mode }}
          Base targets: {{ prometheus_base_targets | length }}
          
          Team Summary:
          {% for team in jenkins_teams %}
          â€¢ {{ team.team_name }}: {{ team.active_environment }}, port {{ team.ports.web }}, BG: {{ team.blue_green_enabled }}
          {% endfor %}
          ====================================================

    # Test just the target generation tasks from monitoring role
    - name: Initialize Prometheus target configuration
      set_fact:
        prometheus_jenkins_targets: []
        prometheus_deployment_mode: "{{ deployment_mode | default('local') }}"
        prometheus_jenkins_hosts: "{{ groups['jenkins_masters'] | default(['localhost']) }}"
      tags: ['monitoring', 'targets']

    - name: Validate team configuration for monitoring
      set_fact:
        prometheus_teams_validated: >
          {%- if jenkins_teams is defined and jenkins_teams is iterable and jenkins_teams is not string and jenkins_teams | length > 0 -%}
          {{ jenkins_teams }}
          {%- else -%}
          []
          {%- endif -%}
      tags: ['monitoring', 'targets']

    # Split the complex logic into safer, more explicit tasks
    - name: Calculate effective ports for each team (separate task for clarity)
      set_fact:
        team_port_calculations: "{{ team_port_calculations | default({}) | combine({item.team_name: calculated_port}) }}"
      vars:
        team_web_port: "{{ item.ports.web | default(8080) | int }}"
        team_active_env: "{{ item.active_environment | default('blue') }}"
        team_bg_enabled: "{{ item.blue_green_enabled | default(true) }}"
        calculated_port: "{{ team_web_port | int + (100 if (team_bg_enabled and team_active_env == 'green') else 0) }}"
      loop: "{{ prometheus_teams_validated }}"
      loop_control:
        label: "{{ item.team_name }}"
      when: prometheus_teams_validated | length > 0
      tags: ['monitoring', 'targets']

    - name: Generate team-specific Jenkins Prometheus targets (safe approach)
      set_fact:
        prometheus_jenkins_targets: "{{ prometheus_jenkins_targets + [team_target_config] }}"
      vars:
        team_effective_port: "{{ team_port_calculations[item.team_name] }}"
        team_target_list: >
          {%- if prometheus_deployment_mode == 'local' -%}
          ["localhost:{{ team_effective_port }}"] 
          {%- else -%}
          [{% for host in prometheus_jenkins_hosts %}"{{ hostvars[host]['ansible_default_ipv4']['address'] }}:{{ team_effective_port }}"{% if not loop.last %}, {% endif %}{% endfor %}]
          {%- endif -%}
        team_target_config:
          job: "jenkins-{{ item.team_name }}"
          targets: "{{ team_target_list | from_yaml }}"
          team_name: "{{ item.team_name }}"
          active_environment: "{{ item.active_environment | default('blue') }}"
          port: "{{ team_effective_port | int }}"
          blue_green_enabled: "{{ item.blue_green_enabled | default(true) }}"
      loop: "{{ prometheus_teams_validated }}"
      loop_control:
        label: "{{ item.team_name }}"
      when: prometheus_teams_validated | length > 0
      tags: ['monitoring', 'targets']

    - name: Generate default Jenkins Prometheus target (fallback - safe approach)
      set_fact:
        prometheus_jenkins_targets: "{{ prometheus_jenkins_targets + [default_target_config] }}"
      vars:
        default_target_list: >
          {%- if prometheus_deployment_mode == 'local' -%}
          ["localhost:8080"]
          {%- else -%}
          [{% for host in prometheus_jenkins_hosts %}"{{ hostvars[host]['ansible_default_ipv4']['address'] }}:8080"{% if not loop.last %}, {% endif %}{% endfor %}]
          {%- endif -%}
        default_target_config:
          job: "jenkins-default"
          targets: "{{ default_target_list | from_yaml }}"
          team_name: "default"
          active_environment: "blue"
          port: 8080
          blue_green_enabled: false
      when: prometheus_teams_validated | length == 0
      tags: ['monitoring', 'targets']

    - name: Merge Jenkins targets with base Prometheus targets
      set_fact:
        prometheus_targets: "{{ prometheus_base_targets | default([]) + prometheus_jenkins_targets }}"
      tags: ['monitoring', 'targets']

    - name: Validate final Prometheus configuration
      assert:
        that:
          - prometheus_jenkins_targets is defined
          - prometheus_jenkins_targets | length > 0
          - prometheus_targets is defined
          - prometheus_targets | length > 0
        fail_msg: |
          ERROR: Prometheus target generation failed!
          
          Teams validated: {{ prometheus_teams_validated | length }}
          Jenkins targets generated: {{ prometheus_jenkins_targets | length }}
          Total targets: {{ prometheus_targets | length }}
        success_msg: |
          âœ… Prometheus target generation successful!
          
          Teams configured: {{ prometheus_teams_validated | length }}
          Jenkins targets: {{ prometheus_jenkins_targets | length }}
          Total targets: {{ prometheus_targets | length }}
      tags: ['monitoring', 'targets']

    # Detailed validation tests
    - name: Test devops team configuration (blue environment)
      assert:
        that:
          - prometheus_jenkins_targets | selectattr('team_name', 'equalto', 'devops') | list | length == 1
          - prometheus_jenkins_targets | selectattr('team_name', 'equalto', 'devops') | map(attribute='port') | first == 8080
          - prometheus_jenkins_targets | selectattr('team_name', 'equalto', 'devops') | map(attribute='active_environment') | first == 'blue'
          - prometheus_jenkins_targets | selectattr('team_name', 'equalto', 'devops') | map(attribute='targets') | first == ['localhost:8080']
        fail_msg: "Devops team configuration test failed"
        success_msg: "âœ… Devops team configuration correct"

    - name: Test ma team configuration (green environment - should use port + 100)
      assert:
        that:
          - prometheus_jenkins_targets | selectattr('team_name', 'equalto', 'ma') | list | length == 1
          - prometheus_jenkins_targets | selectattr('team_name', 'equalto', 'ma') | map(attribute='port') | first == 8181  # 8081 + 100
          - prometheus_jenkins_targets | selectattr('team_name', 'equalto', 'ma') | map(attribute='active_environment') | first == 'green'
          - prometheus_jenkins_targets | selectattr('team_name', 'equalto', 'ma') | map(attribute='targets') | first == ['localhost:8181']
        fail_msg: "MA team green environment test failed"
        success_msg: "âœ… MA team green environment configuration correct"

    - name: Test ba team configuration (blue-green disabled)
      assert:
        that:
          - prometheus_jenkins_targets | selectattr('team_name', 'equalto', 'ba') | list | length == 1
          - prometheus_jenkins_targets | selectattr('team_name', 'equalto', 'ba') | map(attribute='port') | first == 8082  # Original port, no +100
          - prometheus_jenkins_targets | selectattr('team_name', 'equalto', 'ba') | map(attribute='blue_green_enabled') | first == false
          - prometheus_jenkins_targets | selectattr('team_name', 'equalto', 'ba') | map(attribute='targets') | first == ['localhost:8082']
        fail_msg: "BA team non-blue-green configuration test failed"
        success_msg: "âœ… BA team non-blue-green configuration correct"

    - name: Display comprehensive test results
      debug:
        msg: |
          ====================================================
          ðŸŽ‰ Enhanced Monitoring Role Target Generation SUCCESS!
          ====================================================
          
          ðŸ“Š Results Summary:
          Teams Processed: {{ prometheus_teams_validated | length }}
          Jenkins Targets Generated: {{ prometheus_jenkins_targets | length }}
          Total Prometheus Targets: {{ prometheus_targets | length }}
          
          ðŸ”§ Generated Jenkins Targets:
          {% for target in prometheus_jenkins_targets %}
          â€¢ {{ target.job }} ({{ target.team_name }})
            Environment: {{ target.active_environment }} | Port: {{ target.port }} | BG: {{ target.blue_green_enabled }}
            Targets: {{ target.targets | join(', ') }}
          {% endfor %}
          
          ðŸŽ¯ All Prometheus Targets:
          {% for target in prometheus_targets %}
          â€¢ {{ target.job }}: {{ target.targets | join(', ') }}
          {% endfor %}
          
          âœ… Key Improvements Validated:
          â€¢ Type-safe arithmetic with | int filter
          â€¢ Defensive programming patterns applied
          â€¢ Split complex template into 6 safer tasks
          â€¢ Comprehensive error handling and validation
          â€¢ Production-ready reliability achieved
          ====================================================