# Container log rotation configuration
# Generated by Ansible - DO NOT EDIT MANUALLY

# Container runtime logs (Podman/Docker)
{% if common_container_runtime == "podman" %}
# Podman container logs (rootful)
/var/lib/containers/storage/overlay-containers/*/userdata/ctr.log {
    daily
    missingok
    rotate {{ common_log_retention_days }}
    compress
    delaycompress
    notifempty
    create 0640 root root
    size {{ common_log_max_size }}
    maxage {{ common_log_retention_days }}
    
    postrotate
        # Signal containers to reopen log files
        systemctl reload podman > /dev/null 2>&1 || true
    endscript
}

# Podman system logs
/var/log/containers/*.log {
    daily
    missingok
    rotate {{ common_log_retention_days }}
    compress
    delaycompress
    notifempty
    create 0640 root root
    maxage {{ common_log_retention_days }}
}

# Conmon logs
/var/log/conmon/*.log {
    daily
    missingok
    rotate 14
    compress
    delaycompress
    notifempty
    create 0640 root root
    maxsize 100M
}

{% if common_enable_rootless_containers %}
# Rootless user container logs
{% for user in common_rootless_users + [common_monitoring_user] %}
/home/{{ user }}/.local/share/containers/storage/overlay-containers/*/userdata/ctr.log {
    daily
    missingok
    rotate {{ common_log_retention_days }}
    compress
    delaycompress
    notifempty
    su {{ user }} {{ user }}
    create 0640 {{ user }} {{ user }}
    size {{ common_log_max_size }}
    maxage {{ common_log_retention_days }}
    
    postrotate
        su {{ user }} -c 'systemctl --user reload podman > /dev/null 2>&1' || true
    endscript
}

# User-specific container logs directory
/home/{{ user }}/.local/share/containers/logs/*.log {
    daily
    missingok
    rotate 14
    compress
    delaycompress
    notifempty
    su {{ user }} {{ user }}
    create 0640 {{ user }} {{ user }}
    maxage 14
}
{% endfor %}
{% endif %}

{% else %}
# Docker container logs
/var/lib/docker/containers/*/*-json.log {
    daily
    missingok
    rotate {{ common_log_retention_days }}
    compress
    delaycompress
    notifempty
    create 0640 root root
    size {{ common_log_max_size }}
    maxage {{ common_log_retention_days }}
    
    postrotate
        systemctl reload docker > /dev/null 2>&1 || true
    endscript
}
{% endif %}

# Application-specific container logs
{% if common_health_check_containers is defined %}
{% for container in common_health_check_containers %}
# {{ container }} container logs
/var/log/containers/{{ container }}.log {
    daily
    missingok
    rotate {{ common_log_retention_days }}
    compress
    delaycompress
    notifempty
    create 0640 {{ common_monitoring_user }} {{ common_monitoring_user }}
    size {{ common_log_max_size }}
    
    postrotate
        # Restart container logging if needed
        {{ common_container_runtime }} kill --signal=USR1 {{ container }} > /dev/null 2>&1 || true
    endscript
}
{% endfor %}
{% endif %}

# Structured logs (JSON format)
{% if common_enable_structured_logging %}
/var/log/containers/*.json {
    daily
    missingok
    rotate {{ common_log_retention_days }}
    compress
    delaycompress
    notifempty
    create 0640 root root
    size {{ common_log_max_size }}
    maxage {{ common_log_retention_days }}
}
{% endif %}

# Monitoring logs
/var/log/monitoring/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 0640 {{ common_monitoring_user }} {{ common_monitoring_user }}
    maxsize 50M
}