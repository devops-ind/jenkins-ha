#!/bin/bash

###############################################################################
# Container Health Check Script
# Generated by Ansible - DO NOT EDIT MANUALLY
# 
# This script monitors the health of critical containers and attempts
# automatic recovery for failed services.
###############################################################################

set -euo pipefail

# Configuration
CONTAINER_RUNTIME="{{ common_container_runtime }}"
LOG_FILE="/var/log/container-health-check.log"
NOTIFICATION_EMAIL="{{ common_notification_email | default('admin@localhost') }}"
CONTAINERS=(
{% for container in common_health_check_containers %}
    "{{ container }}"
{% endfor %}
)

# Health check settings
MAX_RESTART_ATTEMPTS=3
RESTART_DELAY=30
HEALTH_CHECK_TIMEOUT=10

# Logging functions
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOG_FILE"
}

log_error() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] ERROR: $*" | tee -a "$LOG_FILE" >&2
}

# Check if container is running
is_container_running() {
    local container="$1"
    if $CONTAINER_RUNTIME ps --filter "name=$container" --filter "status=running" --format "{{ '{{' }}.Names{{ '}}' }}" | grep -q "^$container$"; then
        return 0
    else
        return 1
    fi
}

# Check container health
check_container_health() {
    local container="$1"
    
    # Check if container exists and is running
    if ! is_container_running "$container"; then
        log_error "Container $container is not running"
        return 1
    fi
    
    # Check container health status (if health check is configured)
    local health_status
    if health_status=$($CONTAINER_RUNTIME inspect "$container" --format "{{ '{{' }}.State.Health.Status{{ '}}' }}" 2>/dev/null); then
        if [[ "$health_status" == "unhealthy" ]]; then
            log_error "Container $container is unhealthy"
            return 1
        fi
    fi
    
    # Additional health checks based on container type
    case "$container" in
        *prometheus*)
            if ! curl -s -f --max-time $HEALTH_CHECK_TIMEOUT "http://localhost:9090/-/ready" >/dev/null 2>&1; then
                log_error "Prometheus health check failed"
                return 1
            fi
            ;;
        *grafana*)
            if ! curl -s -f --max-time $HEALTH_CHECK_TIMEOUT "http://localhost:3000/api/health" >/dev/null 2>&1; then
                log_error "Grafana health check failed"
                return 1
            fi
            ;;
        *alertmanager*)
            if ! curl -s -f --max-time $HEALTH_CHECK_TIMEOUT "http://localhost:9093/-/ready" >/dev/null 2>&1; then
                log_error "Alertmanager health check failed"
                return 1
            fi
            ;;
        *node-exporter*)
            if ! curl -s -f --max-time $HEALTH_CHECK_TIMEOUT "http://localhost:9100/metrics" >/dev/null 2>&1; then
                log_error "Node exporter health check failed"
                return 1
            fi
            ;;
    esac
    
    return 0
}

# Restart container
restart_container() {
    local container="$1"
    local attempt="$2"
    
    log "Attempting to restart container $container (attempt $attempt/$MAX_RESTART_ATTEMPTS)"
    
    # Stop container gracefully
    if $CONTAINER_RUNTIME stop "$container" --time 30; then
        log "Container $container stopped successfully"
    else
        log_error "Failed to stop container $container gracefully, forcing stop"
        $CONTAINER_RUNTIME kill "$container" || true
    fi
    
    # Wait a bit before starting
    sleep $RESTART_DELAY
    
    # Start container
    if $CONTAINER_RUNTIME start "$container"; then
        log "Container $container started successfully"
        
        # Wait for container to be ready
        sleep 30
        
        # Verify container is healthy
        if check_container_health "$container"; then
            log "Container $container is healthy after restart"
            return 0
        else
            log_error "Container $container is still unhealthy after restart"
            return 1
        fi
    else
        log_error "Failed to start container $container"
        return 1
    fi
}

# Send notification
send_notification() {
    local subject="$1"
    local message="$2"
    
    if command -v mail >/dev/null 2>&1; then
        echo "$message" | mail -s "$subject" "$NOTIFICATION_EMAIL"
    fi
    
    # Log to syslog as well
    logger -t container-health-check "$subject: $message"
}

# Main health check function
perform_health_checks() {
    local failed_containers=()
    local recovered_containers=()
    
    log "Starting health check for ${#CONTAINERS[@]} containers"
    
    for container in "${CONTAINERS[@]}"; do
        if check_container_health "$container"; then
            log "Container $container is healthy"
        else
            log_error "Container $container failed health check"
            failed_containers+=("$container")
            
            # Attempt restart
            local restart_success=false
            for ((attempt=1; attempt<=MAX_RESTART_ATTEMPTS; attempt++)); do
                if restart_container "$container" "$attempt"; then
                    restart_success=true
                    recovered_containers+=("$container")
                    break
                fi
                
                if [[ $attempt -lt $MAX_RESTART_ATTEMPTS ]]; then
                    log "Restart attempt $attempt failed, waiting before next attempt"
                    sleep $((RESTART_DELAY * attempt))
                fi
            done
            
            if [[ "$restart_success" == false ]]; then
                log_error "Failed to recover container $container after $MAX_RESTART_ATTEMPTS attempts"
                send_notification \
                    "Container Health Check Alert: $container Failed" \
                    "Container $container has failed health checks and could not be automatically recovered. Manual intervention required."
            fi
        fi
    done
    
    # Summary
    if [[ ${#failed_containers[@]} -eq 0 ]]; then
        log "All containers are healthy"
    else
        log "Health check completed. Failed: ${#failed_containers[@]}, Recovered: ${#recovered_containers[@]}"
        
        if [[ ${#recovered_containers[@]} -gt 0 ]]; then
            send_notification \
                "Container Health Check: Recovery Success" \
                "The following containers were automatically recovered: ${recovered_containers[*]}"
        fi
    fi
}

# Cleanup function
cleanup_logs() {
    # Rotate log if it gets too large (>10MB)
    if [[ -f "$LOG_FILE" ]] && [[ $(stat -f%z "$LOG_FILE" 2>/dev/null || stat -c%s "$LOG_FILE" 2>/dev/null || echo 0) -gt 10485760 ]]; then
        mv "$LOG_FILE" "$LOG_FILE.old"
        touch "$LOG_FILE"
        log "Health check log rotated"
    fi
}

# System resource check
check_system_resources() {
    # Check disk space
    local disk_usage
    disk_usage=$(df / | awk 'NR==2 {print $5}' | sed 's/%//')
    
    if [[ $disk_usage -gt 90 ]]; then
        log_error "Disk usage is critically high: ${disk_usage}%"
        send_notification \
            "System Alert: High Disk Usage" \
            "Disk usage on the system is at ${disk_usage}%. Container health may be impacted."
    fi
    
    # Check memory usage
    local mem_usage
    mem_usage=$(free | awk 'NR==2{printf "%.0f", $3/$2*100}')
    
    if [[ $mem_usage -gt 90 ]]; then
        log_error "Memory usage is critically high: ${mem_usage}%"
        send_notification \
            "System Alert: High Memory Usage" \
            "Memory usage on the system is at ${mem_usage}%. Container performance may be impacted."
    fi
    
    log "System resources - Disk: ${disk_usage}%, Memory: ${mem_usage}%"
}

# Main execution
main() {
    # Create log file if it doesn't exist
    touch "$LOG_FILE"
    
    # Check if container runtime is available
    if ! command -v "$CONTAINER_RUNTIME" >/dev/null 2>&1; then
        log_error "$CONTAINER_RUNTIME is not installed or not in PATH"
        exit 1
    fi
    
    log "=== Container Health Check Started ==="
    
    # Check system resources first
    check_system_resources
    
    # Perform container health checks
    perform_health_checks
    
    # Cleanup
    cleanup_logs
    
    log "=== Container Health Check Completed ==="
}

# Run main function
main "$@"