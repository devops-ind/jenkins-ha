# HAProxy Backend Configuration for {{ item.team_name | title }} Team
# Generated by Ansible high-availability role

backend jenkins_backend_{{ item.team_name }}
    balance {{ backend_balance_method | default('roundrobin') }}
    option httpchk GET /login
    http-check expect status 200
    
    # Team-specific configuration
    {% if item.description is defined %}
    # {{ item.description }}
    {% endif %}
    
    # Blue-Green deployment configuration
    {% if item.blue_green_enabled | default(true) %}
    # Blue environment servers
    {% for host in groups['jenkins_masters'] | default([]) %}
    server {{ item.team_name }}-{{ hostvars[host]['inventory_hostname'] }}-blue {{ hostvars[host]['ansible_default_ipv4']['address'] }}:{{ item.ports.web | default(8080) }} check inter {{ haproxy_check_interval | default('5s') }} fall {{ haproxy_check_fall | default(3) }} rise {{ haproxy_check_rise | default(2) }} {% if item.active_environment | default('blue') == 'blue' %}{% else %}backup{% endif %}
    
    {% endfor %}
    
    # Green environment servers  
    {% for host in groups['jenkins_masters'] | default([]) %}
    server {{ item.team_name }}-{{ hostvars[host]['inventory_hostname'] }}-green {{ hostvars[host]['ansible_default_ipv4']['address'] }}:{{ (item.ports.web | default(8080)) + 100 }} check inter {{ haproxy_check_interval | default('5s') }} fall {{ haproxy_check_fall | default(3) }} rise {{ haproxy_check_rise | default(2) }} {% if item.active_environment | default('blue') == 'green' %}{% else %}backup{% endif %}
    
    {% endfor %}
    {% else %}
    # Single environment servers
    {% for host in groups['jenkins_masters'] | default([]) %}
    server {{ item.team_name }}-{{ hostvars[host]['inventory_hostname'] }} {{ hostvars[host]['ansible_default_ipv4']['address'] }}:{{ item.ports.web | default(8080) }} check inter {{ haproxy_check_interval | default('5s') }} fall {{ haproxy_check_fall | default(3) }} rise {{ haproxy_check_rise | default(2) }} maxconn {{ backend_max_connections | default(100) }}
    {% endfor %}
    {% endif %}
    
    # Team-specific HTTP headers
    http-response set-header X-Jenkins-Team {{ item.team_name }}
    http-response set-header X-Jenkins-Environment {{ item.active_environment | default('blue') }}
    {% if item.blue_green_enabled | default(true) %}
    http-response set-header X-Blue-Green-Enabled true
    {% endif %}
    
    # Custom health check path if specified
    {% if item.health_check_path is defined %}
    option httpchk GET {{ item.health_check_path }}
    {% endif %}
    
    # Team-specific timeouts if configured
    {% if item.timeout_connect is defined %}
    timeout connect {{ item.timeout_connect }}
    {% endif %}
    {% if item.timeout_server is defined %}
    timeout server {{ item.timeout_server }}
    {% endif %}
    
    # Stick table for session persistence (if enabled)
    {% if item.session_persistence | default(false) %}
    stick-table type ip size 200k expire 30m
    stick on src
    {% endif %}