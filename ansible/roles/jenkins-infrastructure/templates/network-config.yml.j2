---
# Jenkins Blue-Green Multi-Team Network Configuration
# Generated by Ansible on {{ ansible_date_time.iso8601 }}

network:
  name: {{ jenkins_network_name }}
  driver: {{ jenkins_network_driver }}
  subnet: {{ jenkins_network_subnet }}
  gateway: {{ jenkins_network_gateway }}
  container_runtime: {{ jenkins_container_runtime }}
  deployment_mode: blue-green
  multi_team: true

load_balancer:
  enabled: true
  type: haproxy
  stats_port: 8404
  api_port: 8405

firewall:
  enabled: true
  allowed_ports:
{% for team in jenkins_teams %}
    - "{{ team.port }}/tcp"       # {{ team.name }} HTTP
    - "{{ team.agent_port }}/tcp" # {{ team.name }} Agent
{% endfor %}
    - "8404/tcp"  # HAProxy Stats
    - "8405/tcp"  # HAProxy API

teams:
{% for team in jenkins_teams %}
  - name: {{ team.name }}
    port: {{ team.port }}
    agent_port: {{ team.agent_port }}
    active_environment: {{ team.active_environment }}
    memory: {{ team.memory }}
    cpu_limit: {{ team.cpu_limit }}
    containers:
      blue:
        name: jenkins-{{ team.name }}-blue
        status: {{ 'active' if team.active_environment == 'blue' else 'standby' }}
      green:
        name: jenkins-{{ team.name }}-green
        status: {{ 'active' if team.active_environment == 'green' else 'standby' }}
{% endfor %}

dynamic_agents:
  enabled: true
  types:
    - name: dind-agent
      type: docker-in-docker
      labels: [dind, docker-manager, privileged]
      resources:
        memory: 2g
        cpu: 1.0
    - name: maven-agent
      type: java-maven
      labels: [maven, java-build]
      resources:
        memory: 4g
        cpu: 2.0
    - name: python-agent
      type: python
      labels: [python, python-build]
      resources:
        memory: 2g
        cpu: 1.0
    - name: nodejs-agent
      type: nodejs
      labels: [nodejs, frontend-build]
      resources:
        memory: 3g
        cpu: 1.5

blue_green:
  enabled: {{ jenkins_blue_green_enabled }}
  switch_enabled: {{ jenkins_blue_green_switch_enabled }}
  health_check_timeout: 30s
  rollback_timeout: 60s