# Jenkins Blue-Green Load Balancer Backend Configuration
# Auto-generated by Ansible Blue-Green Deployment
# Last updated: {{ ansible_date_time.iso8601 }}

backend jenkins_backend
    # Blue-Green deployment configuration
    balance roundrobin
    
    # Health check configuration
    option httpchk GET {{ jenkins_context_path | default('') }}/login
    http-check expect status 200
    
    # Connection and timeout settings
    timeout connect 5s
    timeout server 30s
    timeout check 10s
    
    # Retry and error handling
    retries 3
    option redispatch
    option httplog
    
    # Active environment server
    # Current active: {{ jenkins_active_environment | upper }}
    server {{ jenkins_active_environment }}-active {{ ansible_default_ipv4.address }}:{{ jenkins_active_port }} check weight 100 cookie {{ jenkins_active_environment }}
    
    # Standby environment server (backup)
    # Note: Standby server is configured but marked as backup
    # It will only receive traffic if active server fails
{% if jenkins_enable_standby_backend | default(false) | bool %}
    server {{ 'blue' if jenkins_active_environment == 'green' else 'green' }}-standby {{ ansible_default_ipv4.address }}:{{ jenkins_blue_port if jenkins_active_environment == 'green' else jenkins_green_port }} check weight 50 backup cookie {{ 'blue' if jenkins_active_environment == 'green' else 'green' }}
{% else %}
    # Standby backend disabled for true blue-green deployment
    # server {{ 'blue' if jenkins_active_environment == 'green' else 'green' }}-standby {{ ansible_default_ipv4.address }}:{{ jenkins_blue_port if jenkins_active_environment == 'green' else jenkins_green_port }} check weight 50 backup cookie {{ 'blue' if jenkins_active_environment == 'green' else 'green' }} disabled
{% endif %}

# Backend statistics and monitoring
backend jenkins_stats
    stats enable
    stats uri /jenkins-stats
    stats refresh 30s
    stats show-desc "Jenkins Blue-Green Deployment Statistics"
    stats show-legends
    
    # Stats access control
    stats auth {{ jenkins_stats_user | default('admin') }}:{{ jenkins_stats_password | default('changeme') }}
    stats admin if TRUE

# SSL backend (if SSL is enabled)
{% if jenkins_ssl_enabled | default(false) | bool %}
backend jenkins_ssl_backend
    balance roundrobin
    
    # SSL health check
    option httpchk GET {{ jenkins_context_path | default('') }}/login
    http-check expect status 200
    
    # SSL server configuration
    server {{ jenkins_active_environment }}-ssl {{ ansible_default_ipv4.address }}:{{ jenkins_ssl_port | default(8443) }} check ssl verify none weight 100
{% if jenkins_enable_standby_backend | default(false) | bool %}
    server {{ 'blue' if jenkins_active_environment == 'green' else 'green' }}-ssl-standby {{ ansible_default_ipv4.address }}:{{ jenkins_ssl_port | default(8443) }} check ssl verify none weight 50 backup
{% endif %}
{% endif %}

# Blue-Green deployment metadata (for monitoring and automation)
# Active Environment: {{ jenkins_active_environment }}
# Active Container: {{ jenkins_active_container }}
# Active Port: {{ jenkins_active_port }}
# Backend Configuration Updated: {{ ansible_date_time.iso8601 }}
# Deployment Mode: blue-green
# Auto-Rollback: {{ jenkins_auto_rollback_enabled | default(true) | lower }}
# Health Check Interval: {{ jenkins_health_check_timeout }}s