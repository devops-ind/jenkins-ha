<?xml version='1.1' encoding='UTF-8'?>
<flow-definition plugin="workflow-job@2.47">
  <actions>
    <org.jenkinsci.plugins.workflow.multibranch.JobPropertyTrackerAction plugin="workflow-multibranch@2.26">
      <jobPropertyTracker>
        <org.jenkinsci.plugins.workflow.job.properties.PipelineTriggersJobProperty>
          <triggers>
            <hudson.triggers.TimerTrigger>
              <spec>H 1 * * 0</spec>
            </hudson.triggers.TimerTrigger>
          </triggers>
        </org.jenkinsci.plugins.workflow.job.properties.PipelineTriggersJobProperty>
      </jobPropertyTracker>
    </org.jenkinsci.plugins.workflow.multibranch.JobPropertyTrackerAction>
  </actions>
  <description>Infrastructure Pipeline: Build and Push Jenkins Images to Harbor Registry

This pipeline builds all Jenkins infrastructure images including:
- Jenkins Master with pre-configured plugins and JCasC
- DIND Agent for Docker operations
- Maven Agent for Java builds
- Python Agent for Python builds  
- Node.js Agent for frontend builds

Images are pushed to Harbor registry: {{ harbor_registry_url }}/{{ harbor_project }}
</description>
  <keepDependencies>false</keepDependencies>
  <properties>
    <jenkins.model.BuildDiscarderProperty>
      <strategy class="hudson.tasks.LogRotator">
        <daysToKeep>30</daysToKeep>
        <numToKeep>20</numToKeep>
        <artifactDaysToKeep>-1</artifactDaysToKeep>
        <artifactNumToKeep>-1</artifactNumToKeep>
      </strategy>
    </jenkins.model.BuildDiscarderProperty>
    <org.jenkinsci.plugins.workflow.job.properties.PipelineTriggersJobProperty>
      <triggers>
        <hudson.triggers.TimerTrigger>
          <spec>H 1 * * 0</spec>
        </hudson.triggers.TimerTrigger>
      </triggers>
    </org.jenkinsci.plugins.workflow.job.properties.PipelineTriggersJobProperty>
    <hudson.model.ParametersDefinitionProperty>
      <parameterDefinitions>
        <hudson.model.BooleanParameterDefinition>
          <name>FORCE_REBUILD</name>
          <description>Force rebuild all images without cache</description>
          <defaultValue>false</defaultValue>
        </hudson.model.BooleanParameterDefinition>
        <hudson.model.BooleanParameterDefinition>
          <name>PUSH_TO_HARBOR</name>
          <description>Push built images to Harbor registry</description>
          <defaultValue>true</defaultValue>
        </hudson.model.BooleanParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>IMAGE_TAG</name>
          <description>Tag for built images (default: build number)</description>
          <defaultValue>${BUILD_NUMBER}</defaultValue>
          <trim>true</trim>
        </hudson.model.StringParameterDefinition>
        <hudson.model.ChoiceParameterDefinition>
          <name>IMAGES_TO_BUILD</name>
          <description>Select which images to build</description>
          <choices class="java.util.Arrays$ArrayList">
            <a class="string-array">
              <string>all</string>
              <string>master</string>
              <string>dind-agent</string>
              <string>maven-agent</string>
              <string>python-agent</string>
              <string>nodejs-agent</string>
            </a>
          </choices>
        </hudson.model.ChoiceParameterDefinition>
      </parameterDefinitions>
    </hudson.model.ParametersDefinitionProperty>
  </properties>
  <definition class="org.jenkinsci.plugins.workflow.cps.CpsFlowDefinition" plugin="workflow-cps@2.94">
    <script>#!/usr/bin/env groovy

pipeline {
    agent {
        label 'dind docker-manager static privileged'
    }
    
    options {
        buildDiscarder(logRotator(daysToKeepStr: '30', numToKeepStr: '20'))
        timeout(time: 2, unit: 'HOURS')
        timestamps()
        ansiColor('xterm')
    }
    
    environment {
        HARBOR_REGISTRY = '{{ harbor_registry_url }}'
        HARBOR_PROJECT = '{{ harbor_project }}'
        HARBOR_CREDENTIALS = credentials('harbor-registry')
        JENKINS_VERSION = '{{ jenkins_version }}'
        AGENT_VERSION = '{{ jenkins_agent_version }}'
        BUILD_DATE = sh(script: 'date -u +"%Y-%m-%dT%H:%M:%SZ"', returnStdout: true).trim()
        GIT_COMMIT = sh(script: 'git rev-parse HEAD', returnStdout: true).trim()
        IMAGE_TAG = "${params.IMAGE_TAG ?: env.BUILD_NUMBER}"
        DOCKER_BUILDKIT = '1'
        COMPOSE_DOCKER_CLI_BUILD = '1'
    }
    
    stages {
        stage('Preparation') {
            steps {
                script {
                    echo "üöÄ Jenkins Infrastructure Image Builder Pipeline"
                    echo "üì¶ Harbor Registry: ${HARBOR_REGISTRY}/${HARBOR_PROJECT}"
                    echo "üè∑Ô∏è Image Tag: ${IMAGE_TAG}"
                    echo "üî® Force Rebuild: ${params.FORCE_REBUILD}"
                    echo "üì§ Push to Harbor: ${params.PUSH_TO_HARBOR}"
                    echo "üéØ Images to Build: ${params.IMAGES_TO_BUILD}"
                    
                    // Login to Harbor registry
                    sh """
                        echo "üîê Logging into Harbor registry..."
                        echo \$HARBOR_CREDENTIALS_PSW | docker login \$HARBOR_REGISTRY -u \$HARBOR_CREDENTIALS_USR --password-stdin
                    """
                }
            }
        }
        
        stage('Checkout Infrastructure Repository') {
            steps {
                script {
                    echo "üì• Checking out infrastructure repository..."
                    checkout([
                        $class: 'GitSCM',
                        branches: [[name: '*/main']],
                        userRemoteConfigs: [[
                            url: '{{ jenkins_infrastructure_repo_url }}',
                            credentialsId: '{{ git_credentials_id }}'
                        ]]
                    ])
                }
            }
        }
        
        stage('Build Images with Ansible') {
            steps {
                script {
                    echo "üèóÔ∏è Building Jenkins Images using Ansible jenkins-images role..."
                    
                    // Prepare ansible variables for image building
                    def extraVars = [
                        "jenkins_master_image_tag=${IMAGE_TAG}",
                        "jenkins_agent_image_tag=${IMAGE_TAG}",
                        "jenkins_images_force_rebuild=${params.FORCE_REBUILD}",
                        "jenkins_images_push=${params.PUSH_TO_HARBOR}",
                        "harbor_registry_url=${HARBOR_REGISTRY}",
                        "harbor_project=${HARBOR_PROJECT}"
                    ]
                    
                    // Set GIT_COMMIT environment variable for Ansible
                    env.GIT_COMMIT = GIT_COMMIT
                    
                    // Create inventory for localhost execution
                    writeFile file: 'localhost_inventory', text: """
[localhost]
127.0.0.1 ansible_connection=local ansible_python_interpreter={{ ansible_playbook_python }}

[jenkins_masters]
127.0.0.1

[jenkins_agents]
127.0.0.1
"""
                    
                    // Create playbook to execute jenkins-images role
                    def playbookContent = """
---
- name: Build Jenkins Images
  hosts: localhost
  connection: local
  become: false
  gather_facts: yes
  vars:
    jenkins_master_image_tag: "${IMAGE_TAG}"
    jenkins_agent_image_tag: "${IMAGE_TAG}"
    jenkins_images_force_rebuild: ${params.FORCE_REBUILD}
    jenkins_images_push: ${params.PUSH_TO_HARBOR}
    harbor_registry_url: "${HARBOR_REGISTRY}"
    harbor_project: "${HARBOR_PROJECT}"
  roles:
    - role: jenkins-images
      when: >
        params.IMAGES_TO_BUILD == 'all' or
        params.IMAGES_TO_BUILD == 'master' or
        params.IMAGES_TO_BUILD == 'dind-agent' or
        params.IMAGES_TO_BUILD == 'maven-agent' or
        params.IMAGES_TO_BUILD == 'python-agent' or
        params.IMAGES_TO_BUILD == 'nodejs-agent'
"""
                    
                    writeFile file: 'build-images.yml', text: playbookContent
                    
                    // Execute ansible playbook
                    sh """
                        echo "üöÄ Executing Ansible playbook to build images..."
                        ansible-playbook -i localhost_inventory \
                            build-images.yml \
                            --extra-vars '${extraVars.join(' ')}' \
                            --extra-vars "images_to_build=${params.IMAGES_TO_BUILD}" \
                            -v
                    """
                }
            }
        }
        
        stage('Security Scanning') {
            when {
                expression { params.PUSH_TO_HARBOR }
            }
            steps {
                script {
                    echo "üîç Images will be automatically scanned by Harbor registry..."
                    echo "üìä Built images for: ${params.IMAGES_TO_BUILD}"
                    echo "üè∑Ô∏è Image tag: ${IMAGE_TAG}"
                    echo "üì§ Check Harbor UI at ${HARBOR_REGISTRY} for vulnerability reports"
                }
            }
        }
        
        stage('Update Deployment Manifests') {
            when {
                expression { params.PUSH_TO_HARBOR }
            }
            steps {
                script {
                    echo "üìù Updating deployment manifests with new image tags..."
                    
                    // Update image tags in Ansible variables
                    sh """
                        # Update image tags in group_vars
                        sed -i 's/jenkins_master_image_tag:.*/jenkins_master_image_tag: "${IMAGE_TAG}"/' ansible/group_vars/all/jenkins.yml
                        sed -i 's/jenkins_agent_image_tag:.*/jenkins_agent_image_tag: "${IMAGE_TAG}"/' ansible/group_vars/all/jenkins.yml
                        
                        # Commit changes if in a git repository
                        if git rev-parse --git-dir > /dev/null 2>&1; then
                            git add ansible/group_vars/all/jenkins.yml
                            git commit -m "Update Jenkins image tags to ${IMAGE_TAG}" || echo "No changes to commit"
                        fi
                    """
                }
            }
        }
        
        stage('Trigger Infrastructure Update') {
            when {
                allOf {
                    expression { params.PUSH_TO_HARBOR }
                    equals expected: 'all', actual: params.IMAGES_TO_BUILD
                }
            }
            steps {
                script {
                    echo "üîÑ Triggering infrastructure update with new images..."
                    
                    // Trigger the infrastructure update job
                    build job: 'Infrastructure/Infrastructure-Update',
                          parameters: [
                              string(name: 'IMAGE_TAG', value: "${IMAGE_TAG}"),
                              booleanParam(name: 'RESTART_SERVICES', value: true),
                              string(name: 'UPDATE_REASON', value: "New images built: ${IMAGE_TAG}")
                          ],
                          wait: false
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo "üìä Build Summary:"
                echo "Images Built: ${params.IMAGES_TO_BUILD}"
                echo "Image Tag: ${IMAGE_TAG}"
                echo "Force Rebuild: ${params.FORCE_REBUILD}"
                echo "Pushed to Harbor: ${params.PUSH_TO_HARBOR}"
                
                // Archive build artifacts
                archiveArtifacts artifacts: '**/Dockerfile*', allowEmptyArchive: true
                
                // Clean workspace
                cleanWs()
            }
        }
        
        success {
            script {
                echo "‚úÖ Jenkins Images Build Pipeline Completed Successfully!"
                
                // Send notification if configured
                if (env.SLACK_WEBHOOK) {
                    slackSend(
                        channel: '#infrastructure',
                        color: 'good',
                        message: """
                            ‚úÖ Jenkins Images Build Successful
                            
                            üì¶ Images: ${params.IMAGES_TO_BUILD}
                            üè∑Ô∏è Tag: ${IMAGE_TAG}
                            üì§ Registry: ${HARBOR_REGISTRY}/${HARBOR_PROJECT}
                            ‚è±Ô∏è Duration: ${currentBuild.durationString}
                            
                            üîó Build: ${env.BUILD_URL}
                        """.stripIndent()
                    )
                }
            }
        }
        
        failure {
            script {
                echo "‚ùå Jenkins Images Build Pipeline Failed!"
                
                // Send failure notification
                if (env.SLACK_WEBHOOK) {
                    slackSend(
                        channel: '#infrastructure',
                        color: 'danger',
                        message: """
                            ‚ùå Jenkins Images Build Failed
                            
                            üì¶ Images: ${params.IMAGES_TO_BUILD}
                            üè∑Ô∏è Tag: ${IMAGE_TAG}
                            ‚è±Ô∏è Duration: ${currentBuild.durationString}
                            
                            üîó Build: ${env.BUILD_URL}
                            üìã Please check logs for details
                        """.stripIndent()
                    )
                }
            }
        }
        
        unstable {
            script {
                echo "‚ö†Ô∏è Jenkins Images Build Pipeline Unstable!"
            }
        }
    }
}
    </script>
    <sandbox>true</sandbox>
  </definition>
  <triggers/>
  <disabled>false</disabled>
</flow-definition>
                    