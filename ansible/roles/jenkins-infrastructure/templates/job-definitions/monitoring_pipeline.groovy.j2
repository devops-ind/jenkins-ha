<?xml version='1.1' encoding='UTF-8'?>
<flow-definition plugin="workflow-job@2.47">
  <actions/>
  <description>Infrastructure Pipeline: Monitoring Stack Management

This pipeline manages the monitoring infrastructure including:
- Prometheus configuration updates
- Grafana dashboard deployment
- Alertmanager rule management
- Monitoring stack health verification
- Performance metrics collection
- Custom dashboard creation and updates

Used for maintaining and updating the monitoring infrastructure.
</description>
  <keepDependencies>false</keepDependencies>
  <properties>
    <jenkins.model.BuildDiscarderProperty>
      <strategy class="hudson.tasks.LogRotator">
        <daysToKeep>30</daysToKeep>
        <numToKeep>20</numToKeep>
        <artifactDaysToKeep>-1</artifactDaysToKeep>
        <artifactNumToKeep>-1</artifactNumToKeep>
      </strategy>
    </jenkins.model.BuildDiscarderProperty>
    <hudson.model.ParametersDefinitionProperty>
      <parameterDefinitions>
        <hudson.model.ChoiceParameterDefinition>
          <n>ACTION</n>
          <description>Monitoring action to perform</description>
          <choices class="java.util.Arrays$ArrayList">
            <a class="string-array">
              <string>deploy</string>
              <string>update-config</string>
              <string>update-dashboards</string>
              <string>update-alerts</string>
              <string>health-check</string>
              <string>restart-services</string>
            </a>
          </choices>
        </hudson.model.ChoiceParameterDefinition>
        <hudson.model.BooleanParameterDefinition>
          <n>UPDATE_PROMETHEUS</n>
          <description>Update Prometheus configuration</description>
          <defaultValue>true</defaultValue>
        </hudson.model.BooleanParameterDefinition>
        <hudson.model.BooleanParameterDefinition>
          <n>UPDATE_GRAFANA</n>
          <description>Update Grafana dashboards and datasources</description>
          <defaultValue>true</defaultValue>
        </hudson.model.BooleanParameterDefinition>
        <hudson.model.BooleanParameterDefinition>
          <n>UPDATE_ALERTMANAGER</n>
          <description>Update Alertmanager configuration</description>
          <defaultValue>false</defaultValue>
        </hudson.model.BooleanParameterDefinition>
        <hudson.model.BooleanParameterDefinition>
          <n>RESTART_SERVICES</n>
          <description>Restart monitoring services after updates</description>
          <defaultValue>false</defaultValue>
        </hudson.model.BooleanParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <n>CUSTOM_DASHBOARD</n>
          <description>Deploy specific dashboard (JSON file name)</description>
          <defaultValue></defaultValue>
          <trim>true</trim>
        </hudson.model.StringParameterDefinition>
      </parameterDefinitions>
    </hudson.model.ParametersDefinitionProperty>
  </properties>
  <definition class="org.jenkinsci.plugins.workflow.cps.CpsFlowDefinition" plugin="workflow-cps@2.94">
    <script>#!/usr/bin/env groovy

pipeline {
    agent {
        label 'dind docker-manager static privileged'
    }
    
    options {
        buildDiscarder(logRotator(daysToKeepStr: '30', numToKeepStr: '20'))
        timeout(time: 1, unit: 'HOURS')
        timestamps()
        ansiColor('xterm')
        skipDefaultCheckout()
    }
    
    environment {
        ANSIBLE_HOST_KEY_CHECKING = 'False'
        ANSIBLE_STDOUT_CALLBACK = 'yaml'
        MONITORING_HOST = '{{ hostvars[groups["monitoring"][0]]["ansible_default_ipv4"]["address"] | default("localhost") }}'
        PROMETHEUS_URL = "http://${MONITORING_HOST}:9090"
        GRAFANA_URL = "http://${MONITORING_HOST}:3000"
        GRAFANA_CREDENTIALS = credentials('grafana-admin')
        TIMESTAMP = sh(script: 'date +%Y%m%d_%H%M%S', returnStdout: true).trim()
        HOSTNAME = sh(script: 'hostname', returnStdout: true).trim()
    }
    
    stages {
        stage('Initialize Monitoring Pipeline') {
            steps {
                script {
                    echo "ðŸ“Š Jenkins Monitoring Stack Management"
                    echo "ðŸŽ¯ Action: ${params.ACTION}"
                    echo "â° Timestamp: ${TIMESTAMP}"
                    echo "ðŸ–¥ï¸ Hostname: ${HOSTNAME}"
                    echo "ðŸ“Š Monitoring Host: ${MONITORING_HOST}"
                    echo "ðŸ“ˆ Prometheus: ${params.UPDATE_PROMETHEUS}"
                    echo "ðŸ“Š Grafana: ${params.UPDATE_GRAFANA}"
                    echo "ðŸš¨ Alertmanager: ${params.UPDATE_ALERTMANAGER}"
                    
                    currentBuild.description = "Monitoring ${params.ACTION} - ${TIMESTAMP}"
                }
            }
        }
        
        stage('Checkout Infrastructure Repository') {
            steps {
                script {
                    echo "ðŸ“¥ Checking out infrastructure repository..."
                    checkout([
                        $class: 'GitSCM',
                        branches: [[name: '*/main']],
                        userRemoteConfigs: [[
                            url: '{{ jenkins_infrastructure_repo_url }}',
                            credentialsId: '{{ git_credentials_id }}'
                        ]]
                    ])
                }
            }
        }
        
        stage('Monitoring Stack Health Check') {
            when {
                anyOf {
                    equals expected: 'health-check', actual: params.ACTION
                    equals expected: 'deploy', actual: params.ACTION
                }
            }
            steps {
                script {
                    echo "ðŸ¥ Checking monitoring stack health..."
                    
                    sh """
                        echo "=== Monitoring Health Check ==="
                        
                        # Check Prometheus
                        echo "ðŸ” Checking Prometheus..."
                        if curl -f -s --connect-timeout 10 ${PROMETHEUS_URL}/api/v1/query?query=up > /dev/null; then
                            echo "âœ… Prometheus: ACCESSIBLE"
                            
                            # Get Prometheus targets status
                            TARGETS_UP=\$(curl -s ${PROMETHEUS_URL}/api/v1/query?query=up | jq '.data.result | map(select(.value[1] == "1")) | length' 2>/dev/null || echo 0)
                            TARGETS_DOWN=\$(curl -s ${PROMETHEUS_URL}/api/v1/query?query=up | jq '.data.result | map(select(.value[1] == "0")) | length' 2>/dev/null || echo 0)
                            
                            echo "ðŸ“ˆ Targets UP: \${TARGETS_UP}"
                            echo "ðŸ“‰ Targets DOWN: \${TARGETS_DOWN}"
                            
                            if [ "\${TARGETS_DOWN}" -gt "0" ]; then
                                echo "âš ï¸ Some monitoring targets are down"
                            fi
                        else
                            echo "âŒ Prometheus: NOT ACCESSIBLE"
                            exit 1
                        fi
                        
                        # Check Grafana
                        echo "ðŸ” Checking Grafana..."
                        if curl -f -s --connect-timeout 10 ${GRAFANA_URL}/api/health > /dev/null; then
                            echo "âœ… Grafana: ACCESSIBLE"
                            
                            # Get Grafana info
                            GRAFANA_VERSION=\$(curl -s ${GRAFANA_URL}/api/health | jq -r '.version' 2>/dev/null || echo "unknown")
                            echo "ðŸ“Š Grafana version: \${GRAFANA_VERSION}"
                        else
                            echo "âŒ Grafana: NOT ACCESSIBLE"
                            exit 1
                        fi
                        
                        # Check Alertmanager (if enabled)
                        if curl -f -s --connect-timeout 5 http://${MONITORING_HOST}:9093/api/v1/status > /dev/null; then
                            echo "âœ… Alertmanager: ACCESSIBLE"
                        else
                            echo "â„¹ï¸ Alertmanager: NOT ACCESSIBLE (may be disabled)"
                        fi
                        
                        echo "âœ… Monitoring stack health check completed"
                    """
                }
            }
        }
        
        stage('Execute Monitoring Operations with Ansible') {
            steps {
                script {
                    echo "ðŸ“Š Executing monitoring operations using Ansible monitoring role..."
                    
                    // Create monitoring inventory
                    writeFile file: 'monitoring_inventory', text: """
[monitoring]
{% for host in groups['monitoring'] %}
{{ host }} ansible_host={{ hostvars[host]['ansible_host'] }}
{% endfor %}

[jenkins_masters]
{% for host in groups['jenkins_masters'] %}
{{ host }} ansible_host={{ hostvars[host]['ansible_host'] }}
{% endfor %}

[jenkins_agents]
{% for host in groups['jenkins_agents'] %}
{{ host }} ansible_host={{ hostvars[host]['ansible_host'] }}
{% endfor %}
"""
                    
                    // Create comprehensive monitoring playbook
                    def playbookContent = """
---
- name: Execute Monitoring Stack Operations
  hosts: monitoring
  become: yes
  gather_facts: yes
  vars:
    monitoring_action: "${params.ACTION}"
    prometheus_update: ${params.UPDATE_PROMETHEUS}
    grafana_update: ${params.UPDATE_GRAFANA}
    alertmanager_update: ${params.UPDATE_ALERTMANAGER}
    restart_services: ${params.RESTART_SERVICES}
    custom_dashboard: "${params.CUSTOM_DASHBOARD}"
    monitoring_timestamp: "${TIMESTAMP}"
  pre_tasks:
    - name: Validate monitoring action
      assert:
        that:
          - monitoring_action in ['deploy', 'update-config', 'update-dashboards', 'update-alerts', 'health-check', 'restart-services']
        fail_msg: "Invalid monitoring action: {{ monitoring_action }}"
        
  roles:
    - role: monitoring
      when: monitoring_action in ['deploy', 'update-config', 'update-dashboards', 'update-alerts', 'restart-services']
      vars:
        monitoring_operation_mode: "{{ monitoring_action }}"
        monitoring_force_restart: "{{ restart_services }}"
        monitoring_update_prometheus: "{{ prometheus_update }}"
        monitoring_update_grafana: "{{ grafana_update }}"
        monitoring_update_alertmanager: "{{ alertmanager_update }}"
        
  post_tasks:
    - name: Wait for Prometheus to be ready
      uri:
        url: "http://{{ ansible_default_ipv4.address }}:{{ prometheus_port }}/api/v1/status/config"
        method: GET
        timeout: 10
      register: prometheus_ready
      until: prometheus_ready is succeeded
      retries: 30
      delay: 10
      when: prometheus_update | bool or monitoring_action == 'deploy'
      
    - name: Wait for Grafana to be ready
      uri:
        url: "http://{{ ansible_default_ipv4.address }}:{{ grafana_port }}/api/health"
        method: GET
        timeout: 10
      register: grafana_ready
      until: grafana_ready is succeeded
      retries: 30
      delay: 10
      when: grafana_update | bool or monitoring_action == 'deploy'
      
    - name: Import custom dashboard if specified
      uri:
        url: "http://{{ ansible_default_ipv4.address }}:{{ grafana_port }}/api/dashboards/db"
        method: POST
        user: "{{ grafana_admin_user }}"
        password: "{{ grafana_admin_password }}"
        force_basic_auth: yes
        body_format: json
        body: "{{ lookup('file', monitoring_home_dir + '/grafana/dashboards/' + custom_dashboard) | from_json }}"
        status_code: [200, 412]
      when: 
        - custom_dashboard | length > 0
        - grafana_update | bool or monitoring_action in ['deploy', 'update-dashboards']
        
    - name: Reload Prometheus configuration
      uri:
        url: "http://{{ ansible_default_ipv4.address }}:{{ prometheus_port }}/-/reload"
        method: POST
        timeout: 30
      when: 
        - prometheus_update | bool or monitoring_action in ['update-config', 'update-alerts']
        - restart_services | bool
      ignore_errors: yes
      
    - name: Display monitoring access information
      debug:
        msg: |
          ðŸ“Š Monitoring Operation Completed: {{ monitoring_action }}
          
          ðŸ”— Access URLs:
          Prometheus: http://{{ ansible_default_ipv4.address }}:{{ prometheus_port }}
          Grafana: http://{{ ansible_default_ipv4.address }}:{{ grafana_port }}
          AlertManager: http://{{ ansible_default_ipv4.address }}:{{ alertmanager_port }}
          
          âš™ï¸ Operation Details:
          Prometheus Updated: {{ prometheus_update }}
          Grafana Updated: {{ grafana_update }}
          AlertManager Updated: {{ alertmanager_update }}
          Services Restarted: {{ restart_services }}
          Custom Dashboard: {{ custom_dashboard if custom_dashboard else 'None' }}
"""
                    
                    writeFile file: 'execute-monitoring.yml', text: playbookContent
                    
                    // Execute ansible playbook
                    sh """
                        echo "ðŸš€ Executing Ansible monitoring operations..."
                        
                        # Set vault password if exists
                        export ANSIBLE_VAULT_PASSWORD_FILE=\${PWD}/environments/vault-passwords/production.txt
                        
                        ansible-playbook -i monitoring_inventory \
                            execute-monitoring.yml \
                            --extra-vars "monitoring_operation='${params.ACTION}'" \
                            --extra-vars "monitoring_timestamp='${TIMESTAMP}'" \
                            --extra-vars "monitoring_update_reason='Pipeline execution'" \
                            -v
                    """
                }
            }
        }
        
        stage('Post-Update Verification') {
            steps {
                script {
                    echo "âœ… Verifying monitoring stack after updates..."
                    
                    sh """
                        echo "=== Post-Update Verification ==="
                        
                        # Wait for services to be ready
                        echo "â³ Waiting for services to be ready..."
                        sleep 30
                        
                        # Verify Prometheus
                        echo "ðŸ” Verifying Prometheus..."
                        for i in {1..12}; do
                            if curl -f -s --connect-timeout 5 ${PROMETHEUS_URL}/api/v1/query?query=up > /dev/null; then
                                echo "âœ… Prometheus is responsive"
                                break
                            else
                                echo "â³ Waiting for Prometheus... (\$i/12)"
                                sleep 10
                            fi
                        done
                        
                        # Check Prometheus targets
                        TARGETS_DATA=\$(curl -s ${PROMETHEUS_URL}/api/v1/targets 2>/dev/null || echo '{"data":{"activeTargets":[]}}')
                        ACTIVE_TARGETS=\$(echo "\$TARGETS_DATA" | jq '.data.activeTargets | length' 2>/dev/null || echo 0)
                        HEALTHY_TARGETS=\$(echo "\$TARGETS_DATA" | jq '.data.activeTargets | map(select(.health == "up")) | length' 2>/dev/null || echo 0)
                        
                        echo "ðŸ“Š Active targets: \${ACTIVE_TARGETS}"
                        echo "âœ… Healthy targets: \${HEALTHY_TARGETS}"
                        
                        # Verify Grafana
                        echo "ðŸ” Verifying Grafana..."
                        for i in {1..12}; do
                            if curl -f -s --connect-timeout 5 ${GRAFANA_URL}/api/health > /dev/null; then
                                echo "âœ… Grafana is responsive"
                                break
                            else
                                echo "â³ Waiting for Grafana... (\$i/12)"
                                sleep 10
                            fi
                        done
                        
                        # Check Grafana dashboards
                        DASHBOARDS=\$(curl -s -u \${GRAFANA_CREDENTIALS_USR}:\${GRAFANA_CREDENTIALS_PSW} \
                                     ${GRAFANA_URL}/api/search?type=dash-db 2>/dev/null | jq 'length' 2>/dev/null || echo 0)
                        echo "ðŸ“Š Grafana dashboards: \${DASHBOARDS}"
                        
                        # Check data sources
                        DATASOURCES=\$(curl -s -u \${GRAFANA_CREDENTIALS_USR}:\${GRAFANA_CREDENTIALS_PSW} \
                                      ${GRAFANA_URL}/api/datasources 2>/dev/null | jq 'length' 2>/dev/null || echo 0)
                        echo "ðŸ”— Grafana datasources: \${DATASOURCES}"
                        
                        # Test Prometheus datasource
                        echo "ðŸ” Testing Prometheus datasource..."
                        DATASOURCE_TEST=\$(curl -s -u \${GRAFANA_CREDENTIALS_USR}:\${GRAFANA_CREDENTIALS_PSW} \
                                          ${GRAFANA_URL}/api/datasources/proxy/1/api/v1/query?query=up | \
                                          jq '.status' 2>/dev/null || echo '"error"')
                        
                        if [ "\$DATASOURCE_TEST" = '"success"' ]; then
                            echo "âœ… Prometheus datasource is working"
                        else
                            echo "âš ï¸ Prometheus datasource test failed"
                        fi
                        
                        echo "âœ… Post-update verification completed"
                    """
                }
            }
        }
        
        stage('Generate Monitoring Report') {
            steps {
                script {
                    echo "ðŸ“‹ Generating monitoring status report..."
                    
                    sh """
                        # Create monitoring report
                        cat > monitoring-report-${TIMESTAMP}.md << EOF
# Monitoring Stack Report

**Date**: \$(date)
**Action**: ${params.ACTION}
**Build**: ${env.BUILD_NUMBER}

## Configuration Updates
- Prometheus: ${params.UPDATE_PROMETHEUS}
- Grafana: ${params.UPDATE_GRAFANA}
- Alertmanager: ${params.UPDATE_ALERTMANAGER}
- Services Restarted: ${params.RESTART_SERVICES}

## Service Status
EOF
                        
                        # Add Prometheus status
                        if curl -f -s --connect-timeout 5 ${PROMETHEUS_URL}/api/v1/query?query=up > /dev/null; then
                            echo "- Prometheus: âœ… Running" >> monitoring-report-${TIMESTAMP}.md
                            
                            TARGETS_UP=\$(curl -s ${PROMETHEUS_URL}/api/v1/query?query=up | jq '.data.result | map(select(.value[1] == "1")) | length' 2>/dev/null || echo 0)
                            TARGETS_DOWN=\$(curl -s ${PROMETHEUS_URL}/api/v1/query?query=up | jq '.data.result | map(select(.value[1] == "0")) | length' 2>/dev/null || echo 0)
                            
                            echo "  - Targets UP: \${TARGETS_UP}" >> monitoring-report-${TIMESTAMP}.md
                            echo "  - Targets DOWN: \${TARGETS_DOWN}" >> monitoring-report-${TIMESTAMP}.md
                        else
                            echo "- Prometheus: âŒ Not accessible" >> monitoring-report-${TIMESTAMP}.md
                        fi
                        
                        # Add Grafana status
                        if curl -f -s --connect-timeout 5 ${GRAFANA_URL}/api/health > /dev/null; then
                            echo "- Grafana: âœ… Running" >> monitoring-report-${TIMESTAMP}.md
                            
                            DASHBOARDS=\$(curl -s -u \${GRAFANA_CREDENTIALS_USR}:\${GRAFANA_CREDENTIALS_PSW} \
                                         ${GRAFANA_URL}/api/search?type=dash-db 2>/dev/null | jq 'length' 2>/dev/null || echo 0)
                            echo "  - Dashboards: \${DASHBOARDS}" >> monitoring-report-${TIMESTAMP}.md
                        else
                            echo "- Grafana: âŒ Not accessible" >> monitoring-report-${TIMESTAMP}.md
                        fi
                        
                        # Add access information
                        cat >> monitoring-report-${TIMESTAMP}.md << EOF

## Access Information
- Prometheus: ${PROMETHEUS_URL}
- Grafana: ${GRAFANA_URL}
- Monitoring Host: ${MONITORING_HOST}

## Next Actions
- Monitor system performance for 24 hours
- Verify alert notifications are working
- Review dashboard functionality
- Update documentation if needed

EOF
                        
                        echo "ðŸ“‹ Monitoring report generated"
                        cat monitoring-report-${TIMESTAMP}.md
                    """
                    
                    // Archive the report
                    archiveArtifacts artifacts: "monitoring-report-${TIMESTAMP}.md", fingerprint: true
                }
            }
        }
    }
    
    post {
        always {
            script {
                // Clean workspace
                cleanWs()
            }
        }
        
        success {
            script {
                echo "âœ… Monitoring Pipeline Completed Successfully!"
                
                def monitoringStatus = """
                    âœ… Monitoring ${params.ACTION}: SUCCESS
                    
                    ðŸ“Š Action: ${params.ACTION}
                    ðŸ–¥ï¸ Host: ${MONITORING_HOST}
                    â° Time: ${TIMESTAMP}
                    â±ï¸ Duration: ${currentBuild.durationString}
                    
                    ðŸ“ˆ Prometheus: ${PROMETHEUS_URL}
                    ðŸ“Š Grafana: ${GRAFANA_URL}
                    
                    ðŸ”— Build: ${env.BUILD_URL}
                """.stripIndent()
                
                if (env.SLACK_WEBHOOK) {
                    slackSend(
                        channel: '#infrastructure',
                        color: 'good',
                        message: monitoringStatus
                    )
                }
                
                echo monitoringStatus
            }
        }
        
        failure {
            script {
                echo "âŒ Monitoring Pipeline Failed!"
                
                def failureMessage = """
                    âŒ Monitoring ${params.ACTION}: FAILED
                    
                    ðŸ“Š Action: ${params.ACTION}
                    ðŸ–¥ï¸ Host: ${MONITORING_HOST}
                    â° Time: ${TIMESTAMP}
                    â±ï¸ Duration: ${currentBuild.durationString}
                    
                    ðŸ”— Build: ${env.BUILD_URL}
                    ðŸ“‹ Please check logs and verify services
                """.stripIndent()
                
                if (env.SLACK_WEBHOOK) {
                    slackSend(
                        channel: '#infrastructure',
                        color: 'danger',
                        message: failureMessage
                    )
                }
            }
        }
    }
}
    </script>
    <sandbox>true</sandbox>
  </definition>
  <triggers/>
  <disabled>false</disabled>
</flow-definition>