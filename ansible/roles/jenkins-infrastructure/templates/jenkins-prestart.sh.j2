#!/bin/bash

# Jenkins Pre-start Script
# Generated by Ansible

set -e

echo "ğŸš€ Jenkins pre-start checks..."

# Check Docker connectivity
if ! docker info > /dev/null 2>&1; then
    echo "âŒ Docker is not accessible"
    exit 1
fi

# Check Jenkins home directory
if [ ! -d "{{ jenkins_home_dir }}" ]; then
    echo "âŒ Jenkins home directory not found: {{ jenkins_home_dir }}"
    exit 1
fi

# Check Docker network
if ! docker network inspect {{ jenkins_network_name }} > /dev/null 2>&1; then
    echo "ğŸ“ Creating Jenkins network..."
    docker network create --driver bridge --subnet {{ jenkins_network_subnet }} {{ jenkins_network_name }}
fi

# Check volumes
for volume in jenkins_data shared_workspace maven-cache pip-cache; do
    if ! docker volume inspect $volume > /dev/null 2>&1; then
        echo "ğŸ“¦ Creating volume: $volume"
        docker volume create $volume
    fi
done

# Check if container already exists and remove if stopped
if docker ps -a --format "{{.Names}}" | grep -q "^jenkins-master-{{ ansible_hostname }}$"; then
    CONTAINER_STATUS=$(docker inspect jenkins-master-{{ ansible_hostname }} --format='{{.State.Status}}' 2>/dev/null || echo "not_found")
    
    if [ "$CONTAINER_STATUS" = "exited" ]; then
        echo "ğŸ—‘ï¸ Removing stopped container..."
        docker rm jenkins-master-{{ ansible_hostname }}
    elif [ "$CONTAINER_STATUS" = "running" ]; then
        echo "âœ… Container already running"
        exit 0
    fi
fi

echo "âœ… Pre-start checks completed"