#!/bin/bash

# Jenkins Blue-Green Multi-Team Health Check Script
# Generated by Ansible

set -e

HEALTH_LOG="{{ jenkins_home_dir }}/logs/health-check.log"
CONTAINER_RUNTIME="{{ jenkins_container_runtime }}"

# Function to log messages
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$HEALTH_LOG"
}

# Check team environment health
check_team_health() {
    local team="$1"
    local port="$2" 
    local active_env="$3"
    local container_name="jenkins-${team}-${active_env}"
    
    log_message "🔍 Checking team: $team (${active_env} environment)"
    
    # Check container status
    local container_status
    if [ "$CONTAINER_RUNTIME" = "docker" ]; then
        container_status=$(docker inspect "$container_name" --format='{{ '{{.State.Status}}' }}' 2>/dev/null || echo "not_found")
    else
        container_status=$(podman inspect "$container_name" --format='{{ '{{.State.Status}}' }}' 2>/dev/null || echo "not_found")
    fi
    
    if [ "$container_status" != "running" ]; then
        log_message "❌ $team container ($container_name): $container_status"
        return 1
    fi
    
    # Check web interface
    if curl -s -f --max-time 10 "http://localhost:${port}/login" > /dev/null; then
        log_message "✅ $team web interface: OK"
    else
        log_message "❌ $team web interface: FAILED"
        return 1
    fi
    
    # Check API
    if curl -s -f --max-time 10 "http://localhost:${port}/api/json" > /dev/null; then
        log_message "✅ $team API: OK"
    else
        log_message "❌ $team API: FAILED"
        return 1
    fi
    
    log_message "✅ Team $team: HEALTHY"
    return 0
}

# Main health check
main() {
    mkdir -p "$(dirname "$HEALTH_LOG")"
    log_message "🏥 Starting Jenkins Blue-Green Multi-Team health check..."
    
    local overall_status=0
    
    # Check each team
{% for team in jenkins_teams %}
    if ! check_team_health "{{ team.name }}" "{{ team.port }}" "{{ team.active_environment }}"; then
        overall_status=1
    fi
{% endfor %}
    
    if [ $overall_status -eq 0 ]; then
        log_message "✅ All Jenkins teams: HEALTHY"
    else
        log_message "❌ Some Jenkins teams: FAILED"
    fi
    
    return $overall_status
}

main "$@"