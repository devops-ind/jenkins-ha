#!/bin/bash

# Jenkins Health Check Script
# Generated by Ansible

set -e

JENKINS_URL="http://localhost:{{ jenkins_master_port }}"
HEALTH_LOG="/var/log/jenkins-health.log"

# Function to log messages
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$HEALTH_LOG"
}

# Check Jenkins web interface
check_web_interface() {
    if curl -s -f --max-time 10 "$JENKINS_URL/login" > /dev/null; then
        log_message "✅ Jenkins web interface: OK"
        return 0
    else
        log_message "❌ Jenkins web interface: FAILED"
        return 1
    fi
}

# Check Jenkins API
check_api() {
    if curl -s -f --max-time 10 "$JENKINS_URL/api/json" > /dev/null; then
        log_message "✅ Jenkins API: OK"
        return 0
    else
        log_message "❌ Jenkins API: FAILED"
        return 1
    fi
}

# Check container status
check_container() {
    local container_status
    container_status=$(docker inspect jenkins-master-{{ ansible_hostname }} --format='{{.State.Status}}' 2>/dev/null || echo "not_found")
    
    if [ "$container_status" = "running" ]; then
        log_message "✅ Jenkins container: RUNNING"
        return 0
    else
        log_message "❌ Jenkins container: $container_status"
        return 1
    fi
}

# Main health check
main() {
    log_message "🏥 Starting Jenkins health check..."
    
    local exit_code=0
    
    check_container || exit_code=1
    check_web_interface || exit_code=1
    check_api || exit_code=1
    
    if [ $exit_code -eq 0 ]; then
        log_message "✅ Jenkins health check: PASSED"
    else
        log_message "❌ Jenkins health check: FAILED"
    fi
    
    return $exit_code
}

main "$@"