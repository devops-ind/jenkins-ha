#!/bin/bash

# Download Jenkins CLI JAR
# Generated by Ansible

set -e

JENKINS_URL="http://localhost:{{ jenkins_master_port }}"
CLI_JAR="{{ jenkins_home_dir }}/jenkins-cli.jar"

echo "üì• Downloading Jenkins CLI JAR..."

# Wait for Jenkins to be ready
timeout=300
counter=0

while [ $counter -lt $timeout ]; do
    if curl -s -f $JENKINS_URL/login > /dev/null; then
        echo "‚úÖ Jenkins is ready"
        break
    fi
    
    echo "‚è≥ Waiting for Jenkins... ($counter/$timeout)"
    sleep 5
    counter=$((counter + 5))
done

if [ $counter -ge $timeout ]; then
    echo "‚ùå Jenkins is not ready after $timeout seconds"
    exit 1
fi

# Download CLI JAR
curl -s -o "$CLI_JAR" "$JENKINS_URL/jnlpJars/jenkins-cli.jar"

if [ -f "$CLI_JAR" ]; then
    echo "‚úÖ Jenkins CLI JAR downloaded successfully"
    chmod +x "$CLI_JAR"
else
    echo "‚ùå Failed to download Jenkins CLI JAR"
    exit 1
fi