/*
 * Seed Job DSL for Team: {{ jenkins_current_team.team_name }}
 * Environment: {{ jenkins_current_environment }}
 * This script creates the initial job structure and pipelines for the team
 */

// Team-specific job creation
def teamName = '{{ jenkins_current_team.team_name }}'
def teamDisplayName = '{{ jenkins_current_team.team_name | title }}'

// Create team folder structure
folder(teamDisplayName) {
    displayName("${teamDisplayName} Team")
    description("Jobs and pipelines for the ${teamName} team")
}

// Infrastructure folder
folder("${teamDisplayName}/Infrastructure") {
    displayName('Infrastructure')
    description("Infrastructure and deployment jobs for ${teamName}")
}

// Applications folder  
folder("${teamDisplayName}/Applications") {
    displayName('Applications')
    description("Application build and test jobs for ${teamName}")
}

// Monitoring folder
folder("${teamDisplayName}/Monitoring") {
    displayName('Monitoring')
    description("Monitoring and health check jobs for ${teamName}")
}

{% if jenkins_current_team.seed_jobs is defined and jenkins_current_team.seed_jobs | length > 0 %}
// Team-specific seed jobs
{% for seed_job in jenkins_current_team.seed_jobs %}
{% if seed_job.type == 'pipeline' %}
pipelineJob("${teamDisplayName}/{{ seed_job.folder | default('Applications') }}/{{ seed_job.name }}") {
    displayName('{{ seed_job.display_name | default(seed_job.name) }}')
    description('{{ seed_job.description | default("Auto-generated pipeline for " + seed_job.name) }}')
    
    {% if seed_job.git_url is defined %}
    definition {
        cpsScm {
            scm {
                git {
                    remote {
                        url('{{ seed_job.git_url }}')
                        {% if seed_job.credentials_id is defined %}
                        credentials('{{ seed_job.credentials_id }}')
                        {% endif %}
                    }
                    branch('{{ seed_job.branch | default("main") }}')
                }
            }
            scriptPath('{{ seed_job.jenkinsfile_path | default("Jenkinsfile") }}')
        }
    }
    {% else %}
    definition {
        cps {
            script('''
                pipeline {
                    agent { 
                        label '{{ jenkins_current_team.team_name }}-maven maven-{{ jenkins_current_team.team_name }}' 
                        // For containerized builds, use: '{{ jenkins_current_team.team_name }}-dind docker-{{ jenkins_current_team.team_name }}'
                        // For Python builds, use: '{{ jenkins_current_team.team_name }}-python python-{{ jenkins_current_team.team_name }}'
                        // For Node.js builds, use: '{{ jenkins_current_team.team_name }}-nodejs nodejs-{{ jenkins_current_team.team_name }}'
                    }
                    
                    stages {
                        stage('Checkout') {
                            steps {
                                echo 'Checking out source code...'
                                // Add your SCM checkout here
                            }
                        }
                        
                        stage('Build') {
                            steps {
                                echo 'Building application...'
                                // Add your build steps here
                            }
                        }
                        
                        stage('Test') {
                            steps {
                                echo 'Running tests...'
                                // Add your test steps here
                            }
                        }
                        
                        {% if seed_job.deploy_enabled | default(false) %}
                        stage('Deploy') {
                            steps {
                                echo 'Deploying application...'
                                // Add your deployment steps here
                            }
                        }
                        {% endif %}
                    }
                    
                    post {
                        always {
                            echo 'Pipeline completed'
                        }
                        success {
                            echo 'Pipeline succeeded'
                        }
                        failure {
                            echo 'Pipeline failed'
                        }
                    }
                }
            ''')
            sandbox()
        }
    }
    {% endif %}
    
    {% if seed_job.triggers is defined %}
    triggers {
        {% for trigger in seed_job.triggers %}
        {% if trigger.type == 'cron' %}
        cron('{{ trigger.schedule }}')
        {% elif trigger.type == 'scm' %}
        scm('{{ trigger.schedule | default("H/5 * * * *") }}')
        {% elif trigger.type == 'github' %}
        githubPush()
        {% endif %}
        {% endfor %}
    }
    {% endif %}
    
    properties {
        buildDiscarder {
            strategy {
                logRotator {
                    numToKeepStr('{{ seed_job.builds_to_keep | default("10") }}')
                    daysToKeepStr('{{ seed_job.days_to_keep | default("30") }}')
                }
            }
        }
        
        {% if seed_job.parameters is defined %}
        parameters {
            {% for param in seed_job.parameters %}
            {% if param.type == 'string' %}
            stringParam('{{ param.name }}', '{{ param.default | default("") }}', '{{ param.description | default("") }}')
            {% elif param.type == 'boolean' %}
            booleanParam('{{ param.name }}', {{ param.default | default(false) | lower }}, '{{ param.description | default("") }}')
            {% elif param.type == 'choice' %}
            choiceParam('{{ param.name }}', {{ param.choices | to_json }}, '{{ param.description | default("") }}')
            {% endif %}
            {% endfor %}
        }
        {% endif %}
    }
}

{% elif seed_job.type == 'freestyle' %}
freeStyleJob("${teamDisplayName}/{{ seed_job.folder | default('Applications') }}/{{ seed_job.name }}") {
    displayName('{{ seed_job.display_name | default(seed_job.name) }}')
    description('{{ seed_job.description | default("Auto-generated freestyle job for " + seed_job.name) }}')
    
    label('{{ jenkins_current_team.team_name }}-{{ seed_job.agent_label | default("maven") }} {{ seed_job.agent_label | default("maven") }}-{{ jenkins_current_team.team_name }}')
    
    {% if seed_job.git_url is defined %}
    scm {
        git {
            remote {
                url('{{ seed_job.git_url }}')
                {% if seed_job.credentials_id is defined %}
                credentials('{{ seed_job.credentials_id }}')
                {% endif %}
            }
            branch('{{ seed_job.branch | default("main") }}')
        }
    }
    {% endif %}
    
    steps {
        {% for step in seed_job.build_steps | default([]) %}
        {% if step.type == 'shell' %}
        shell('{{ step.command }}')
        {% elif step.type == 'maven' %}
        maven {
            goals('{{ step.goals | default("clean compile test") }}')
            mavenInstallation('Maven-3.9')
        }
        {% endif %}
        {% endfor %}
    }
    
    properties {
        buildDiscarder {
            strategy {
                logRotator {
                    numToKeepStr('{{ seed_job.builds_to_keep | default("10") }}')
                    daysToKeepStr('{{ seed_job.days_to_keep | default("30") }}')
                }
            }
        }
    }
}
{% endif %}

{% endfor %}
{% endif %}

// Team health check job
pipelineJob("${teamDisplayName}/Monitoring/team-health-check") {
    displayName('Team Health Check')
    description("Health monitoring for ${teamName} team infrastructure")
    
    definition {
        cpsScm {
            scm {
                git {
                    remote {
                        url('{{ jenkins_infrastructure_git_repo | default("https://github.com/your-org/jenkins-ha.git") }}')
                    }
                    branch('{{ jenkins_infrastructure_git_branch | default("main") }}')
                }
            }
            scriptPath('pipelines/Jenkinsfile.health-check')
        }
    }
    
    triggers {
        cron('H/15 * * * *')  // Every 15 minutes
    }
    
    properties {
        buildDiscarder {
            strategy {
                logRotator {
                    numToKeepStr('20')
                    daysToKeepStr('7')
                }
            }
        }
        parameters {
            stringParam('TEAM_NAME', '{{ jenkins_current_team.team_name }}', 'Team name for health check')
            stringParam('ENVIRONMENT', '{{ jenkins_current_team.active_environment }}', 'Environment to check')
        }
    }
}

// Blue-Green deployment support job
pipelineJob("${teamDisplayName}/Infrastructure/blue-green-switch") {
    displayName('Blue-Green Environment Switch')
    description("Switch between blue and green environments for ${teamName}")
    
    definition {
        cps {
            script('''
                pipeline {
                    agent { label '{{ jenkins_current_team.team_name }}-maven maven-{{ jenkins_current_team.team_name }}' }
                    
                    parameters {
                        choice(
                            name: 'TARGET_ENVIRONMENT',
                            choices: ['blue', 'green'],
                            description: 'Target environment to switch to'
                        )
                        booleanParam(
                            name: 'CONFIRM_SWITCH',
                            defaultValue: false,
                            description: 'Confirm the environment switch'
                        )
                    }
                    
                    stages {
                        stage('Validate Switch') {
                            steps {
                                script {
                                    if (!params.CONFIRM_SWITCH) {
                                        error('Environment switch not confirmed')
                                    }
                                    
                                    echo "Switching {{ jenkins_current_team.team_name }} to ${params.TARGET_ENVIRONMENT} environment"
                                    echo "Current environment: {{ jenkins_current_team.active_environment }}"
                                }
                            }
                        }
                        
                        stage('Pre-Switch Health Check') {
                            steps {
                                echo "Checking ${params.TARGET_ENVIRONMENT} environment health..."
                                sh '''
                                    # Run the actual blue-green health check script
                                    if [ -f "{{ jenkins_home_dir }}/{{ jenkins_current_team.team_name }}/scripts/blue-green-healthcheck.sh" ]; then
                                        bash {{ jenkins_home_dir }}/{{ jenkins_current_team.team_name }}/scripts/blue-green-healthcheck.sh ${TARGET_ENVIRONMENT}
                                    else
                                        echo "Health check script not found, skipping..."
                                    fi
                                '''
                            }
                        }
                        
                        stage('Switch Environment') {
                            steps {
                                echo "Performing environment switch to ${params.TARGET_ENVIRONMENT}..."
                                sh '''
                                    # Call the actual blue-green switch script
                                    if [ -f "{{ jenkins_home_dir }}/{{ jenkins_current_team.team_name }}/scripts/blue-green-switch.sh" ]; then
                                        bash {{ jenkins_home_dir }}/{{ jenkins_current_team.team_name }}/scripts/blue-green-switch.sh ${TARGET_ENVIRONMENT}
                                    else
                                        echo "ERROR: Blue-green switch script not found!"
                                        exit 1
                                    fi
                                '''
                            }
                        }
                        
                        stage('Post-Switch Verification') {
                            steps {
                                echo "Verifying ${params.TARGET_ENVIRONMENT} environment is active..."
                                sh '''
                                    # Verify the switch was successful
                                    sleep 30  # Allow time for containers to stabilize
                                    
                                    # Check if the target environment is responding
                                    {% raw %}
                                    if [ "${TARGET_ENVIRONMENT}" = "green" ]; then
                                        CHECK_PORT=$(({{ jenkins_current_team.ports.web }} + 100))
                                    else
                                        CHECK_PORT={{ jenkins_current_team.ports.web }}
                                    fi
                                    {% endraw %}
                                    
                                    if curl -f -s "http://localhost:${CHECK_PORT}/login" > /dev/null; then
                                        echo "SUCCESS: ${TARGET_ENVIRONMENT} environment is responding on port ${CHECK_PORT}"
                                    else
                                        echo "ERROR: ${TARGET_ENVIRONMENT} environment is not responding on port ${CHECK_PORT}"
                                        exit 1
                                    fi
                                '''
                            }
                        }
                    }
                    
                    post {
                        success {
                            echo "Successfully switched {{ jenkins_current_team.team_name }} to ${params.TARGET_ENVIRONMENT}"
                        }
                        failure {
                            echo "Failed to switch {{ jenkins_current_team.team_name }} to ${params.TARGET_ENVIRONMENT}"
                        }
                    }
                }
            ''')
            sandbox()
        }
    }
    
    properties {
        buildDiscarder {
            strategy {
                logRotator {
                    numToKeepStr('10')
                    daysToKeepStr('30')
                }
            }
        }
    }
}

// Infrastructure Pipeline Jobs
pipelineJob("${teamDisplayName}/Infrastructure/backup") {
    displayName('Backup Operations')
    description("Automated backup operations for ${teamName} team")
    
    definition {
        cpsScm {
            scm {
                git {
                    remote {
                        url('{{ jenkins_infrastructure_git_repo | default("https://github.com/your-org/jenkins-ha.git") }}')
                    }
                    branch('{{ jenkins_infrastructure_git_branch | default("main") }}')
                }
            }
            scriptPath('pipelines/Jenkinsfile.backup')
        }
    }
    
    triggers {
        cron('H 2 * * *')  // Daily at 2 AM
    }
    
    properties {
        buildDiscarder {
            strategy {
                logRotator {
                    numToKeepStr('10')
                    daysToKeepStr('30')
                }
            }
        }
        parameters {
            stringParam('TEAM_NAME', '{{ jenkins_current_team.team_name }}', 'Team name for backup operations')
            choiceParam('BACKUP_TYPE', ['incremental', 'full'], 'Type of backup to perform')
        }
    }
}

pipelineJob("${teamDisplayName}/Infrastructure/monitoring-setup") {
    displayName('Monitoring Setup')
    description("Setup and configure monitoring for ${teamName} team")
    
    definition {
        cpsScm {
            scm {
                git {
                    remote {
                        url('{{ jenkins_infrastructure_git_repo | default("https://github.com/your-org/jenkins-ha.git") }}')
                    }
                    branch('{{ jenkins_infrastructure_git_branch | default("main") }}')
                }
            }
            scriptPath('pipelines/Jenkinsfile.monitoring')
        }
    }
    
    properties {
        buildDiscarder {
            strategy {
                logRotator {
                    numToKeepStr('5')
                    daysToKeepStr('30')
                }
            }
        }
        parameters {
            stringParam('TEAM_NAME', '{{ jenkins_current_team.team_name }}', 'Team name for monitoring setup')
            booleanParam('ENABLE_ALERTS', true, 'Enable alerting for this team')
        }
    }
}

pipelineJob("${teamDisplayName}/Infrastructure/security-scan") {
    displayName('Security Scan')
    description("Security scanning for ${teamName} team infrastructure")
    
    definition {
        cpsScm {
            scm {
                git {
                    remote {
                        url('{{ jenkins_infrastructure_git_repo | default("https://github.com/your-org/jenkins-ha.git") }}')
                    }
                    branch('{{ jenkins_infrastructure_git_branch | default("main") }}')
                }
            }
            scriptPath('pipelines/Jenkinsfile.security-scan')
        }
    }
    
    triggers {
        cron('H 1 * * 1')  // Weekly on Monday at 1 AM
    }
    
    properties {
        buildDiscarder {
            strategy {
                logRotator {
                    numToKeepStr('20')
                    daysToKeepStr('60')
                }
            }
        }
        parameters {
            stringParam('TEAM_NAME', '{{ jenkins_current_team.team_name }}', 'Team name for security scan')
            choiceParam('SCAN_TYPE', ['container', 'infrastructure', 'both'], 'Type of security scan')
        }
    }
}

pipelineJob("${teamDisplayName}/Infrastructure/disaster-recovery-test") {
    displayName('Disaster Recovery Test')
    description("Test disaster recovery procedures for ${teamName} team")
    
    definition {
        cpsScm {
            scm {
                git {
                    remote {
                        url('{{ jenkins_infrastructure_git_repo | default("https://github.com/your-org/jenkins-ha.git") }}')
                    }
                    branch('{{ jenkins_infrastructure_git_branch | default("main") }}')
                }
            }
            scriptPath('pipelines/Jenkinsfile.disaster-recovery')
        }
    }
    
    properties {
        buildDiscarder {
            strategy {
                logRotator {
                    numToKeepStr('5')
                    daysToKeepStr('90')
                }
            }
        }
        parameters {
            stringParam('TEAM_NAME', '{{ jenkins_current_team.team_name }}', 'Team name for DR test')
            booleanParam('DRY_RUN', true, 'Perform dry run only')
        }
    }
}