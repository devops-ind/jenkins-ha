#!/bin/bash
# Blue-Green Data Synchronization Script
# Implements selective data sharing between blue and green Jenkins environments
#
# SHARED DATA (bidirectional sync):
#   - jobs/ - Job configurations
#   - builds/ - Build history and artifacts
#   - workspace/ - Build workspaces (with retention policy)
#
# ISOLATED DATA (not synced):
#   - plugins/ - Plugin isolation for safe upgrades
#   - logs/ - Environment-specific logs
#   - .cache/ - Environment-specific cache
#
# Usage: blue-green-sync.sh <team_name> <source_env> <target_env> [--dry-run]

set -euo pipefail

# Configuration
TEAM_NAME="${1:-}"
SOURCE_ENV="${2:-blue}"
TARGET_ENV="${3:-green}"
DRY_RUN="${4:-}"

# Paths
{% if shared_storage_type | default('local') == 'glusterfs' %}
DATA_BASE_PATH="{{ glusterfs_mount_base_path | default('/var/jenkins') }}/${TEAM_NAME}/data"
{% else %}
DATA_BASE_PATH="{{ shared_storage_path | default('/opt/jenkins-shared') }}/${TEAM_NAME}"
{% endif %}

SOURCE_DATA="${DATA_BASE_PATH}/${SOURCE_ENV}"
TARGET_DATA="${DATA_BASE_PATH}/${TARGET_ENV}"

LOG_FILE="/var/log/jenkins-bluegreen-sync-${TEAM_NAME}.log"

# Workspace retention (only sync recent workspaces)
WORKSPACE_RETENTION_DAYS="{{ jenkins_workspace_retention_days | default(10) }}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging function
log_message() {
    local level="$1"
    shift
    local message="$*"
    echo "$(date '+%Y-%m-%d %H:%M:%S') [$level] $message" | tee -a "$LOG_FILE"
}

# Usage information
usage() {
    cat <<EOF
Blue-Green Data Synchronization Script

Usage:
    $(basename "$0") <team_name> <source_env> <target_env> [--dry-run]

Arguments:
    team_name   - Jenkins team name (e.g., devops, ma, ba, tw)
    source_env  - Source environment (blue or green)
    target_env  - Target environment (green or blue)
    --dry-run   - Show what would be synced without actually syncing

Data Sync Strategy:
    SHARED (bidirectional sync):
      - jobs/       Job configurations
      - builds/     Build history and artifacts
      - workspace/  Build workspaces (retention: ${WORKSPACE_RETENTION_DAYS} days)

    ISOLATED (never synced):
      - plugins/    Plugin isolation for safe upgrades
      - logs/       Environment-specific logs
      - .cache/     Environment-specific cache

Examples:
    # Sync from blue to green (dry-run)
    $(basename "$0") devops blue green --dry-run

    # Sync from green to blue (actual sync)
    $(basename "$0") ma green blue

EOF
    exit 1
}

# Validate inputs
if [ -z "$TEAM_NAME" ]; then
    echo -e "${RED}Error: Team name is required${NC}"
    usage
fi

if [[ ! "$SOURCE_ENV" =~ ^(blue|green)$ ]] || [[ ! "$TARGET_ENV" =~ ^(blue|green)$ ]]; then
    echo -e "${RED}Error: Environments must be 'blue' or 'green'${NC}"
    usage
fi

if [ "$SOURCE_ENV" == "$TARGET_ENV" ]; then
    echo -e "${RED}Error: Source and target environments must be different${NC}"
    usage
fi

# Validate source path exists
if [ ! -d "$SOURCE_DATA" ]; then
    log_message "ERROR" "Source data path does not exist: $SOURCE_DATA"
    echo -e "${RED}Error: Source data path not found: $SOURCE_DATA${NC}"
    exit 1
fi

# Create target directory if it doesn't exist
if [ ! -d "$TARGET_DATA" ]; then
    log_message "INFO" "Creating target data directory: $TARGET_DATA"
    mkdir -p "$TARGET_DATA"
fi

# Start sync
log_message "INFO" "=========================================="
log_message "INFO" "Blue-Green Data Sync Started"
log_message "INFO" "=========================================="
log_message "INFO" "Team: $TEAM_NAME"
log_message "INFO" "Source: $SOURCE_ENV ($SOURCE_DATA)"
log_message "INFO" "Target: $TARGET_ENV ($TARGET_DATA)"
log_message "INFO" "Workspace retention: $WORKSPACE_RETENTION_DAYS days"
if [ "$DRY_RUN" == "--dry-run" ]; then
    log_message "INFO" "Mode: DRY-RUN (no actual sync)"
else
    log_message "INFO" "Mode: LIVE (actual sync)"
fi
log_message "INFO" "=========================================="

# Rsync options
RSYNC_OPTS="-avz --delete"
if [ "$DRY_RUN" == "--dry-run" ]; then
    RSYNC_OPTS="$RSYNC_OPTS --dry-run"
fi

echo -e "${BLUE}=========================================${NC}"
echo -e "${BLUE}Blue-Green Data Synchronization${NC}"
echo -e "${BLUE}=========================================${NC}"
echo -e "Team: $TEAM_NAME"
echo -e "Direction: $SOURCE_ENV â†’ $TARGET_ENV"
if [ "$DRY_RUN" == "--dry-run" ]; then
    echo -e "Mode: ${YELLOW}DRY-RUN${NC}"
else
    echo -e "Mode: ${GREEN}LIVE SYNC${NC}"
fi
echo -e "${BLUE}=========================================${NC}"
echo ""

# Sync shared data directories
SYNC_DIRS=("jobs" "builds" "workspace")
SYNC_SUCCESS=0
SYNC_FAILED=0

for dir in "${SYNC_DIRS[@]}"; do
    SOURCE_DIR="${SOURCE_DATA}/${dir}"
    TARGET_DIR="${TARGET_DATA}/${dir}"

    echo -e "${YELLOW}Syncing: ${dir}/${NC}"

    if [ ! -d "$SOURCE_DIR" ]; then
        log_message "WARNING" "Source directory not found: $SOURCE_DIR - skipping"
        echo -e "  ${YELLOW}Source not found - skipping${NC}"
        continue
    fi

    # Create target directory if needed
    if [ ! -d "$TARGET_DIR" ] && [ "$DRY_RUN" != "--dry-run" ]; then
        mkdir -p "$TARGET_DIR"
        log_message "INFO" "Created target directory: $TARGET_DIR"
    fi

    # Special handling for workspace - only sync recent workspaces
    if [ "$dir" == "workspace" ]; then
        log_message "INFO" "Syncing workspace with ${WORKSPACE_RETENTION_DAYS} day retention"

        # Find recent workspaces
        RECENT_WORKSPACES=$(find "$SOURCE_DIR" -mindepth 1 -maxdepth 1 -type d -mtime -${WORKSPACE_RETENTION_DAYS} 2>/dev/null || echo "")

        if [ -z "$RECENT_WORKSPACES" ]; then
            log_message "INFO" "No recent workspaces found (last ${WORKSPACE_RETENTION_DAYS} days)"
            echo -e "  ${YELLOW}No recent workspaces to sync${NC}"
            continue
        fi

        # Sync each recent workspace individually
        WORKSPACE_COUNT=$(echo "$RECENT_WORKSPACES" | wc -l)
        echo -e "  ${GREEN}Found $WORKSPACE_COUNT recent workspaces${NC}"

        echo "$RECENT_WORKSPACES" | while read -r workspace; do
            WORKSPACE_NAME=$(basename "$workspace")
            if rsync $RSYNC_OPTS "$workspace/" "$TARGET_DIR/$WORKSPACE_NAME/" >> "$LOG_FILE" 2>&1; then
                log_message "INFO" "Synced workspace: $WORKSPACE_NAME"
            else
                log_message "ERROR" "Failed to sync workspace: $WORKSPACE_NAME"
            fi
        done
    else
        # Standard rsync for jobs and builds
        if rsync $RSYNC_OPTS "${SOURCE_DIR}/" "${TARGET_DIR}/" >> "$LOG_FILE" 2>&1; then
            log_message "INFO" "Successfully synced: $dir"
            echo -e "  ${GREEN}Sync successful${NC}"
            SYNC_SUCCESS=$((SYNC_SUCCESS + 1))
        else
            log_message "ERROR" "Failed to sync: $dir"
            echo -e "  ${RED}Sync failed${NC}"
            SYNC_FAILED=$((SYNC_FAILED + 1))
        fi
    fi
done

# Display isolation notice
echo ""
echo -e "${BLUE}=========================================${NC}"
echo -e "${BLUE}Isolated Data (Not Synced)${NC}"
echo -e "${BLUE}=========================================${NC}"
echo -e "${GREEN}The following directories are intentionally NOT synced:${NC}"
echo -e "  - plugins/   ${YELLOW}(Plugin isolation for safe upgrades)${NC}"
echo -e "  - logs/      ${YELLOW}(Environment-specific logs)${NC}"
echo -e "  - .cache/    ${YELLOW}(Environment-specific cache)${NC}"
echo ""

# Summary
echo -e "${BLUE}=========================================${NC}"
if [ "$DRY_RUN" == "--dry-run" ]; then
    echo -e "${YELLOW}Sync Dry-Run Complete${NC}"
else
    echo -e "${GREEN}Sync Complete${NC}"
fi
echo -e "${BLUE}=========================================${NC}"
echo -e "Successful syncs: $SYNC_SUCCESS"
echo -e "Failed syncs: $SYNC_FAILED"

if [ "$DRY_RUN" == "--dry-run" ]; then
    echo -e "${YELLOW}Run without --dry-run to perform actual sync${NC}"
fi
echo -e "${BLUE}=========================================${NC}"

log_message "INFO" "Sync completed: $SYNC_SUCCESS successful, $SYNC_FAILED failed"
log_message "INFO" "=========================================="

# Exit with appropriate code
if [ "$SYNC_FAILED" -gt 0 ]; then
    exit 1
else
    exit 0
fi
