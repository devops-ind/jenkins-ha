#!/bin/bash
# Initial Jenkins Data Sync Script for {{ item.team_name }}
# Supports syncing from shared storage or from another blue/green environment
# Generated by Ansible jenkins-master-v2 role

set -euo pipefail

# Set variables to avoid Jinja2 conflicts
CONTAINER_NAME="jenkins-{{ item.team_name }}-{{ item.active_environment | default('blue') }}"
STORAGE_PATH="{{ storage_path }}"
TEAM_NAME="{{ item.team_name }}"
ACTIVE_ENV="{{ item.active_environment | default('blue') }}"

# Blue-green sync configuration
SOURCE_ENV=""
SYNC_FROM_ENVIRONMENT=""

# Usage function
usage() {
    cat << EOF
Usage: $0 [OPTIONS]

Initial Jenkins Data Sync Script for ${TEAM_NAME}

OPTIONS:
    --sync-from {blue|green}     Copy data from specified environment to current environment
    --help                       Show this help message

MODES:
    Default: Initialize from shared storage
    --sync-from: Initialize current environment from specified blue/green environment

EXAMPLES:
    $0                          # Initialize ${ACTIVE_ENV} from shared storage
    $0 --sync-from blue         # Initialize ${ACTIVE_ENV} from blue environment data
    $0 --sync-from green        # Initialize ${ACTIVE_ENV} from green environment data

EOF
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --sync-from)
            SOURCE_ENV="$2"
            SYNC_FROM_ENVIRONMENT="true"
            shift 2
            ;;
        --help)
            usage
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            usage
            exit 1
            ;;
    esac
done

# Validate source environment if specified
if [[ -n "$SOURCE_ENV" ]]; then
    if [[ "$SOURCE_ENV" != "blue" && "$SOURCE_ENV" != "green" ]]; then
        echo "‚ùå Invalid source environment: $SOURCE_ENV. Must be 'blue' or 'green'"
        exit 1
    fi
    
    if [[ "$SOURCE_ENV" == "$ACTIVE_ENV" ]]; then
        echo "‚ö†Ô∏è Source environment ($SOURCE_ENV) is same as target environment ($ACTIVE_ENV). Nothing to sync."
        exit 0
    fi
    
    echo "=== Initial Blue-Green Data Sync for ${TEAM_NAME}: ${SOURCE_ENV} ‚Üí ${ACTIVE_ENV} ==="
else
    echo "=== Initial Shared Storage Data Sync for ${TEAM_NAME} (${ACTIVE_ENV}) ==="
fi

# Function to sync from blue-green volume
sync_from_environment() {
    local source_volume="jenkins-${TEAM_NAME}-${SOURCE_ENV}-home"
    local target_volume="jenkins-${TEAM_NAME}-${ACTIVE_ENV}-home"
    local temp_container="init-sync-temp-${TEAM_NAME}-$$"
    
    # Check if source volume exists
    if ! docker volume inspect "${source_volume}" >/dev/null 2>&1; then
        echo "‚ùå Source volume ${source_volume} does not exist"
        return 1
    fi
    
    # Check if target volume exists  
    if ! docker volume inspect "${target_volume}" >/dev/null 2>&1; then
        echo "‚ùå Target volume ${target_volume} does not exist"
        return 1
    fi
    
    echo "üîÑ Syncing from ${source_volume} to ${target_volume}"
    
    # Create temporary container with both volumes mounted
    docker run --rm -d \
        --name "${temp_container}" \
        -v "${source_volume}:/source" \
        -v "${target_volume}:/target" \
        alpine:latest sleep 300 || {
        echo "‚ùå Failed to create temporary sync container"
        return 1
    }
    
    echo "üì¶ Syncing data types..."
    local sync_success=0
    local sync_total=5
    
    # Sync shared data types from source to target volume
    for data_type in jobs workspace builds userContent secrets; do
        echo "  üìÑ Syncing ${data_type}..."
        
        if docker exec "${temp_container}" test -d "/source/${data_type}"; then
            # Create target directory and sync data
            docker exec "${temp_container}" mkdir -p "/target/${data_type}" && \
            docker exec "${temp_container}" sh -c "
                cd /source/${data_type} && 
                find . -type f -exec cp -p {} /target/${data_type}/{} \\; 2>/dev/null || true &&
                find . -type d -exec mkdir -p /target/${data_type}/{} \\; 2>/dev/null || true
            " && {
                echo "  ‚úÖ ${data_type} sync completed"
                ((sync_success++))
            } || {
                echo "  ‚ùå ${data_type} sync failed"
            }
        else
            echo "  ‚ö†Ô∏è ${data_type} directory not found in source volume, skipping"
            ((sync_success++))  # Count as success since it's expected to be missing
        fi
    done
    
    # Clean up temporary container
    docker stop "${temp_container}" >/dev/null 2>&1
    
    if [[ $sync_success -eq $sync_total ]]; then
        echo "üéâ Blue-green data sync completed for ${TEAM_NAME} (${sync_success}/${sync_total})"
        return 0
    else
        echo "‚ö†Ô∏è Partial blue-green data sync completed for ${TEAM_NAME} (${sync_success}/${sync_total})"
        return 1
    fi
}

# Main sync logic
if [[ -n "$SOURCE_ENV" ]]; then
    # Blue-green volume sync mode
    if sync_from_environment; then
        exit 0
    else
        exit 1
    fi
else
    # Default: shared storage sync mode
    if docker ps --filter "name=${CONTAINER_NAME}" | grep -q "${CONTAINER_NAME}"; then
      echo "‚úÖ Container ${CONTAINER_NAME} is running"
      echo "üîÑ Syncing ${TEAM_NAME} ${ACTIVE_ENV} environment data to {{ storage_type }} storage"
      
      # Create team directories in storage if they don't exist
      echo "üìÅ Creating storage directories..."
      mkdir -p "${STORAGE_PATH}/${TEAM_NAME}"/{jobs,workspace,builds,userContent,secrets}
      
      # Sync shared data types from container to storage
      echo "üì¶ Syncing data types..."
      for data_type in jobs workspace builds userContent secrets; do
        if docker exec "${CONTAINER_NAME}" test -d "/var/jenkins_home/${data_type}"; then
          echo "  üìÑ Syncing ${data_type}..."
          docker cp "${CONTAINER_NAME}:/var/jenkins_home/${data_type}/." "${STORAGE_PATH}/${TEAM_NAME}/${data_type}/"
          chown -R {{ jenkins_user }}:{{ jenkins_group }} "${STORAGE_PATH}/${TEAM_NAME}/${data_type}"
          echo "  ‚úÖ ${data_type} sync completed"
        else
          echo "  ‚ö†Ô∏è ${data_type} directory not found in container, skipping"
        fi
      done
      echo "üéâ Data sync completed for ${TEAM_NAME}"
      exit 0
    else
      echo "‚ö†Ô∏è Container ${CONTAINER_NAME} not running, skipping sync"
      exit 1
    fi
fi