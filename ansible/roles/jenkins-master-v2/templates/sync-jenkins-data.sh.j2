#!/bin/bash
# Jenkins Data Synchronization Script for {{ item.team_name }}
# Syncs data between active Jenkins container and shared storage
# Also supports blue-green volume synchronization
# Generated by Ansible jenkins-master-v2 role

set -euo pipefail

# Default configuration
TEAM_NAME="{{ item.team_name }}"
ACTIVE_ENV="{{ item.active_environment | default('blue') }}"
CONTAINER_NAME="jenkins-${TEAM_NAME}-${ACTIVE_ENV}"
STORAGE_PATH="{{ storage_path }}"
STORAGE_TYPE="{{ storage_type }}"
TEAM_STORAGE_PATH="${STORAGE_PATH}/${TEAM_NAME}"
SYNC_METHOD="{{ sync_method | default('rsync') }}"
LOG_FILE="/var/log/jenkins-${TEAM_NAME}-sync.log"

# Blue-green sync configuration
TARGET_ENV=""
SYNC_MODE="to-shared"  # Default: sync to shared storage
SOURCE_VOLUME=""
TARGET_VOLUME=""

# Logging function
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOG_FILE"
}

# Usage function
usage() {
    cat << EOF
Usage: $0 [OPTIONS]

Jenkins Data Synchronization Script for ${TEAM_NAME}

OPTIONS:
    --target {blue|green}    Sync FROM active environment TO target environment
    --help                   Show this help message

MODES:
    Default: Sync active container data to shared storage
    --target: Sync active environment data to target blue/green environment

EXAMPLES:
    $0                      # Sync active container to shared storage
    $0 --target green       # Sync active (${ACTIVE_ENV}) data to green volume
    $0 --target blue        # Sync active (${ACTIVE_ENV}) data to blue volume

EOF
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --target)
            TARGET_ENV="$2"
            SYNC_MODE="blue-green"
            shift 2
            ;;
        --help)
            usage
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            usage
            exit 1
            ;;
    esac
done

# Validate target environment for blue-green sync
if [[ "$SYNC_MODE" == "blue-green" ]]; then
    if [[ "$TARGET_ENV" != "blue" && "$TARGET_ENV" != "green" ]]; then
        log "‚ùå Invalid target environment: $TARGET_ENV. Must be 'blue' or 'green'"
        exit 1
    fi
    
    if [[ "$TARGET_ENV" == "$ACTIVE_ENV" ]]; then
        log "‚ö†Ô∏è Target environment ($TARGET_ENV) is same as active environment ($ACTIVE_ENV). Nothing to sync."
        exit 0
    fi
    
    SOURCE_VOLUME="jenkins-${TEAM_NAME}-${ACTIVE_ENV}-home"
    TARGET_VOLUME="jenkins-${TEAM_NAME}-${TARGET_ENV}-home"
    
    log "üîÑ Blue-green sync mode: ${ACTIVE_ENV} ‚Üí ${TARGET_ENV}"
fi

# Validation based on sync mode
if [[ "$SYNC_MODE" == "to-shared" ]]; then
    # Check if container is running for shared storage sync
    if ! docker ps --filter "name=${CONTAINER_NAME}" | grep -q "${CONTAINER_NAME}"; then
        log "‚ö†Ô∏è Container ${CONTAINER_NAME} not running, skipping sync"
        exit 0
    fi

    # Check if storage is accessible
    if [[ ! -d "$STORAGE_PATH" ]] || [[ ! -w "$STORAGE_PATH" ]]; then
        log "‚ùå Storage not accessible at $STORAGE_PATH"
        exit 1
    fi

    log "üîÑ Starting data synchronization for ${TEAM_NAME} (${ACTIVE_ENV}) using ${STORAGE_TYPE} storage"
    # Ensure team directories exist in storage
    mkdir -p "${TEAM_STORAGE_PATH}"/{jobs,workspace,builds,userContent,secrets}
    
elif [[ "$SYNC_MODE" == "blue-green" ]]; then
    # Check if source volume exists
    if ! docker volume inspect "${SOURCE_VOLUME}" >/dev/null 2>&1; then
        log "‚ùå Source volume ${SOURCE_VOLUME} does not exist"
        exit 1
    fi
    
    # Check if target volume exists
    if ! docker volume inspect "${TARGET_VOLUME}" >/dev/null 2>&1; then
        log "‚ùå Target volume ${TARGET_VOLUME} does not exist"
        exit 1
    fi
    
    log "üîÑ Starting blue-green volume synchronization: ${SOURCE_VOLUME} ‚Üí ${TARGET_VOLUME}"
fi

# Data types to sync (exclude plugins, logs, war for environment isolation)
DATA_TYPES=("jobs" "workspace" "builds" "userContent" "secrets")

# Blue-green volume sync function
sync_blue_green_data() {
    local data_type=$1
    local temp_container="sync-temp-${TEAM_NAME}-${data_type}-$$"
    
    log "üìÅ Syncing ${data_type} from ${SOURCE_VOLUME} to ${TARGET_VOLUME}..."
    
    # Create temporary container with both volumes mounted
    docker run --rm -d \
        --name "${temp_container}" \
        -v "${SOURCE_VOLUME}:/source" \
        -v "${TARGET_VOLUME}:/target" \
        alpine:latest sleep 300 || {
        log "‚ùå Failed to create temporary sync container"
        return 1
    }
    
    # Check if source data type exists
    if ! docker exec "${temp_container}" test -d "/source/${data_type}"; then
        log "‚ö†Ô∏è Source ${data_type} does not exist in ${SOURCE_VOLUME}, skipping"
        docker stop "${temp_container}" >/dev/null 2>&1
        return 0
    fi
    
    # Create target directory if it doesn't exist
    docker exec "${temp_container}" mkdir -p "/target/${data_type}" || {
        log "‚ùå Failed to create target directory for ${data_type}"
        docker stop "${temp_container}" >/dev/null 2>&1
        return 1
    }
    
    # Sync the data (preserving permissions and ownership)
    docker exec "${temp_container}" sh -c "
        cd /source/${data_type} && 
        find . -type f -exec cp -p {} /target/${data_type}/{} \\; 2>/dev/null || true &&
        find . -type d -exec mkdir -p /target/${data_type}/{} \\; 2>/dev/null || true
    " || {
        log "‚ùå Failed to sync ${data_type} data"
        docker stop "${temp_container}" >/dev/null 2>&1
        return 1
    }
    
    # Clean up temporary container
    docker stop "${temp_container}" >/dev/null 2>&1
    
    log "‚úÖ Successfully synced ${data_type}"
    return 0
}

sync_data() {
    local data_type=$1
    local container_path="/var/jenkins_home/${data_type}"
    local storage_path="${TEAM_STORAGE_PATH}/${data_type}"
    
    # Check if source exists in container
    if ! docker exec "${CONTAINER_NAME}" test -d "${container_path}"; then
        log "‚ö†Ô∏è Source ${container_path} does not exist in container, skipping ${data_type}"
        return 0
    fi
    
    log "üìÅ Syncing ${data_type}..."
    
    case "$SYNC_METHOD" in
        "rsync")
            # Use rsync for efficient synchronization
            docker exec "${CONTAINER_NAME}" find "${container_path}" -type f -newer "${container_path}/.last_sync" 2>/dev/null | head -10 | while read -r file; do
                if [[ -n "$file" ]]; then
                    log "  üìÑ Copying modified file: $(basename "$file")"
                fi
            done
            
            # Perform the sync via docker cp (rsync not available in Jenkins container)
            docker cp "${CONTAINER_NAME}:${container_path}/." "${storage_path}/" || {
                log "‚ùå Failed to sync ${data_type}"
                return 1
            }
            ;;
        "cp")
            # Simple copy method
            docker cp "${CONTAINER_NAME}:${container_path}/." "${storage_path}/" || {
                log "‚ùå Failed to sync ${data_type}"
                return 1
            }
            ;;
    esac
    
    # Update timestamp marker
    docker exec "${CONTAINER_NAME}" touch "${container_path}/.last_sync"
    
    # Set proper ownership
    chown -R {{ jenkins_user }}:{{ jenkins_group }} "${storage_path}"
    
    log "‚úÖ Successfully synced ${data_type}"
}

# Sync each data type based on sync mode
sync_success=0
sync_total=${{ '{#' }}DATA_TYPES[@]}

if [[ "$SYNC_MODE" == "blue-green" ]]; then
    # Blue-green volume synchronization
    for data_type in "${DATA_TYPES[@]}"; do
        if sync_blue_green_data "$data_type"; then
            ((sync_success++))
        fi
    done
    log_prefix="Blue-green volume"
else
    # Default: shared storage synchronization
    for data_type in "${DATA_TYPES[@]}"; do
        if sync_data "$data_type"; then
            ((sync_success++))
        fi
    done
    log_prefix="Shared storage"
fi

# Report results
if [[ $sync_success -eq $sync_total ]]; then
    log "üéâ ${log_prefix} synchronization completed successfully (${sync_success}/${sync_total})"
    exit 0
else
    log "‚ö†Ô∏è ${log_prefix} partial synchronization completed (${sync_success}/${sync_total})"
    exit 1
fi