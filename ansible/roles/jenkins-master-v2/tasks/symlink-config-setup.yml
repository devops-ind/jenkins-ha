---
# Symlink-Based Configuration Management for Dynamic JCasC Updates (jenkins-master-v2)
# This task creates the symlink infrastructure for hot-reloadable configs

- name: Create symlink-based configuration directory structure
  block:
    - name: Create main config directories for symlink management
      file:
        path: "{{ item }}"
        state: directory
        owner: "{{ jenkins_user_id | default(1000) }}"
        group: "{{ jenkins_group_id | default(1000) }}"
        mode: '0755'
      loop:
        - "/var/jenkins/{{ team.team_name }}/configs"
        - "/var/jenkins/{{ team.team_name }}/configs/blue"
        - "/var/jenkins/{{ team.team_name }}/configs/green"
        - "/var/jenkins/{{ team.team_name }}/backups"
      loop_control:
        label: "/var/jenkins/{{ team.team_name }}/configs"

    - name: Check if active symlink exists
      stat:
        path: "/var/jenkins/{{ team.team_name }}/configs/active"
      register: active_symlink_stat

    - name: Copy CASC config to blue directory (initial setup)
      copy:
        src: "{{ jenkins_master_custom_build_dir }}/{{ team.team_name }}/blue/jenkins.yaml"
        dest: "/var/jenkins/{{ team.team_name }}/configs/blue/jenkins.yaml"
        remote_src: yes
        owner: "{{ jenkins_user_id | default(1000) }}"
        group: "{{ jenkins_group_id | default(1000) }}"
        mode: '0644'
      when: not active_symlink_stat.stat.exists

    - name: Copy CASC config to green directory (initial setup)
      copy:
        src: "{{ jenkins_master_custom_build_dir }}/{{ team.team_name }}/green/jenkins.yaml"
        dest: "/var/jenkins/{{ team.team_name }}/configs/green/jenkins.yaml"
        remote_src: yes
        owner: "{{ jenkins_user_id | default(1000) }}"
        group: "{{ jenkins_group_id | default(1000) }}"
        mode: '0644'
      when: not active_symlink_stat.stat.exists

    - name: Create initial active symlink pointing to blue
      file:
        src: "blue"
        dest: "/var/jenkins/{{ team.team_name }}/configs/active"
        state: link
        owner: "{{ jenkins_user_id | default(1000) }}"
        group: "{{ jenkins_group_id | default(1000) }}"
      when: not active_symlink_stat.stat.exists

    - name: Create state tracking file for symlink-based config
      copy:
        content: |
          {
            "config_mode": "symlink",
            "active_config": "blue",
            "last_update": "{{ ansible_date_time.iso8601 }}",
            "team_name": "{{ team.team_name }}",
            "container_name": "jenkins-{{ team.team_name }}",
            "casc_mount_path": "/var/jenkins/{{ team.team_name }}/configs/active"
          }
        dest: "/var/jenkins/{{ team.team_name }}/config-state.json"
        owner: "{{ jenkins_user_id | default(1000) }}"
        group: "{{ jenkins_group_id | default(1000) }}"
        mode: '0644'

    - name: Display symlink configuration summary
      debug:
        msg: |
          Symlink Configuration for {{ team.team_name }}:
          - Blue config: /var/jenkins/{{ team.team_name }}/configs/blue/jenkins.yaml
          - Green config: /var/jenkins/{{ team.team_name }}/configs/green/jenkins.yaml
          - Active symlink: /var/jenkins/{{ team.team_name }}/configs/active -> blue
          - Backups: /var/jenkins/{{ team.team_name }}/backups/
          - Container mount: /var/jenkins/{{ team.team_name }}/configs/active:/var/jenkins_home/casc_configs:ro
  loop: "{{ jenkins_teams_config }}"
  loop_control:
    loop_var: team
    label: "{{ team.team_name }}"
  tags: ['config-symlinks', 'symlink-setup']
