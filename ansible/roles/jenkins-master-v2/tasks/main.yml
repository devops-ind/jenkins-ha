---
# Simplified Jenkins Master Role - Main Orchestration
# Consolidated from 13 task files to 4 files while maintaining all enterprise features

- name: Display jenkins-master-v2 role information
  debug:
    msg: |
      ==================================================
      Jenkins Master Role v2 - Simplified Architecture
      ==================================================
      Original complexity: 1018 lines across 13 files
      Simplified version: ~530 lines across 4 files
      Features preserved: Blue-green, Multi-team, Custom images
      ==================================================

- name: Determine deployment configuration
  set_fact:
    jenkins_teams_config: "{{ jenkins_teams | default([jenkins_master_config]) }}"
    jenkins_deployment_mode: "{{ 'multi-team' if jenkins_teams is defined and jenkins_teams | length > 0 else 'single-team' }}"
  tags: ['always']

- name: Display deployment configuration
  debug:
    msg: |
      Deployment Mode: {{ jenkins_deployment_mode }}
      Teams to Deploy: {{ jenkins_teams_config | map(attribute='team_name') | list | join(', ') }}
      Container Runtime: {{ jenkins_master_container_runtime }}
  tags: ['always']

# Phase 0: Intelligent cleanup of orphaned team resources
- name: Cleanup orphaned team resources phase
  import_tasks: cleanup-orphaned-resources.yml
  when: jenkins_cleanup_enabled | default(true)
  tags: ['cleanup', 'remove-teams', 'orphaned-resources']

# Phase 1: System setup, validation, and infrastructure preparation
- name: Setup and validation phase
  import_tasks: setup-and-validate.yml
  tags: ['setup', 'validate', 'config', 'network']

# Phase 2: Custom image building and container deployment  
- name: Image building and container deployment phase
  import_tasks: image-and-container.yml
  tags: ['images', 'containers', 'deploy', 'custom-images', 'build']

# Phase 3: Blue-green deployment management and health monitoring
- name: Blue-green deployment and monitoring phase
  import_tasks: deploy-and-monitor.yml
  tags: ['blue-green', 'deploy', 'monitor', 'health', 'verify']

# Phase 3.5: Blue-green deployment synchronization (ensures containers match configuration)
- name: Blue-green deployment synchronization phase
  import_tasks: blue-green-sync.yml
  when: jenkins_teams_config is defined and jenkins_teams_config | length > 0
  tags: ['blue-green-sync', 'sync', 'containers', 'fix']

# Phase 3.6: Enhanced health checks with blue-green port logic fixes
- name: Enhanced health checks phase (fixes connection issues)
  import_tasks: fixed-health-checks.yml
  when: jenkins_teams_config is defined and jenkins_teams_config | length > 0
  tags: ['health-fix', 'health', 'verify', 'fix']

# Phase 4: Update HAProxy configuration for blue-green environment changes
- name: Notify HAProxy of team environment changes
  block:
    - name: Trigger HAProxy configuration regeneration
      template:
        src: ../high-availability-v2/templates/haproxy.cfg.j2
        dest: /etc/haproxy/haproxy.cfg
        backup: yes
        owner: root
        group: "{{ haproxy_user | default('haproxy') }}"
        mode: '0644'
      become: yes
      # Note: HAProxy will be synced separately in high-availability-v2 role
      delegate_to: "{{ item }}"
      loop: "{{ groups['load_balancers'] | default([]) }}"
      when: 
        - groups['load_balancers'] is defined
        - groups['load_balancers'] | length > 0
      vars:
        haproxy_effective_teams: "{{ jenkins_teams_config }}"
        
    - name: Force HAProxy handlers to run immediately
      meta: flush_handlers
      
  when: jenkins_teams_config is defined and jenkins_teams_config | length > 0
  tags: ['blue-green', 'haproxy-sync']

- name: Jenkins Master v2 deployment complete
  debug:
    msg: |
      ====================================================
      Jenkins Master v2 Deployment Summary
      ====================================================
      Mode: {{ jenkins_deployment_mode }}
      Teams: {{ jenkins_teams_config | length }}
      Active Environments: {{ jenkins_teams_config | selectattr('active_environment', 'defined') | map(attribute='active_environment') | list | join(', ') }}
      Container Runtime: {{ jenkins_master_container_runtime }}
      ====================================================
      Access your Jenkins instances:
      {% for team in jenkins_teams_config %}
      {{ team.team_name }}: http://{{ jenkins_verification_host }}:{% if team.active_environment | default('blue') == 'blue' %}{{ team.ports.web }}{% else %}{{ team.ports.web + 100 }}{% endif %}
      {% endfor %}
      ====================================================
  tags: ['always']