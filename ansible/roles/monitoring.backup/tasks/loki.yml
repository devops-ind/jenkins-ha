---
# Loki and Promtail deployment tasks for centralized logging

- name: Create Loki configuration from template
  template:
    src: "loki/loki-config.yml.j2"
    dest: "{{ monitoring_home_dir }}/loki/config/loki-config.yml"
    owner: "{{ monitoring_user }}"
    group: "{{ monitoring_group }}"
    mode: '0644'
  notify: restart loki

- name: Create Promtail configuration from template
  template:
    src: "promtail/promtail-config.yml.j2"
    dest: "{{ monitoring_home_dir }}/promtail/config/promtail-config.yml"
    owner: "{{ monitoring_user }}"
    group: "{{ monitoring_group }}"
    mode: '0644'
  notify: restart promtail

- name: Deploy Loki container
  community.docker.docker_container:
    name: loki-{{ deployment_environment | default('local') }}
    image: "grafana/loki:{{ loki_version }}"
    state: started
    restart_policy: "{{ monitoring_restart_policy }}"
    ports:
      - "{{ loki_port }}:3100"
    volumes:
      - "{{ monitoring_home_dir }}/loki/config:/etc/loki"
      - "{{ monitoring_home_dir }}/loki/data:/tmp/loki"
    command: ["-config.file=/etc/loki/loki-config.yml"]
    networks:
      - name: "{{ monitoring_docker_network }}"
    user: "{{ monitoring_uid }}:{{ monitoring_gid }}"
    env:
      LOKI_RETENTION_PERIOD: "{{ loki_retention }}"
  when: loki_enabled | default(true)

- name: Deploy Promtail container on Monitoring VM
  community.docker.docker_container:
    name: promtail-monitoring-{{ deployment_environment | default('local') }}
    image: "grafana/promtail:{{ promtail_version }}"
    state: started
    restart_policy: "{{ monitoring_restart_policy }}"
    ports:
      - "{{ promtail_port }}:9080"
    volumes:
      - "{{ monitoring_home_dir }}/promtail/config:/etc/promtail"
      - "{{ monitoring_home_dir }}/promtail/data:/promtail"
      - "/var/log:/var/log:ro"
      - "/var/lib/docker/containers:/var/lib/docker/containers:ro"
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
    command: ["-config.file=/etc/promtail/promtail-config.yml"]
    networks:
      - name: "{{ monitoring_docker_network }}"
    user: "{{ monitoring_uid }}:{{ monitoring_gid }}"
  when: promtail_enabled | default(true)

- name: Wait for Loki to be ready
  uri:
    url: "http://{{ loki_host }}:{{ loki_port }}/ready"
    method: GET
    status_code: 200
  register: loki_ready
  until: loki_ready.status == 200
  retries: 30
  delay: 2
  when: loki_enabled | default(true)

- name: Wait for Promtail to be ready
  uri:
    url: "http://{{ loki_host }}:{{ promtail_port }}/ready"
    method: GET
    status_code: 200
  register: promtail_ready
  until: promtail_ready.status == 200
  retries: 30
  delay: 2
  when: promtail_enabled | default(true)

- name: Display Loki deployment status
  debug:
    msg: |
      ðŸ“Š Loki Stack Deployment Status:
      Loki Service: {{ 'Running' if loki_enabled else 'Disabled' }} (Port: {{ loki_port }})
      Promtail Service: {{ 'Running' if promtail_enabled else 'Disabled' }} (Port: {{ promtail_port }})
      
      Log Sources Configured:
      {% for source_name, source_config in log_sources.items() %}
      â€¢ {{ source_name }}: {{ 'Enabled' if source_config.enabled else 'Disabled' }}
      {% endfor %}
      
      Retention Period: {{ loki_retention }}
      Data Directory: {{ monitoring_home_dir }}/loki/data
      
      Access URLs:
      - Loki API: http://localhost:{{ loki_port }}
      - Promtail Metrics: http://localhost:{{ promtail_port }}/metrics