---
# Default variables for monitoring role

# General monitoring configuration
monitoring_enabled: true
monitoring_version: "latest"

# Monitoring user configuration
monitoring_user: "monitoring"
monitoring_group: "monitoring" 
monitoring_uid: 1004
monitoring_gid: 1004
monitoring_home_dir: "{{ '/workspace/monitoring' if deployment_mode | default('local') in ['devcontainer', 'local'] else '/opt/monitoring' }}"

# Network configuration
monitoring_network_name: "monitoring-net"
monitoring_network_subnet: "172.26.0.0/16"

# Monitoring server addressing (for separate VM deployment)
monitoring_server_address: "{{ ansible_default_ipv4.address | default('localhost') }}"
prometheus_host: "{{ monitoring_server_address }}"
grafana_host: "{{ monitoring_server_address }}"
loki_host: "{{ monitoring_server_address }}"
alertmanager_host: "{{ monitoring_server_address }}"

# Deployment type detection (separate vs colocated)
monitoring_deployment_type: "{{ 'separate' if (groups['monitoring'] is defined and groups['jenkins_masters'] is defined and groups['monitoring'][0] not in groups['jenkins_masters']) else 'colocated' }}"

# Service configuration
prometheus_enabled: true
prometheus_port: 9090
prometheus_version: "latest"
prometheus_data_retention: "15d"
prometheus_scrape_interval: "30s"
prometheus_evaluation_interval: "30s"

# Grafana configuration
grafana_enabled: true
grafana_port: 9300  # Changed from 3000 to 9300 for monitoring consistency
grafana_version: "latest"
grafana_admin_user: "admin"
grafana_admin_password: "{{ vault_grafana_admin_password | default('admin123') }}"
grafana_allow_sign_up: false
grafana_disable_gravatar: true
# Dashboard update behavior: always, skip_existing, update_only
dashboard_update_mode: "always"

# Enhanced dashboard configuration
jenkins_enhanced_dashboards_enabled: true

# Centralized dashboard configuration registry
grafana_dashboards:
  # Core dashboards - infrastructure-wide
  infrastructure-health:
    category: core
    enabled: true
    title: "Infrastructure Health"
    description: "VM and container infrastructure metrics"
    refresh_interval: "1m"
    time_range: "1h"
    priority: 4
    template_file: "infrastructure-health.json"
    team_specific: false  # Global dashboard - monitors all infrastructure
  
  security-metrics:
    category: core
    enabled: true
    title: "Security Metrics"
    description: "Security events and compliance monitoring"
    refresh_interval: "1m"
    time_range: "4h"
    priority: 5
    template_file: "security-metrics.json"
    team_specific: false  # Global dashboard - monitors all security events
  
  node-exporter-full:
    category: core
    enabled: true
    title: "Node Exporter Full"
    description: "Comprehensive infrastructure monitoring with 138+ panels covering CPU, memory, disk, network, and system health"
    refresh_interval: "30s"
    time_range: "1h"
    priority: 6
    template_file: "node-exporter-full.json"
    team_specific: false  # Global infrastructure dashboard
  
  # Team-specific Jenkins dashboards
  jenkins-overview:
    category: core
    enabled: true
    title: "Jenkins Overview"
    description: "General Jenkins metrics and health overview"
    refresh_interval: "30s"
    time_range: "5m"
    priority: 1
    template_file: "jenkins-overview.json"
    team_specific: true  # Generate per-team versions
  
  jenkins-builds:
    category: core
    enabled: true
    title: "Jenkins Builds"
    description: "Build performance and trends"
    refresh_interval: "1m"
    time_range: "1h"
    priority: 2
    template_file: "jenkins-builds.json"
    team_specific: true  # Generate per-team versions
  
  jenkins-dynamic-agents:
    category: core
    enabled: true
    title: "Jenkins Dynamic Agents"
    description: "Dynamic agent monitoring and resource usage"
    refresh_interval: "30s"
    time_range: "1h"
    priority: 3
    template_file: "jenkins-dynamic-agents.json"
    team_specific: true  # Generate per-team versions
  
  # Enhanced team-specific dashboards
  jenkins-performance-health:
    category: enhanced
    enabled: true
    title: "Jenkins Performance Health"
    description: "Performance and health monitoring with 26+ panels"
    refresh_interval: "30s"
    time_range: "30m"
    priority: 10
    template_file: "jenkins-performance-health.json"
    team_specific: true  # Generate per-team versions
  
  jenkins-build-statistics:
    category: enhanced
    enabled: true
    title: "Jenkins Build Statistics"
    description: "Build statistics and job tracking dashboard"
    refresh_interval: "1m"
    time_range: "5m"
    priority: 11
    template_file: "jenkins-build-statistics.json"
    team_specific: true  # Generate per-team versions
  
  jenkins-advanced-overview:
    category: enhanced
    enabled: true  # Re-enabled after fixing metric schema
    title: "Advanced Jenkins Overview"
    description: "Advanced Jenkins overview with comprehensive monitoring"
    refresh_interval: "30s"
    time_range: "1h"
    priority: 12
    template_file: "jenkins-advanced-overview.json"
    team_specific: true  # Generate per-team versions

# Dashboard deployment controls
dashboard_deployment:
  core_enabled: true
  enhanced_enabled: "{{ jenkins_enhanced_dashboards_enabled | default(true) }}"
  update_mode: "{{ dashboard_update_mode | default('always') }}"
  validation_strict: false  # Temporarily disabled during testing
  
  # Team-specific dashboard generation
  generate_team_specific: true
  team_specific_suffix: " - {{ team_name | title }} Team"
  keep_global_dashboards: true  # Option to keep original multi-team dashboards
  team_folder_organization: true  # Organize by team folders in Grafana
  
  # Team dashboard naming convention
  team_dashboard_prefix: ""  # Optional prefix for team dashboards
  team_dashboard_separator: "-"  # Separator between dashboard name and team

# Legacy configuration (kept for backward compatibility)
jenkins_dashboard_config:
  performance_health:
    enabled: "{{ grafana_dashboards['jenkins-performance-health'].enabled }}"
    refresh_interval: "{{ grafana_dashboards['jenkins-performance-health'].refresh_interval }}"
    time_range: "{{ grafana_dashboards['jenkins-performance-health'].time_range }}"
    description: "{{ grafana_dashboards['jenkins-performance-health'].description }}"
  build_statistics:
    enabled: "{{ grafana_dashboards['jenkins-build-statistics'].enabled }}"
    refresh_interval: "{{ grafana_dashboards['jenkins-build-statistics'].refresh_interval }}"
    time_range: "{{ grafana_dashboards['jenkins-build-statistics'].time_range }}"
    description: "{{ grafana_dashboards['jenkins-build-statistics'].description }}"
  advanced_overview:
    enabled: "{{ grafana_dashboards['jenkins-advanced-overview'].enabled }}"
    refresh_interval: "{{ grafana_dashboards['jenkins-advanced-overview'].refresh_interval }}"
    time_range: "{{ grafana_dashboards['jenkins-advanced-overview'].time_range }}"
    description: "{{ grafana_dashboards['jenkins-advanced-overview'].description }}"

grafana_prometheus_datasource:
  name: "Prometheus"
  type: "prometheus"
  access: "proxy"
  url: "http://{{ prometheus_host }}:{{ prometheus_port }}"
  isDefault: true

# Alertmanager configuration
alertmanager_enabled: true
alertmanager_port: 9093
alertmanager_version: "latest"

# Microsoft Teams notification configuration
teams_notifications_enabled: true
teams_notification_strategy: "hybrid"  # Options: single, per-team, hybrid

# Teams webhook configuration (URLs from vault)
teams_webhook_critical: "{{ vault_teams_webhook_critical | default('') }}"
teams_webhook_warning: "{{ vault_teams_webhook_warning | default('') }}"
teams_webhook_info: "{{ vault_teams_webhook_info | default('') }}"

# Per-team Teams webhooks
teams_webhooks:
  devops:
    webhook_url: "{{ vault_teams_devops_webhook | default('') }}"
    enabled: true
  dev-qa:
    webhook_url: "{{ vault_teams_dev_qa_webhook | default('') }}"
    enabled: true
  infrastructure:
    webhook_url: "{{ vault_teams_infrastructure_webhook | default('') }}"
    enabled: true

# Node Exporter configuration
node_exporter_enabled: true
node_exporter_port: 9100
node_exporter_version: "latest"

# Agent monitoring configuration
monitoring_agent_health_check_enabled: true
monitoring_agent_health_check_interval: "*/5 * * * *"  # Every 5 minutes
monitoring_agent_health_timeout: 10
monitoring_agent_health_retries: 3

# Base Prometheus targets configuration
prometheus_base_targets:
  - job: "prometheus"
    targets:
      - "localhost:9090"
  - job: "node-exporter"
    targets:
      - "localhost:9100"

# Dynamic Jenkins targets - generated based on team configuration
# This will be overridden in tasks/main.yml with team-aware targets
prometheus_jenkins_targets: []

# Combined prometheus targets (base + dynamic jenkins)
prometheus_targets: "{{ prometheus_base_targets + prometheus_jenkins_targets }}"

# Docker configuration for monitoring services
monitoring_docker_network: "{{ monitoring_network_name }}"
monitoring_restart_policy: "unless-stopped"

# Additional exporters
cadvisor_enabled: true
cadvisor_port: 9200  # Changed to 9000 range for monitoring consistency
cadvisor_version: "latest"
cadvisor_on_jenkins_vms: true  # Deploy cAdvisor on Jenkins VMs for container metrics

# Directories to create
monitoring_directories:
  - "{{ monitoring_home_dir }}"
  - "{{ monitoring_home_dir }}/prometheus"
  - "{{ monitoring_home_dir }}/prometheus/data"
  - "{{ monitoring_home_dir }}/prometheus/config"
  - "{{ monitoring_home_dir }}/prometheus/rules"
  - "{{ monitoring_home_dir }}/grafana"
  - "{{ monitoring_home_dir }}/grafana/data"
  - "{{ monitoring_home_dir }}/grafana/dashboards"
  - "{{ monitoring_home_dir }}/grafana/provisioning"
  - "{{ monitoring_home_dir }}/grafana/provisioning/dashboards"
  - "{{ monitoring_home_dir }}/grafana/provisioning/datasources"
  - "{{ monitoring_home_dir }}/alertmanager"
  - "{{ monitoring_home_dir }}/exporters"
  - "{{ monitoring_home_dir }}/bin"
  - "{{ monitoring_home_dir }}/logs"
  - "{{ monitoring_home_dir }}/loki"
  - "{{ monitoring_home_dir }}/loki/data"
  - "{{ monitoring_home_dir }}/loki/config"
  - "{{ monitoring_home_dir }}/promtail"
  - "{{ monitoring_home_dir }}/promtail/config"
  - "{{ monitoring_home_dir }}/promtail/data"

# Loki configuration
loki_enabled: true
loki_port: 9400
loki_version: "latest"
loki_retention: "30d"
loki_max_chunk_age: "1h"
loki_chunk_idle_period: "30m"
loki_compactor_retention_enabled: true

# Promtail configuration  
promtail_enabled: true
promtail_port: 9401
promtail_version: "latest"
promtail_positions_file: "{{ monitoring_home_dir }}/promtail/data/positions.yaml"

# Log sources configuration
log_sources:
  jenkins_containers:
    enabled: true
    path: "/var/lib/docker/containers/*/*-json.log"
    labels:
      job: "jenkins"
      source: "container"
  haproxy_logs:
    enabled: true
    path: "/var/log/haproxy/*.log"
    labels:
      job: "haproxy"
      source: "haproxy"
  system_logs:
    enabled: true
    path: "/var/log/messages"
    labels:
      job: "system"
      source: "syslog"
  auth_logs:
    enabled: true
    path: "/var/log/secure"
    labels:
      job: "auth"
      source: "security"

# Loki data source for Grafana
loki_datasource:
  name: "Loki"
  type: "loki"
  access: "proxy"
  url: "http://{{ loki_host }}:{{ loki_port }}"
  isDefault: false
