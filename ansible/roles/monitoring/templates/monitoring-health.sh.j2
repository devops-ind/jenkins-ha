#!/bin/bash
# Monitoring stack health check script
# Generated by Ansible for {{ deployment_environment | default('local') }} environment

set -euo pipefail

PROMETHEUS_URL="http://{{ prometheus_host }}:{{ prometheus_port }}"
GRAFANA_URL="http://{{ grafana_host }}:{{ grafana_port }}"
{% if alertmanager_enabled | default(false) %}
ALERTMANAGER_URL="http://{{ alertmanager_host }}:{{ alertmanager_port }}"
{% endif %}

LOG_FILE="{{ monitoring_home_dir }}/logs/health-check.log"
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

# Ensure log directory exists
mkdir -p "$(dirname "$LOG_FILE")"

# Function to log messages
log() {
    echo "[$TIMESTAMP] $1" | tee -a "$LOG_FILE"
}

# Function to check service health
check_service() {
    local name="$1"
    local url="$2"
    local endpoint="$3"
    
    if curl -f -s "$url$endpoint" > /dev/null 2>&1; then
        log "‚úÖ $name is healthy"
        return 0
    else
        log "‚ùå $name is unhealthy or unreachable at $url$endpoint"
        return 1
    fi
}

# Main health checks
log "üîç Starting monitoring stack health check"

HEALTHY=true

# Check Prometheus
if ! check_service "Prometheus" "$PROMETHEUS_URL" "/-/healthy"; then
    HEALTHY=false
fi

# Check Grafana
if ! check_service "Grafana" "$GRAFANA_URL" "/api/health"; then
    HEALTHY=false
fi

{% if alertmanager_enabled | default(false) %}
# Check Alertmanager
if ! check_service "Alertmanager" "$ALERTMANAGER_URL" "/-/healthy"; then
    HEALTHY=false
fi
{% endif %}

# Check Node Exporter
if ! check_service "Node Exporter" "http://localhost:{{ node_exporter_port }}" "/metrics"; then
    HEALTHY=false
fi

# Final status
if [ "$HEALTHY" = true ]; then
    log "üéâ All monitoring services are healthy"
    exit 0
else
    log "üí• Some monitoring services are unhealthy"
    exit 1
fi