# Prometheus configuration for Jenkins Infrastructure
global:
  scrape_interval: {{ prometheus_scrape_interval }}
  evaluation_interval: {{ prometheus_evaluation_interval }}
  external_labels:
    monitor: 'jenkins-infrastructure'
    environment: '{{ deployment_environment | default("local") }}'

rule_files:
  - "rules/*.yml"

alerting:
{% if alertmanager_enabled | default(false) %}
  alertmanagers:
    - static_configs:
        - targets:
          - localhost:{{ alertmanager_port }}
{% endif %}

scrape_configs:
{% for target in prometheus_targets %}
  - job_name: '{{ target.job }}'
    static_configs:
      - targets: {{ target.targets | to_json }}
    {% if target.job is defined and (target.job.startswith('jenkins') or target.job == 'jenkins') %}
    # Jenkins-specific configuration
    metrics_path: /prometheus
    scrape_interval: 30s
    scrape_timeout: 10s
    {% if target.team_name is defined %}
    # Team-specific labels for better metrics organization
    metric_relabel_configs:
      - source_labels: [__name__]
        target_label: jenkins_team
        replacement: '{{ target.team_name }}'
      - source_labels: [__name__]
        target_label: jenkins_environment
        replacement: '{{ target.active_environment | default("blue") }}'
    {% endif %}
    {% endif %}
{% endfor %}

{% if cadvisor_enabled | default(true) %}
  - job_name: 'cadvisor'
    static_configs:
      - targets: ['localhost:{{ cadvisor_port }}']
{% endif %}