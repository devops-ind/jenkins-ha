# Prometheus configuration for Jenkins Infrastructure
# Production-ready multi-team configuration with proper labeling and monitoring

global:
  scrape_interval: {{ prometheus_scrape_interval }}
  evaluation_interval: {{ prometheus_evaluation_interval }}
  external_labels:
    monitor: 'jenkins-infrastructure'
    environment: '{{ deployment_mode | default("local") }}'
    cluster: '{{ jenkins_domain | default("localhost") }}'

rule_files:
  - "rules/*.yml"

alerting:
{% if alertmanager_enabled | default(false) %}
  alertmanagers:
    - static_configs:
        - targets:
          - {{ alertmanager_host }}:{{ alertmanager_port }}
{% else %}
  alertmanagers: []
{% endif %}

scrape_configs:
# ======================================================
# BASE MONITORING TARGETS
# ======================================================
{% for target in prometheus_targets %}
{% if target.job is defined and not (target.job.startswith('jenkins-') or target.job == 'jenkins' or target.job == 'jenkins-default') %}
  - job_name: '{{ target.job }}'
    static_configs:
      - targets: {{ target.targets | to_json }}
{% if monitoring_deployment_type == 'separate' and target.job == 'node-exporter' and prometheus_cross_vm_targets is defined and prometheus_cross_vm_targets | length > 0 %}
      # Cross-VM node-exporter targets from Jenkins VMs
      - targets: {{ prometheus_cross_vm_targets | to_json }}
        labels:
          role: 'jenkins-vm'
          deployment_type: 'cross-vm'
{% endif %}
{% if target.job == 'prometheus' %}
    # Prometheus self-monitoring
    scrape_interval: 15s
    metrics_path: /metrics
{% elif target.job == 'node-exporter' %}
    # Node exporter for system metrics
    scrape_interval: 30s
    metrics_path: /metrics
{% endif %}
{% endif %}
{% endfor %}

# ======================================================
# JENKINS-SPECIFIC MONITORING TARGETS
# ======================================================
{% for target in prometheus_targets %}
{% if target.job is defined and (target.job.startswith('jenkins-') or target.job == 'jenkins' or target.job == 'jenkins-default') %}
  - job_name: '{{ target.job }}'
    static_configs:
      - targets: {{ target.targets | to_json }}
    # Jenkins Prometheus plugin metrics endpoint
    metrics_path: /prometheus
    scrape_interval: 30s
    scrape_timeout: 10s
    honor_labels: true
    # Team-specific labels for multi-tenant monitoring
    metric_relabel_configs:
      # Add team identification
      - source_labels: [__name__]
        target_label: jenkins_team
        replacement: '{{ target.team_name | default("unknown") }}'
      # Add active environment information
      - source_labels: [__name__]
        target_label: jenkins_environment
        replacement: '{{ target.active_environment | default("blue") }}'
      # Add deployment mode context
      - source_labels: [__name__]
        target_label: deployment_mode
        replacement: '{{ deployment_mode | default("local") }}'
      # Add blue-green deployment status
      - source_labels: [__name__]
        target_label: blue_green_enabled
        replacement: '{{ target.blue_green_enabled | default(false) | string }}'
      # Add effective port for debugging
      - source_labels: [__name__]
        target_label: jenkins_port
        replacement: '{{ target.port | default(8080) | string }}'
      # Add instance-level team labeling for better filtering
      - source_labels: [instance]
        target_label: team_instance
        replacement: '{{ target.team_name | default("default") }}-${1}'
    # Static labels for consistent identification
    params:
      team: ['{{ target.team_name | default("default") }}']
      environment: ['{{ target.active_environment | default("blue") }}']
{% endif %}
{% endfor %}

# ======================================================
# CONTAINER AND INFRASTRUCTURE MONITORING
# ======================================================
{% if cadvisor_enabled | default(true) %}
  - job_name: 'cadvisor'
    static_configs:
      - targets: ['{{ monitoring_server_address }}:{{ cadvisor_port }}']
{% if monitoring_deployment_type == 'separate' and prometheus_cadvisor_targets is defined and prometheus_cadvisor_targets | length > 0 %}
      # Cross-VM cAdvisor targets from Jenkins VMs
      - targets: {{ prometheus_cadvisor_targets | to_json }}
        labels:
          role: 'jenkins-vm'
          deployment_type: 'cross-vm'
{% endif %}
    scrape_interval: 30s
    metrics_path: /metrics
    # Container metrics labeling
    metric_relabel_configs:
      # Add deployment mode to container metrics
      - source_labels: [__name__]
        target_label: deployment_mode
        replacement: '{{ deployment_mode | default("local") }}'
{% if jenkins_teams | default([]) | length > 0 %}
      # Filter Jenkins container metrics by team
{% for team in jenkins_teams | default([]) %}
      - source_labels: [container_label_com_docker_compose_service]
        regex: 'jenkins-{{ team.team_name }}-.*'
        target_label: jenkins_team
        replacement: '{{ team.team_name }}'
{% endfor %}
{% endif %}
{% endif %}

# ======================================================
# DYNAMIC AGENT MONITORING
# ======================================================
# Dynamic Jenkins agents are monitored through cAdvisor
# Agent containers follow naming pattern: jenkins-agent-{type}-{team}-{id}
{% if cadvisor_enabled | default(true) %}
  - job_name: 'jenkins-dynamic-agents'
    static_configs:
      - targets: ['{{ monitoring_server_address }}:{{ cadvisor_port }}']
    scrape_interval: 30s
    metrics_path: /metrics
    # Filter for agent containers only
    params:
      match[]:
        - 'container_cpu_usage_seconds_total{container_label_com_docker_compose_service=~"jenkins-agent-.*"}'
    metric_relabel_configs:
{% if jenkins_teams | default([]) | length > 0 %}
      # Extract team from agent container names
{% for team in jenkins_teams | default([]) %}
      - source_labels: [container_label_com_docker_compose_service]
        regex: 'jenkins-agent-.+-{{ team.team_name }}-.+'
        target_label: jenkins_team
        replacement: '{{ team.team_name }}'
      - source_labels: [container_label_com_docker_compose_service]
        regex: 'jenkins-agent-(.+)-{{ team.team_name }}-.+'
        target_label: agent_type
        replacement: '${1}'
{% endfor %}
{% endif %}
      # Add deployment mode for consistency
      - source_labels: [__name__]
        target_label: deployment_mode
        replacement: '{{ deployment_mode | default("local") }}'
{% endif %}