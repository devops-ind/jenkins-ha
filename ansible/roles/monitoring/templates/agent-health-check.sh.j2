#!/bin/bash
# Monitoring Agent Health Check Script
# Generated by Ansible for {{ deployment_environment | default('local') }} environment
# Checks health of monitoring agents running on this host

set -euo pipefail

# Configuration
MONITORING_SERVER="{{ monitoring_server_address }}"
NODE_EXPORTER_PORT="{{ node_exporter_port }}"
PROMTAIL_PORT="{{ promtail_port }}"
{% if cadvisor_enabled | default(true) %}
CADVISOR_PORT="{{ cadvisor_port }}"
{% endif %}
LOKI_SERVER="http://{{ loki_host }}:{{ loki_port }}"

LOG_FILE="/var/log/monitoring-agents/health-check.log"
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
HOSTNAME=$(hostname)

# Ensure log directory exists
mkdir -p "$(dirname "$LOG_FILE")"

# Function to log messages
log() {
    echo "[$TIMESTAMP] $1" | tee -a "$LOG_FILE"
}

# Function to check service health
check_service() {
    local name="$1"
    local url="$2"
    local timeout="${3:-5}"

    if curl -f -s --max-time "$timeout" "$url" > /dev/null 2>&1; then
        log "OK: $name is healthy"
        return 0
    else
        log "ERROR: $name is unhealthy or unreachable"
        return 1
    fi
}

# Function to check Docker container
check_container() {
    local container_name="$1"

    if docker ps --filter "name=$container_name" --filter "status=running" --format "{{.Names}}" | grep -q "^${container_name}$"; then
        log "OK: Container $container_name is running"
        return 0
    else
        log "ERROR: Container $container_name is not running"
        return 1
    fi
}

log "=========================================="
log "Monitoring Agent Health Check Started"
log "Hostname: $HOSTNAME"
log "=========================================="

# Initialize status counters
TOTAL_CHECKS=0
FAILED_CHECKS=0

# Check Node Exporter
log "Checking Node Exporter..."
TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
if ! check_service "Node Exporter" "http://localhost:${NODE_EXPORTER_PORT}/metrics"; then
    FAILED_CHECKS=$((FAILED_CHECKS + 1))
fi

# Check Promtail
log "Checking Promtail..."
TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
if ! check_service "Promtail" "http://localhost:${PROMTAIL_PORT}/ready"; then
    FAILED_CHECKS=$((FAILED_CHECKS + 1))
fi

{% if cadvisor_enabled | default(true) %}
# Check cAdvisor
log "Checking cAdvisor..."
TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
if ! check_service "cAdvisor" "http://localhost:${CADVISOR_PORT}/metrics"; then
    FAILED_CHECKS=$((FAILED_CHECKS + 1))
fi
{% endif %}

# Check connectivity to Loki server
log "Checking Loki connectivity..."
TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
if ! check_service "Loki Server" "${LOKI_SERVER}/ready"; then
    FAILED_CHECKS=$((FAILED_CHECKS + 1))
fi

# Check Docker containers
log "Checking Docker containers..."
CONTAINERS=(
    "node-exporter-{{ deployment_environment | default('local') }}"
    "promtail-{{ deployment_environment | default('local') }}"
{% if cadvisor_enabled | default(true) %}
    "cadvisor-{{ deployment_environment | default('local') }}"
{% endif %}
)

for container in "${CONTAINERS[@]}"; do
    TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
    if ! check_container "$container"; then
        FAILED_CHECKS=$((FAILED_CHECKS + 1))
    fi
done

# Summary
log "=========================================="
log "Health Check Summary"
log "Total checks: $TOTAL_CHECKS"
log "Passed: $((TOTAL_CHECKS - FAILED_CHECKS))"
log "Failed: $FAILED_CHECKS"

if [ "$FAILED_CHECKS" -eq 0 ]; then
    log "Status: ALL HEALTHY"
    log "=========================================="
    exit 0
else
    log "Status: DEGRADED ($FAILED_CHECKS failures)"
    log "=========================================="

    # Alert to monitoring server (optional)
    if [ -n "${MONITORING_SERVER}" ]; then
        log "Sending alert to monitoring server..."
        curl -sf -X POST \
            -H "Content-Type: application/json" \
            -d "{\"hostname\": \"$HOSTNAME\", \"failed_checks\": $FAILED_CHECKS, \"timestamp\": \"$TIMESTAMP\"}" \
            "http://${MONITORING_SERVER}:{{ prometheus_port }}/api/v1/write" \
            2>&1 | tee -a "$LOG_FILE" || true
    fi

    exit 1
fi
