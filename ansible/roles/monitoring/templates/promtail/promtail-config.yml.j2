server:
  http_listen_port: {{ promtail_port }}
  grpc_listen_port: 0

positions:
  filename: {{ promtail_positions_file }}

clients:
  - url: http://{{ loki_host }}:{{ loki_port }}/loki/api/v1/push

scrape_configs:
{% if log_sources.jenkins_containers.enabled %}
  # Jenkins container logs
  - job_name: jenkins-containers
    static_configs:
      - targets:
          - localhost
        labels:
          job: jenkins
          source: container
          __path__: "{{ log_sources.jenkins_containers.path }}"
    pipeline_stages:
      - json:
          expressions:
            output: log
            stream: stream
            timestamp: time
      - labels:
          stream:
      - timestamp:
          source: timestamp
          format: RFC3339Nano
      - output:
          source: output
      # Extract team information from container name
      - regex:
          expression: '.*\/docker\/containers\/(?P<container_id>[a-f0-9]+)-.*'
      - template:
          source: container_name
          template: {% raw %}'{{ .container_id }}'{% endraw %}
      # Add team label based on container name pattern
      - template:
          source: team
          template: |
            {% raw %}{{- if contains .container_name "jenkins-jenkins" -}}devops
            {{- else if contains .container_name "jenkins-digjenkins" -}}digjenkins
            {{- else if contains .container_name "jenkins-bwjenkins" -}}bwjenkins
            {{- else if contains .container_name "jenkins-bwacjenkins" -}}bwacjenkins
            {{- else -}}unknown{{- end }}{% endraw %}
      - labels:
          team:
          container_id:
{% endif %}

{% if log_sources.haproxy_logs.enabled %}
  # HAProxy logs
  - job_name: haproxy
    static_configs:
      - targets:
          - localhost
        labels:
          job: haproxy
          source: haproxy
          __path__: "{{ log_sources.haproxy_logs.path }}"
    pipeline_stages:
      # Parse HAProxy log format
      - regex:
          expression: '(?P<timestamp>\w+\s+\d+\s+\d+:\d+:\d+)\s+(?P<server>\S+)\s+(?P<process>\S+):\s+(?P<client_ip>\S+):(?P<client_port>\d+)\s+\[(?P<request_date>[^\]]+)\]\s+(?P<frontend_name>\S+)\s+(?P<backend_name>\S+)/(?P<server_name>\S+)\s+(?P<time_request>\d+)/(?P<time_queue>\d+)/(?P<time_connect>\d+)/(?P<time_response>\d+)/(?P<time_active>\d+)\s+(?P<http_status_code>\d+)\s+(?P<bytes_read>\d+)\s+"(?P<http_request>[^"]+)"\s+"(?P<captured_request_cookie>[^"]+)"\s+"(?P<captured_response_cookie>[^"]+)"\s+(?P<termination_state>\S+)\s+(?P<actconn>\d+)/(?P<feconn>\d+)/(?P<beconn>\d+)/(?P<srvconn>\d+)/(?P<retries>\d+)\s+(?P<srv_queue>\d+)/(?P<backend_queue>\d+)\s+"(?P<captured_request_headers>[^"]+)"\s+"(?P<captured_response_headers>[^"]+)"\s+"(?P<http_request_2>[^"]*)"'
      - labels:
          client_ip:
          frontend_name:
          backend_name:
          server_name:
          http_status_code:
          termination_state:
      # Extract team from backend name
      - template:
          source: team
          template: |
            {% raw %}{{- if contains .backend_name "jenkins" -}}devops
            {{- else if contains .backend_name "digjenkins" -}}digjenkins
            {{- else if contains .backend_name "bwjenkins" -}}bwjenkins
            {{- else if contains .backend_name "bwacjenkins" -}}bwacjenkins
            {{- else -}}system{{- end }}{% endraw %}
      - labels:
          team:
{% endif %}

{% if log_sources.system_logs.enabled %}
  # System logs
  - job_name: system
    static_configs:
      - targets:
          - localhost
        labels:
          job: system
          source: syslog
          __path__: "{{ log_sources.system_logs.path }}"
    pipeline_stages:
      # Parse syslog format
      - regex:
          expression: '(?P<timestamp>\w+\s+\d+\s+\d+:\d+:\d+)\s+(?P<hostname>\S+)\s+(?P<process>\S+):\s+(?P<message>.*)'
      - labels:
          hostname:
          process:
{% endif %}

{% if log_sources.auth_logs.enabled %}
  # Authentication logs
  - job_name: auth
    static_configs:
      - targets:
          - localhost
        labels:
          job: auth
          source: security
          __path__: "{{ log_sources.auth_logs.path }}"
    pipeline_stages:
      # Parse auth log format
      - regex:
          expression: '(?P<timestamp>\w+\s+\d+\s+\d+:\d+:\d+)\s+(?P<hostname>\S+)\s+(?P<process>\S+):\s+(?P<message>.*)'
      - labels:
          hostname:
          process:
      # Extract authentication events
      - regex:
          expression: '.*(?P<auth_result>Failed|Successful).*(?P<auth_method>password|publickey).*user\s+(?P<username>\S+)'
      - labels:
          auth_result:
          auth_method:
          username:
{% endif %}

  # Docker container logs for Jenkins teams
{% for team in ['jenkins', 'digjenkins', 'bwjenkins', 'bwacjenkins'] %}
  - job_name: jenkins-{{ team }}
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          - name: name
            values: ["jenkins-{{ team }}-*"]
    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        target_label: container_name
      - source_labels: ['__meta_docker_container_id']
        target_label: container_id
      - replacement: {{ team }}
        target_label: team
      - replacement: jenkins
        target_label: job
      - replacement: container
        target_label: source
    pipeline_stages:
      - json:
          expressions:
            output: log
            stream: stream
            timestamp: time
      - timestamp:
          source: timestamp
          format: RFC3339Nano
      - output:
          source: output
      # Extract environment from container name
      - regex:
          expression: 'jenkins-{{ team }}-(?P<environment>blue|green)'
      - labels:
          environment:
{% endfor %}

  # HAProxy container logs
  - job_name: haproxy-container
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          - name: name
            values: ["haproxy-*"]
    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        target_label: container_name
      - source_labels: ['__meta_docker_container_id']
        target_label: container_id
      - replacement: haproxy
        target_label: job
      - replacement: container
        target_label: source
    pipeline_stages:
      - json:
          expressions:
            output: log
            stream: stream
            timestamp: time
      - timestamp:
          source: timestamp
          format: RFC3339Nano
      - output:
          source: output
{% if jenkins_teams_config is defined and jenkins_teams_config | length > 0 %}
  # Jenkins job build logs (from mounted Docker volumes)
  - job_name: jenkins-job-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: jenkins-job-logs
          source: build-logs
          __path__: "/jenkins-logs/**/builds/**/log"
    pipeline_stages:
      # Drop lines containing:
      #   - 'ha:' markers
      #   - ANSI escape sequences (\x1b[)
      #   - null bytes (\x00)
      - drop:
          expression: '(ha:|\\x1b\\[|\\x00)'
      #######################################################################
      # 1) Main path decode – this is the one that we know now works
      #
      # Matches:
      #   .../jenkins-logs/<jenkins>/[data/]<environment>/
      #     (jobs/.../jobs/)?<job_name>[/branches/<branch>]/builds/<n>/log
      #######################################################################
      - regex:
          source: filename
          expression: '.*/jenkins-logs/(?P<jenkins>jenkins|digjenkins|bwacjenkins|bwjenkins)/(?:data/)?(?P<environment>[^/]+)/(?:(?:jobs/(?:[^/]+/jobs/)*)?(?P<job_name>[^/]+))(?:/branches/(?P<branch_name>[^/]+))?/builds/(?P<build_number>[0-9]+)/log$'

      #######################################################################
      # 2) folder1: first folder after /jobs/
      #
      # Example:
      #   /jenkins-logs/.../green/jobs/MobileApp-Build/...
      #   → folder1 = MobileApp-Build
      #######################################################################
      - regex:
          source: filename
          expression: '.*/jenkins-logs/(?:jenkins|digjenkins|bwacjenkins|bwjenkins)/(?:data/)?[^/]+/jobs/(?P<folder1>[^/]+)/.*'

      #######################################################################
      # 3) folder2: second folder after /jobs/<folder1>/jobs/
      #
      # Example:
      #   /jenkins-logs/.../green/jobs/MobileApp-Build/jobs/DMA-Android/...
      #   → folder2 = DMA-Android
      #######################################################################
      - regex:
          source: filename
          expression: '.*/jenkins-logs/(?:jenkins|digjenkins|bwacjenkins|bwjenkins)/(?:data/)?[^/]+/jobs/[^/]+/jobs/(?P<folder2>[^/]+)/.*'

      #######################################################################
      # 4) Derived pipeline name
      #
      # If folder1 exists AND folder1 != job_name:
      #   pipeline = folder1[/folder2]/job_name
      # Else:
      #   pipeline = job_name
      #######################################################################
      - template:
          source: pipeline
          template: >
            {{- if and .folder1 (ne .folder1 .job_name) -}}
              {{- .folder1 -}}
              {{- if .folder2 -}}/{{ .folder2 }}{{ end -}}
              /{{ .job_name }}
            {{- else -}}
              {{- .job_name -}}
            {{- end -}}

      - drop:
          older_than: 1h
          drop_counter_reason: "bootstrap_old_lines"

      #######################################################################
      # 5) Expose everything as Loki labels
      #######################################################################
      - labels:
          team:        jenkins        # team name (jenkins / digjenkins / bwjenkins / bwacjenkins)
          environment: environment
          folder1:     folder1
          folder2:     folder2
          job_name:    job_name
          branch_name: branch_name
          build_number: build_number
          pipeline:    pipeline


      # Add timestamp (Jenkins logs have timestamps in content)
      - match:
          selector: '{job="jenkins-job-logs"}'
          stages:
            - regex:
                expression: '^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}\.\d{3}\s+(?P<log_level>[A-Z]+)\s+(?P<message>.*)$'
            - labels:
                log_level:
      # Extract build result (SUCCESS, FAILURE, UNSTABLE, ABORTED)
      - regex:
          expression: '^.*Finished:\s+(?P<build_result>SUCCESS|FAILURE|UNSTABLE|ABORTED).*$'
      - labels:
          build_result:
      # Extract build duration (convert to seconds for metrics)
      - regex:
          expression: 'Duration:\s+(?:(?P<hours>\d+)\s*hr\s*)?(?:(?P<minutes>\d+)\s*min\s*)?(?:(?P<seconds>\d+)\s*sec)?'
      - template:
          source: duration_seconds
          template: '{{ add (add (mul (or .hours "0") 3600) (mul (or .minutes "0") 60)) (or .seconds "0") }}'
{% raw %}
      - labels:
          duration_seconds:
      # Extract error messages for failed builds
      - match:
          selector: '{job="jenkins-job-logs", build_result="FAILURE"}'
          stages:
            - regex:
                expression: '(?i)(?P<error_type>ERROR|EXCEPTION|FATAL|BUILD\s+FAIL)'
            - labels:
                error_type:
      # Generate Prometheus metrics from logs
      - metrics:
          jenkins_build_logs_total:
            type: Counter
            description: "Total Jenkins builds processed from logs"
            source: build_result
            config:
              action: inc
              match_all: true
          jenkins_build_duration_seconds:
            type: Histogram
            description: "Jenkins build duration in seconds from logs"
            source: duration_seconds
            config:
              buckets: [60, 300, 600, 1800, 3600, 7200]
          jenkins_build_errors_total:
            type: Counter
            description: "Total errors detected in Jenkins build logs"
            source: error_type
            config:
              action: inc
              match_all: true
{% endraw %}
{% endif %}
