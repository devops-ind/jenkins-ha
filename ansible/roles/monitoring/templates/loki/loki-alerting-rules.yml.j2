---
# Loki Alerting Rules for Jenkins Build Monitoring
# These rules analyze Jenkins build logs and trigger alerts based on patterns
# Generated by Ansible - Do not edit manually

groups:
  - name: jenkins_build_failures
    interval: 1m
    rules:
      # Critical: High build failure rate for a specific job
      - alert: JenkinsBuildFailureHigh
        expr: |
          sum(rate({job="jenkins-job-logs"} |= "Finished: FAILURE" [5m])) by (team, job_name) > 0.5
        for: 10m
        labels:
          severity: critical
          alert_type: build_failure
          team: {% raw %}"{{ $labels.team }}"{% endraw %}

        annotations:
          summary: "High build failure rate for {% raw %}{{ $labels.job_name }}{% endraw %} (team: {% raw %}{{ $labels.team }}{% endraw %})"
          description: |
            Build failure rate is above 50% for the last 10 minutes
            - Team: {% raw %}{{ $labels.team }}{% endraw %}

            - Job: {% raw %}{{ $labels.job_name }}{% endraw %}

            - Environment: {% raw %}{{ $labels.environment }}{% endraw %}

            - Failure Rate: {% raw %}{{ humanize $value }}{% endraw %} failures/second

            Action: Check build logs in Grafana or Jenkins console for root cause
          dashboard_url: "http://{{ grafana_host }}:{{ grafana_port }}/d/jenkins-build-logs/jenkins-build-logs?var-team={% raw %}{{ $labels.team }}{% endraw %}"
          runbook_url: "{{ monitoring_runbook_url | default('#') }}/jenkins-build-failures"

      # Warning: Individual build failure (immediate notification)
      - alert: JenkinsBuildFailed
        expr: |
          count_over_time({job="jenkins-job-logs"} |= "Finished: FAILURE" [1m]) > 0
        for: 1m
        labels:
          severity: warning
          alert_type: build_failure
          team: {% raw %}"{{ $labels.team }}"{% endraw %}

        annotations:
          summary: "Jenkins build failed: {% raw %}{{ $labels.job_name }}{% endraw %} #{% raw %}{{ $labels.build_number }}{% endraw %}"
          description: |
            A Jenkins build has failed
            - Team: {% raw %}{{ $labels.team }}{% endraw %}

            - Job: {% raw %}{{ $labels.job_name }}{% endraw %}

            - Build Number: {% raw %}{{ $labels.build_number }}{% endraw %}

            - Environment: {% raw %}{{ $labels.environment }}{% endraw %}


            Check the build logs for error details
          jenkins_url: "http://{{ jenkins_domain }}:8080/job/{% raw %}{{ $labels.job_name }}{% endraw %}/{% raw %}{{ $labels.build_number }}{% endraw %}/console"
          loki_query: "{job=\"jenkins-job-logs\", team=\"{% raw %}{{ $labels.team }}{% endraw %}\", job_name=\"{% raw %}{{ $labels.job_name }}{% endraw %}\", build_number=\"{% raw %}{{ $labels.build_number }}{% endraw %}\"}"

  - name: jenkins_error_patterns
    interval: 5m
    rules:
      # Warning: High error rate in build logs
      - alert: JenkinsErrorRateHigh
        expr: |
          sum(rate({job="jenkins-job-logs"} |~ "(error|exception|fatal)" [5m])) by (team, job_name) > 2
        for: 5m
        labels:
          severity: warning
          alert_type: error_rate
          team: {% raw %}"{{ $labels.team }}"{% endraw %}

        annotations:
          summary: "High error rate in build logs for {% raw %}{{ $labels.job_name }}{% endraw %}"
          description: |
            Error rate exceeds 2 errors/second in build logs
            - Team: {% raw %}{{ $labels.team }}{% endraw %}

            - Job: {% raw %}{{ $labels.job_name }}{% endraw %}

            - Error Rate: {% raw %}{{ humanize $value }}{% endraw %} errors/second

            This may indicate:
            - Test failures
            - Dependency issues
            - Configuration problems
            - Infrastructure errors
          dashboard_url: "http://{{ grafana_host }}:{{ grafana_port }}/d/jenkins-build-logs/jenkins-build-logs?var-team={% raw %}{{ $labels.team }}{% endraw %}"

      # Info: Specific error patterns detected
      - alert: JenkinsTestFailureDetected
        expr: |
          sum(count_over_time({job="jenkins-job-logs"} |~ "(test.*fail|assertion.*fail|junit.*fail)" [5m])) by (team, job_name) > 0
        for: 2m
        labels:
          severity: info
          alert_type: test_failure
          team: {% raw %}"{{ $labels.team }}"{% endraw %}

        annotations:
          summary: "Test failures detected in {% raw %}{{ $labels.job_name }}{% endraw %}"
          description: |
            Test failures have been detected in build logs
            - Team: {% raw %}{{ $labels.team }}{% endraw %}

            - Job: {% raw %}{{ $labels.job_name }}{% endraw %}

            - Test Failure Count: {% raw %}{{ humanize $value }}{% endraw %}


            Review test results and fix failing tests
          loki_query: "{job=\"jenkins-job-logs\", team=\"{% raw %}{{ $labels.team }}{% endraw %}\", job_name=\"{% raw %}{{ $labels.job_name }}{% endraw %}\"} |~ \"test.*fail\""

      - alert: JenkinsDependencyError
        expr: |
          sum(count_over_time({job="jenkins-job-logs"} |~ "(dependency.*error|could not resolve|artifact.*not found|package.*not found)" [10m])) by (team, job_name) > 0
        for: 3m
        labels:
          severity: warning
          alert_type: dependency_error
          team: {% raw %}"{{ $labels.team }}"{% endraw %}

        annotations:
          summary: "Dependency errors detected in {% raw %}{{ $labels.job_name }}{% endraw %}"
          description: |
            Dependency resolution errors detected in build logs
            - Team: {% raw %}{{ $labels.team }}{% endraw %}

            - Job: {% raw %}{{ $labels.job_name }}{% endraw %}

            - Error Count: {% raw %}{{ humanize $value }}{% endraw %}


            Possible causes:
            - Network issues with artifact repositories
            - Missing dependencies in repositories
            - Version conflicts
            - Repository configuration issues
          loki_query: "{job=\"jenkins-job-logs\", team=\"{% raw %}{{ $labels.team }}{% endraw %}\", job_name=\"{% raw %}{{ $labels.job_name }}{% endraw %}\"} |~ \"dependency.*error\""

  - name: jenkins_build_performance
    interval: 5m
    rules:
      # Warning: Long build duration
      - alert: JenkinsBuildDurationHigh
        expr: |
          avg(avg_over_time({job="jenkins-job-logs"} | regexp "Duration: (?:(?P<hours>\\d+) hr )?(?P<minutes>\\d+) min" | unwrap minutes [10m])) by (team, job_name) > 30
        for: 5m
        labels:
          severity: info
          alert_type: performance
          team: {% raw %}"{{ $labels.team }}"{% endraw %}

        annotations:
          summary: "Long build duration detected for {% raw %}{{ $labels.job_name }}{% endraw %}"
          description: |
            Average build duration exceeds 30 minutes
            - Team: {% raw %}{{ $labels.team }}{% endraw %}

            - Job: {% raw %}{{ $labels.job_name }}{% endraw %}

            - Average Duration: {% raw %}{{ humanize $value }}{% endraw %} minutes

            Consider:
            - Optimizing build steps
            - Enabling build caching
            - Using faster build agents
            - Parallelizing build stages
          dashboard_url: "http://{{ grafana_host }}:{{ grafana_port }}/d/jenkins-build-logs/jenkins-build-logs?var-team={% raw %}{{ $labels.team }}{% endraw %}"

      # Warning: Build duration increasing
      - alert: JenkinsBuildDurationIncreasing
        expr: |
          (
            avg(avg_over_time({job="jenkins-job-logs"} | regexp "Duration: (?:(?P<hours>\\d+) hr )?(?P<minutes>\\d+) min" | unwrap minutes [1h])) by (team, job_name)
            -
            avg(avg_over_time({job="jenkins-job-logs"} | regexp "Duration: (?:(?P<hours>\\d+) hr )?(?P<minutes>\\d+) min" | unwrap minutes [24h] offset 24h)) by (team, job_name)
          ) > 5
        for: 30m
        labels:
          severity: info
          alert_type: performance_degradation
          team: {% raw %}"{{ $labels.team }}"{% endraw %}

        annotations:
          summary: "Build duration increasing for {% raw %}{{ $labels.job_name }}{% endraw %}"
          description: |
            Build duration has increased by more than 5 minutes compared to yesterday
            - Team: {% raw %}{{ $labels.team }}{% endraw %}

            - Job: {% raw %}{{ $labels.job_name }}{% endraw %}

            - Duration Increase: {% raw %}{{ humanize $value }}{% endraw %} minutes

            Investigate recent changes that might have affected build performance
          dashboard_url: "http://{{ grafana_host }}:{{ grafana_port }}/d/jenkins-build-logs/jenkins-build-logs?var-team={% raw %}{{ $labels.team }}{% endraw %}"

  - name: jenkins_build_availability
    interval: 1h
    rules:
      # Warning: No recent builds for scheduled jobs
      - alert: JenkinsNoRecentBuilds
        expr: |
          absent_over_time({job="jenkins-job-logs", job_name=~".*scheduled.*|.*nightly.*|.*daily.*"}[1h]) == 1
        for: 1h
        labels:
          severity: warning
          alert_type: availability
          team: {% raw %}"{{ $labels.team }}"{% endraw %}

        annotations:
          summary: "No recent builds for scheduled job {% raw %}{{ $labels.job_name }}{% endraw %}"
          description: |
            Expected periodic builds not detected
            - Team: {% raw %}{{ $labels.team }}{% endraw %}

            - Job: {% raw %}{{ $labels.job_name }}{% endraw %}

            - Last seen: > 1 hour ago

            Possible causes:
            - Cron trigger disabled
            - Jenkins master down
            - Job disabled
            - Build queue stuck
          jenkins_url: "http://{{ jenkins_domain }}:8080/job/{% raw %}{{ $labels.job_name }}{% endraw %}"

      # Critical: No builds at all for any team
      - alert: JenkinsNoBuildActivity
        expr: |
          absent_over_time({job="jenkins-job-logs"}[2h]) == 1
        for: 2h
        labels:
          severity: critical
          alert_type: availability
          team: "all"
        annotations:
          summary: "No Jenkins build activity detected"
          description: |
            No Jenkins build logs have been ingested for the last 2 hours across all teams

            Possible causes:
            - Jenkins masters are down
            - Promtail not scraping logs
            - Loki ingestion issues
            - GlusterFS mount issues

            Action: Check Jenkins health and log pipeline immediately
          dashboard_url: "http://{{ grafana_host }}:{{ grafana_port }}/d/infrastructure-health/infrastructure-health"
          runbook_url: "{{ monitoring_runbook_url | default('#') }}/jenkins-availability"

  - name: jenkins_security_alerts
    interval: 10m
    rules:
      # Critical: Security-related errors
      - alert: JenkinsSecurityError
        expr: |
          sum(count_over_time({job="jenkins-job-logs"} |~ "(security.*error|authentication.*fail|authorization.*fail|access.*denied|permission.*denied)" [10m])) by (team, job_name) > 0
        for: 5m
        labels:
          severity: critical
          alert_type: security
          team: {% raw %}"{{ $labels.team }}"{% endraw %}

        annotations:
          summary: "Security errors detected in {% raw %}{{ $labels.job_name }}{% endraw %}"
          description: |
            Security-related errors detected in build logs
            - Team: {% raw %}{{ $labels.team }}{% endraw %}

            - Job: {% raw %}{{ $labels.job_name }}{% endraw %}

            - Error Count: {% raw %}{{ humanize $value }}{% endraw %}


            Immediate action required:
            - Review build logs for unauthorized access attempts
            - Check Jenkins security settings
            - Verify credentials and permissions
            - Consider security audit
          loki_query: "{job=\"jenkins-job-logs\", team=\"{% raw %}{{ $labels.team }}{% endraw %}\", job_name=\"{% raw %}{{ $labels.job_name }}{% endraw %}\"} |~ \"security.*error\""
          severity_level: "P1"

      # Warning: Credential-related warnings
      - alert: JenkinsCredentialWarning
        expr: |
          sum(count_over_time({job="jenkins-job-logs"} |~ "(credential.*expire|credential.*invalid|token.*expire)" [1h])) by (team, job_name) > 0
        for: 10m
        labels:
          severity: warning
          alert_type: security
          team: {% raw %}"{{ $labels.team }}"{% endraw %}

        annotations:
          summary: "Credential warnings in {% raw %}{{ $labels.job_name }}{% endraw %}"
          description: |
            Credential-related warnings detected
            - Team: {% raw %}{{ $labels.team }}{% endraw %}

            - Job: {% raw %}{{ $labels.job_name }}{% endraw %}


            Action: Review and update credentials before they expire
          loki_query: "{job=\"jenkins-job-logs\", team=\"{% raw %}{{ $labels.team }}{% endraw %}\", job_name=\"{% raw %}{{ $labels.job_name }}{% endraw %}\"} |~ \"credential.*expire\""
