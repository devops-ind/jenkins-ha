---
# Cross-VM Exporters Deployment
# Deploys Node Exporter and Promtail on all VMs for distributed monitoring

- name: Display cross-VM exporters deployment info
  debug:
    msg: |
      ==========================================================
      Cross-VM Exporters Deployment
      ==========================================================
      Deployment type: {{ monitoring_deployment_type }}
      Monitoring VM: {{ groups['monitoring'][0] if groups['monitoring'] is defined else 'N/A' }}
      Jenkins VMs: {{ groups['jenkins_masters'] | join(', ') if groups['jenkins_masters'] is defined else 'N/A' }}
      Deploying: Node Exporter, Promtail on all VMs
      ==========================================================
  tags: ['monitoring', 'cross-vm', 'exporters']

# Deploy Node Exporter on all Jenkins VMs (for separate VM monitoring)
- name: Deploy Node Exporter on Jenkins VMs
  community.docker.docker_container:
    name: node-exporter-{{ deployment_environment | default('local') }}
    image: "prom/node-exporter:{{ node_exporter_version }}"
    state: started
    restart_policy: "{{ monitoring_restart_policy }}"
    network_mode: host  # Use host network for cross-VM communication with Prometheus
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--path.rootfs=/rootfs'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    volumes:
      - '/proc:/host/proc:ro'
      - '/sys:/host/sys:ro'
      - '/:/rootfs:ro'
    user: "{{ monitoring_uid }}:{{ monitoring_gid }}"
  delegate_to: "{{ item }}"
  loop: "{{ groups['jenkins_masters'] }}"
  when:
    - monitoring_deployment_type == 'separate'
    - node_exporter_enabled | default(true)
    - item not in groups['monitoring']
  tags: ['monitoring', 'cross-vm', 'node-exporter']

# Deploy Promtail on all Jenkins VMs (for distributed log collection)
- name: Create Promtail config directory on Jenkins VMs
  file:
    path: "{{ monitoring_home_dir }}/promtail/config"
    state: directory
    owner: "{{ monitoring_user }}"
    group: "{{ monitoring_group }}"
    mode: '0755'
  delegate_to: "{{ item }}"
  loop: "{{ groups['jenkins_masters'] }}"
  become: yes
  when:
    - monitoring_deployment_type == 'separate'
    - promtail_enabled | default(true)
    - item not in groups['monitoring']
  tags: ['monitoring', 'cross-vm', 'promtail']

- name: Deploy Promtail config on Jenkins VMs
  template:
    src: promtail/promtail-config.yml.j2
    dest: "{{ monitoring_home_dir }}/promtail/config/promtail-config.yml"
    owner: "{{ monitoring_user }}"
    group: "{{ monitoring_group }}"
    mode: '0644'
  delegate_to: "{{ item }}"
  loop: "{{ groups['jenkins_masters'] }}"
  become: yes
  when:
    - monitoring_deployment_type == 'separate'
    - promtail_enabled | default(true)
    - item not in groups['monitoring']
  tags: ['monitoring', 'cross-vm', 'promtail']

- name: Deploy Promtail container on Jenkins VMs
  community.docker.docker_container:
    name: "promtail-{{ hostvars[item]['inventory_hostname_short'] }}-{{ deployment_environment | default('local') }}"
    image: "grafana/promtail:{{ promtail_version }}"
    state: started
    restart_policy: "{{ monitoring_restart_policy }}"
    network_mode: host  # Use host network for cross-VM communication with Loki
    volumes:
      - "{{ monitoring_home_dir }}/promtail/config:/etc/promtail"
      - "{{ monitoring_home_dir }}/promtail/data:/promtail"
      - "/var/log:/var/log:ro"
      - "/var/lib/docker/containers:/var/lib/docker/containers:ro"
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
{% if jenkins_teams_config is defined and jenkins_teams_config | length > 0 %}
      # Mount Jenkins Docker volumes for job log collection
{% for team in jenkins_teams_config %}
      - "jenkins-{{ team.team_name }}-blue-home:/jenkins-logs/{{ team.team_name }}/blue:ro"
      - "jenkins-{{ team.team_name }}-green-home:/jenkins-logs/{{ team.team_name }}/green:ro"
{% endfor %}
{% endif %}
    command: ["-config.file=/etc/promtail/promtail-config.yml"]
    user: "{{ monitoring_uid }}:{{ monitoring_gid }}"
  delegate_to: "{{ item }}"
  loop: "{{ groups['jenkins_masters'] }}"
  when:
    - monitoring_deployment_type == 'separate'
    - promtail_enabled | default(true)
    - item not in groups['monitoring']
  tags: ['monitoring', 'cross-vm', 'promtail']

# Update Prometheus scrape configs for cross-VM targets
- name: Add Jenkins VMs to Prometheus node_exporter targets
  set_fact:
    prometheus_cross_vm_targets: >-
      {% set targets = [] %}
      {% for host in groups['jenkins_masters'] %}
        {% if monitoring_use_fqdn and hostvars[host]['host_fqdn'] is defined %}
          {% set _ = targets.append(hostvars[host]['host_fqdn'] + ':' + (node_exporter_port | string)) %}
        {% else %}
          {% set _ = targets.append(hostvars[host]['ansible_default_ipv4']['address'] + ':' + (node_exporter_port | string)) %}
        {% endif %}
      {% endfor %}
      {{ targets }}
  when:
    - monitoring_deployment_type == 'separate'
    - groups['jenkins_masters'] is defined
  tags: ['monitoring', 'cross-vm', 'prometheus']

- name: Display cross-VM exporters deployment summary
  debug:
    msg: |
      ==========================================================
      Cross-VM Exporters Deployment Complete
      ==========================================================
      Node Exporter deployed to: {{ groups['jenkins_masters'] | length if monitoring_deployment_type == 'separate' else 0 }} Jenkins VMs
      Promtail deployed to: {{ groups['jenkins_masters'] | length if monitoring_deployment_type == 'separate' else 0 }} Jenkins VMs
      Prometheus scrape targets: {{ prometheus_cross_vm_targets | default([]) | length }} additional targets

      Verification:
      {% if monitoring_deployment_type == 'separate' %}
      {% for vm in groups['jenkins_masters'] %}
      - Node Exporter on {{ vm }}: http://{% if monitoring_use_fqdn and hostvars[vm]['host_fqdn'] is defined %}{{ hostvars[vm]['host_fqdn'] }}{% else %}{{ hostvars[vm]['ansible_default_ipv4']['address'] }}{% endif %}:{{ node_exporter_port }}/metrics
      - Promtail on {{ vm }}: http://{% if monitoring_use_fqdn and hostvars[vm]['host_fqdn'] is defined %}{{ hostvars[vm]['host_fqdn'] }}{% else %}{{ hostvars[vm]['ansible_default_ipv4']['address'] }}{% endif %}:{{ promtail_port }}/ready
      {% endfor %}
      {% else %}
      - Co-located deployment - cross-VM exporters not deployed
      {% endif %}
      ==========================================================
  tags: ['monitoring', 'cross-vm', 'summary']
