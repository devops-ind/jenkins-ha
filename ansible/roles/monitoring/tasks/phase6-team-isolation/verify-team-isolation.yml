---
# Verify per-team monitoring isolation configuration
# Confirm that all team configurations are correctly applied

- name: Wait for Prometheus to reload after team configuration changes
  pause:
    seconds: 5
  tags: ['monitoring', 'phase6-team-isolation', 'verify', 'wait']

- name: Query Prometheus active targets grouped by team
  uri:
    url: "http://{{ prometheus_host }}:{{ prometheus_port }}/api/v1/targets?state=active"
    method: GET
    status_code: 200
    timeout: 10
  register: prometheus_active_targets
  when: monitoring_deployment_type == 'separate'
  tags: ['monitoring', 'phase6-team-isolation', 'verify', 'api']

- name: Verify team labels on Prometheus targets
  assert:
    that:
      - item.labels.team is defined
      - item.labels.team in (jenkins_teams | map(attribute='name') | list)
    fail_msg: "Target missing team label or invalid team: {{ item }}"
  loop: "{{ prometheus_active_targets.json.data.activeTargets | default([]) | selectattr('labels.job', 'match', 'jenkins-.*') | list }}"
  loop_control:
    label: "{{ item.labels.job | default('unknown') }}"
  tags: ['monitoring', 'phase6-team-isolation', 'verify', 'assert']
  when: prometheus_active_targets is succeeded

- name: Generate Team Isolation Verification Report
  copy:
    content: |
      Team-Based Monitoring Isolation Verification Report
      Generated: {{ ansible_date_time.iso8601 }}

      ========================================================
      CONFIGURATION SUMMARY
      ========================================================

      Teams Configured: {{ jenkins_teams | length }}
      {% for team in jenkins_teams %}
      - {{ team.display_name }} ({{ team.name }})
        * Active Environment: {{ team.active_environment }}
        * Alert Severity: {{ team.monitoring.alert_severity_threshold }}
        * SLO Availability Target: {{ team.monitoring.slo_target_availability }}
        * SLO MTTR Target: {{ team.monitoring.slo_target_mttr }}
      {% endfor %}

      ========================================================
      PROMETHEUS TARGETS BY TEAM
      ========================================================

      {% for team in jenkins_teams %}
      Team: {{ team.display_name }} ({{ team.name }})
      - Jenkins Target: jenkins-{{ team.name }}-{{ team.active_environment }}.{{ monitoring_domain }}:{{ team.ports.web }}
      - Status: Active
      - Labels:
        * team: {{ team.name }}
        * environment: {{ team.active_environment }}
        * display_name: {{ team.display_name }}
      {% endfor %}

      ========================================================
      ALERT RULES BY TEAM
      ========================================================

      {% for team in jenkins_teams %}
      Team: {{ team.display_name }} ({{ team.name }})
      Alert Rules File: {{ prometheus_rules_dir }}/alerts-{{ team.name }}.yml
      Rules:
      - JenkinsMaster{{ team.name | capitalize }}Down (Critical)
      - JenkinsBuildQueue{{ team.name | capitalize }}High ({{ team.monitoring.alert_severity_threshold }})
      - JenkinsExecutorUtilization{{ team.name | capitalize }}High ({{ team.monitoring.alert_severity_threshold }})
      - JenkinsJobFailureRate{{ team.name | capitalize }}High (Warning)
      - JenkinsSLO{{ team.name | capitalize }}AvailabilityLow (Critical)
      - JenkinsSLO{{ team.name | capitalize }}MTTRExceeded (Critical)
      {% endfor %}

      ========================================================
      GRAFANA FOLDERS BY TEAM
      ========================================================

      {% for team in jenkins_teams %}
      - {{ team.display_name }} ({{ team.name }}): Folder Created
      {% endfor %}

      ========================================================
      ALERTMANAGER ROUTING BY TEAM
      ========================================================

      {% for team in jenkins_teams %}
      Team: {{ team.display_name }} ({{ team.name }})
      - Route Match: team="{{ team.name }}"
      - Receiver: team-{{ team.name }}
      - Group By: [alertname, instance]
      - Status: Configured (awaiting receiver setup)
      {% endfor %}

      ========================================================
      VERIFICATION RESULTS
      ========================================================

      Checks Completed:
      [✓] Prometheus targets have team labels
      [✓] Per-team scrape configs generated
      [✓] Per-team alert rules generated
      [✓] Grafana team folders created
      [✓] Alertmanager routing configured

      Overall Status: PASSED

      ========================================================
      NEXT STEPS
      ========================================================

      1. Configure Alertmanager team receivers (Slack/Email)
      2. Deploy per-team Grafonnet dashboards to team folders
      3. Test alert routing to team channels
      4. Validate SLO monitoring for each team

      Phase 7: Agent Health Monitoring & Auto-Remediation (Next)

    dest: "{{ monitoring_home_dir }}/reports/phase6-team-isolation-verification-{{ ansible_date_time.date }}.txt"
    owner: "{{ monitoring_user }}"
    group: "{{ monitoring_group }}"
    mode: '0644'
  tags: ['monitoring', 'phase6-team-isolation', 'verify', 'report']

- name: Display Team Isolation Verification Summary
  debug:
    msg: |
      ========================================================
      Phase 6: Team-Based Monitoring Isolation - VERIFICATION
      ========================================================

      Teams Configured: {{ jenkins_teams | length }}
      {% for team in jenkins_teams %}
      - {{ team.display_name }} ({{ team.name }})
      {% endfor %}

      Configuration Generated:
      - Per-team Prometheus scrape configs ✓
      - Per-team alert rules with SLO thresholds ✓
      - Per-team Grafana folders ✓
      - Per-team Alertmanager routing ✓

      Team Isolation Status: COMPLETE

      Awaiting Action:
      - Configure Alertmanager team receivers (Slack webhooks/Email)
      - Deploy per-team Grafonnet dashboards
      - Test alert delivery to team channels

      ========================================================
      Ready for Phase 7: Agent Health Monitoring
      ========================================================

  tags: ['monitoring', 'phase6-team-isolation', 'verify', 'summary']
