---
# Grafana setup tasks
- name: Create Grafana provisioning directories
  file:
    path: "{{ monitoring_home_dir }}/grafana/provisioning/{{ item }}"
    state: directory
    owner: "{{ monitoring_user }}"
    group: "{{ monitoring_group }}"
    mode: '0755'
  loop:
    - datasources
    - dashboards
    - plugins

- name: Create Grafana plugins directory
  file:
    path: "{{ monitoring_home_dir }}/grafana/plugins"
    state: directory
    owner: "{{ monitoring_user }}"
    group: "{{ monitoring_group }}"
    mode: '0755'

- name: Create Grafana provisioning configuration (core datasources only)
  template:
    src: "{{ item }}.j2"
    dest: "{{ monitoring_home_dir }}/grafana/provisioning/{{ item }}"
    owner: "{{ monitoring_user }}"
    group: "{{ monitoring_group }}"
    mode: '0644'
  loop:
    - datasources/prometheus.yml
    - datasources/loki.yml
    - dashboards/dashboard.yml
    - plugins/plugins.yml
  notify: restart grafana

# Simple JSON Dashboard Deployment (Phase 5.6)
- name: Deploy JSON dashboards
  copy:
    src: "dashboards/json/{{ item }}"
    dest: "{{ monitoring_home_dir }}/grafana/dashboards/{{ item }}"
    owner: "{{ monitoring_user }}"
    group: "{{ monitoring_group }}"
    mode: '0644'
  loop: "{{ grafana_json_dashboards }}"
  notify: restart grafana
  when:
    - grafana_json_enabled | default(false)
    - grafana_json_dashboards is defined
    - grafana_json_dashboards | length > 0

- name: Deploy Grafana container
  community.docker.docker_container:
    name: grafana-{{ deployment_environment | default('local') }}
    image: "grafana/grafana:{{ grafana_version }}"
    state: started
    restart_policy: "{{ monitoring_restart_policy }}"
    ports:
      - "{{ grafana_port }}:3000"
    volumes:
      - "{{ monitoring_home_dir }}/grafana/data:/var/lib/grafana"
      - "{{ monitoring_home_dir }}/grafana/provisioning:/etc/grafana/provisioning"
      - "{{ monitoring_home_dir }}/grafana/dashboards:/var/lib/grafana/dashboards"
      - "{{ monitoring_home_dir }}/grafana/dashboards-generated:/var/lib/grafana/dashboards-generated"
      - "{{ monitoring_home_dir }}/grafana/plugins:/var/lib/grafana/plugins"
    env:
      GF_SECURITY_ADMIN_USER: "{{ grafana_admin_user }}"
      GF_SECURITY_ADMIN_PASSWORD: "{{ grafana_admin_password }}"
      GF_USERS_ALLOW_SIGN_UP: "{{ grafana_allow_sign_up | lower }}"
      GF_USERS_DEFAULT_THEME: "dark"
      GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH: "/var/lib/grafana/dashboards/jenkins-overview.json"
      # Disable features that require SSL connections to grafana.com
      GF_ANALYTICS_CHECK_FOR_UPDATES: "false"
      GF_ANALYTICS_CHECK_FOR_PLUGIN_UPDATES: "false"
      GF_PLUGINS_ALLOW_LOADING_UNSIGNED_PLUGINS: "true"
      # Note: GF_INSTALL_PLUGINS removed - plugins installed post-deployment to avoid SSL issues
    networks:
      - name: "{{ monitoring_docker_network }}"
    user: "{{ monitoring_uid }}:{{ monitoring_gid }}"
  when: grafana_enabled | default(true)

- name: Wait for Grafana to be ready
  uri:
    url: "http://localhost:{{ grafana_port }}/api/health"
    status_code: 200
  register: grafana_health
  until: grafana_health.status == 200
  retries: 30
  delay: 2
  when: grafana_enabled | default(true)

- name: Install GitHub datasource plugin with insecure flag
  community.docker.docker_container_exec:
    container: grafana-{{ deployment_environment | default('local') }}
    command: grafana-cli --insecure plugins install grafana-github-datasource
  register: github_plugin_install
  until: github_plugin_install is not failed
  retries: 10
  delay: 3
  failed_when: false
  changed_when: "'Installed' in github_plugin_install.stdout or 'installed' in github_plugin_install.stdout"
  when: grafana_enabled | default(true)

- name: Install Jira datasource plugin with insecure flag
  community.docker.docker_container_exec:
    container: grafana-{{ deployment_environment | default('local') }}
    command: grafana-cli --insecure plugins install grafana-jira-datasource
  register: jira_plugin_install
  until: jira_plugin_install is not failed
  retries: 10
  delay: 3
  failed_when: false
  changed_when: "'Installed' in jira_plugin_install.stdout or 'installed' in jira_plugin_install.stdout"
  when: grafana_enabled | default(true)

- name: Wait for plugin installation to complete
  pause:
    seconds: 5
  when:
    - grafana_enabled | default(true)
    - (github_plugin_install.changed | default(false)) or (jira_plugin_install.changed | default(false))

- name: Restart Grafana to load plugins
  community.docker.docker_container:
    name: grafana-{{ deployment_environment | default('local') }}
    state: started
    restart: true
  when:
    - grafana_enabled | default(true)
    - (github_plugin_install.changed | default(false)) or (jira_plugin_install.changed | default(false))

- name: Wait for Grafana to be ready after plugin installation
  uri:
    url: "http://localhost:{{ grafana_port }}/api/health"
    status_code: 200
  register: grafana_health_post_plugin
  until: grafana_health_post_plugin.status == 200
  retries: 30
  delay: 2
  when: grafana_enabled | default(true)

- name: Provision GitHub datasource configuration after plugin installation
  template:
    src: datasources/github-datasource.yml.j2
    dest: "{{ monitoring_home_dir }}/grafana/provisioning/datasources/github-datasource.yml"
    owner: "{{ monitoring_user }}"
    group: "{{ monitoring_group }}"
    mode: '0644'
  when: grafana_enabled | default(true)

- name: Provision Jira datasource configuration after plugin installation
  template:
    src: datasources/jira-datasource.yml.j2
    dest: "{{ monitoring_home_dir }}/grafana/provisioning/datasources/jira-datasource.yml"
    owner: "{{ monitoring_user }}"
    group: "{{ monitoring_group }}"
    mode: '0644'
  when: grafana_enabled | default(true)

- name: Restart Grafana to load datasource configurations
  community.docker.docker_container:
    name: grafana-{{ deployment_environment | default('local') }}
    state: started
    restart: true
  when: grafana_enabled | default(true)