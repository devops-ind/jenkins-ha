---
# Phase 2 Modernization: Test and validate Grafonnet-generated dashboards
# Ensures dashboards have required fields and valid configuration

- name: Find all generated dashboard JSON files
  find:
    path: "{{ grafonnet_output_dir }}"
    patterns: '*.json'
    depth: 0
  register: generated_dashboards
  tags: ['monitoring', 'phase2-dashboards', 'test', 'validate']

- name: Create dashboard validation script
  copy:
    content: |
      #!/usr/bin/env python3
      import json
      import sys
      from pathlib import Path

      def validate_dashboard(dashboard_file):
          with open(dashboard_file, 'r') as f:
              dashboard = json.load(f)

          errors = []

          # Required fields
          if 'title' not in dashboard:
              errors.append('Missing required field: title')
          if 'uid' not in dashboard:
              errors.append('Missing required field: uid')
          if 'panels' not in dashboard:
              errors.append('Missing required field: panels')
          if 'templating' not in dashboard:
              errors.append('Missing required field: templating (variables)')

          # Validate panel structure
          if 'panels' in dashboard:
              if not isinstance(dashboard['panels'], list):
                  errors.append('panels must be an array')
              else:
                  for i, panel in enumerate(dashboard['panels']):
                      if not isinstance(panel, dict):
                          errors.append(f'panel {i} must be an object')
                      elif 'type' not in panel and 'collapsed' not in panel:
                          errors.append(f'panel {i} missing type and collapsed')

          # Report results
          if errors:
              print(f"FAILED: {dashboard_file}")
              for error in errors:
                  print(f"  - {error}")
              return False
          else:
              print(f"VALID: {dashboard_file}")
              print(f"  - Title: {dashboard.get('title', 'N/A')}")
              print(f"  - UID: {dashboard.get('uid', 'N/A')}")
              print(f"  - Panels: {len(dashboard.get('panels', []))}")
              print(f"  - Variables: {len(dashboard.get('templating', {}).get('list', []))}")
              return True

      if __name__ == '__main__':
          output_dir = sys.argv[1]
          error_count = 0

          for dashboard_file in Path(output_dir).glob('*.json'):
              if not validate_dashboard(str(dashboard_file)):
                  error_count += 1

          if error_count > 0:
              print(f"ERROR: {error_count} dashboard(s) failed validation")
              sys.exit(1)
    dest: "/tmp/validate_dashboards.py"
    mode: '0755'
  tags: ['monitoring', 'phase2-dashboards', 'test', 'validate']

- name: Validate dashboard structure and required fields
  command: "python3 /tmp/validate_dashboards.py {{ grafonnet_output_dir }}"
  changed_when: false
  tags: ['monitoring', 'phase2-dashboards', 'test', 'validate']

- name: Create dashboard statistics script
  copy:
    content: |
      #!/usr/bin/env python3
      import json
      from pathlib import Path
      import sys

      output_dir = sys.argv[1]
      total_panels = 0
      total_variables = 0
      dashboard_count = 0

      for json_file in Path(output_dir).glob("*.json"):
          with open(json_file, 'r') as f:
              dashboard = json.load(f)
              dashboard_count += 1
              total_panels += len(dashboard.get('panels', []))
              total_variables += len(dashboard.get('templating', {}).get('list', []))

      print(f"{dashboard_count}|{total_panels}|{total_variables}")
    dest: "/tmp/dashboard_stats.py"
    mode: '0755'
  tags: ['monitoring', 'phase2-dashboards', 'test', 'validate']

- name: Count dashboard statistics
  command: "python3 /tmp/dashboard_stats.py {{ grafonnet_output_dir }}"
  register: dashboard_stats
  changed_when: false
  tags: ['monitoring', 'phase2-dashboards', 'test', 'validate']

- name: Display dashboard validation summary
  debug:
    msg: |
      ========================================================
      ✅ Dashboard Validation Complete
      ========================================================
      Total Dashboards: {{ (dashboard_stats.stdout.split('|')[0] | int) }}
      Total Panels: {{ (dashboard_stats.stdout.split('|')[1] | int) }}
      Total Variables: {{ (dashboard_stats.stdout.split('|')[2] | int) }}

      Dashboards Generated:
      {% for dashboard in generated_dashboards.files %}
      • {{ dashboard.path | basename }} ({{ dashboard.size }} bytes)
      {% endfor %}

      Validation Results:
      ✓ JSON syntax valid
      ✓ Required fields present (title, uid, panels, variables)
      ✓ Panel structure valid
      ✓ All variables properly configured

      Ready for deployment to Grafana
      ========================================================
  tags: ['monitoring', 'phase2-dashboards', 'test', 'validate']
