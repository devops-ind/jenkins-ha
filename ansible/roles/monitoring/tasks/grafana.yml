---
# Grafana setup tasks
- name: Create Grafana provisioning configuration
  template:
    src: "{{ item }}.j2"
    dest: "{{ monitoring_home_dir }}/grafana/provisioning/{{ item }}"
    owner: "{{ monitoring_user }}"
    group: "{{ monitoring_group }}"
    mode: '0644'
  loop:
    - datasources/prometheus.yml
    - dashboards/dashboard.yml
  notify: restart grafana

# Generate dynamic dashboard list for deployment
- name: Generate enabled dashboard list
  set_fact:
    enabled_dashboards: |
      [
      {% for dashboard_id, config in grafana_dashboards.items() %}
      {% if config.enabled and ((config.category == 'core' and dashboard_deployment.core_enabled) or (config.category == 'enhanced' and dashboard_deployment.enhanced_enabled)) %}
        {
          "id": "{{ dashboard_id }}",
          "name": "{{ config.template_file }}",
          "title": "{{ config.title }} - {{ deployment_mode | default('local') | title }}",
          "category": "{{ config.category }}",
          "priority": {{ config.priority }}
        },
      {% endif %}
      {% endfor %}
      ]

- name: Parse and sort dashboard list by priority
  set_fact:
    sorted_enabled_dashboards: "{{ enabled_dashboards | from_yaml | sort(attribute='priority') }}"

- name: Validate dashboard template files exist
  stat:
    path: "{{ role_path }}/templates/dashboards/{{ item.name }}.j2"
  register: template_file_check
  loop: "{{ sorted_enabled_dashboards }}"
  loop_control:
    label: "{{ item.id }}"
  failed_when: not template_file_check.stat.exists
  when: dashboard_deployment.validation_strict | default(true)

- name: Deploy Grafana dashboards from centralized configuration
  template:
    src: "dashboards/{{ item.name }}.j2"
    dest: "{{ monitoring_home_dir }}/grafana/dashboards/{{ item.name }}"
    owner: "{{ monitoring_user }}"
    group: "{{ monitoring_group }}"
    mode: '0644'
  loop: "{{ sorted_enabled_dashboards }}"
  loop_control:
    label: "{{ item.id }} ({{ item.category }})"
  notify: restart grafana

- name: Display dashboard deployment summary
  debug:
    msg: |
      ðŸ“Š Dashboard Template Deployment Summary:
      Total Dashboards: {{ sorted_enabled_dashboards | length }}
      Core Dashboards: {{ sorted_enabled_dashboards | selectattr('category', 'equalto', 'core') | list | length }}
      Enhanced Dashboards: {{ sorted_enabled_dashboards | selectattr('category', 'equalto', 'enhanced') | list | length }}
      
      Deployed Dashboards:
      {% for dashboard in sorted_enabled_dashboards %}
      â€¢ {{ dashboard.title }} ({{ dashboard.category }})
      {% endfor %}

- name: Deploy Grafana container
  community.docker.docker_container:
    name: grafana-{{ deployment_environment | default('local') }}
    image: "grafana/grafana:{{ grafana_version }}"
    state: started
    restart_policy: "{{ monitoring_restart_policy }}"
    ports:
      - "{{ grafana_port }}:3000"
    volumes:
      - "{{ monitoring_home_dir }}/grafana/data:/var/lib/grafana"
      - "{{ monitoring_home_dir }}/grafana/provisioning:/etc/grafana/provisioning"
      - "{{ monitoring_home_dir }}/grafana/dashboards:/var/lib/grafana/dashboards"
    env:
      GF_SECURITY_ADMIN_USER: "{{ grafana_admin_user }}"
      GF_SECURITY_ADMIN_PASSWORD: "{{ grafana_admin_password }}"
      GF_USERS_ALLOW_SIGN_UP: "{{ grafana_allow_sign_up | lower }}"
      GF_USERS_DEFAULT_THEME: "dark"
      GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH: "/var/lib/grafana/dashboards/jenkins-overview.json"
    networks:
      - name: "{{ monitoring_docker_network }}"
    user: "{{ monitoring_uid }}:{{ monitoring_gid }}"
  when: grafana_enabled | default(true)