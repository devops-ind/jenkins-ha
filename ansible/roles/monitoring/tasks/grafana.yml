---
# Grafana setup tasks
- name: Create Grafana provisioning configuration
  template:
    src: "{{ item }}.j2"
    dest: "{{ monitoring_home_dir }}/grafana/provisioning/{{ item }}"
    owner: "{{ monitoring_user }}"
    group: "{{ monitoring_group }}"
    mode: '0644'
  loop:
    - datasources/prometheus.yml
    - dashboards/dashboard.yml
  notify: restart grafana

- name: Deploy core Grafana dashboards
  template:
    src: "dashboards/{{ item }}.j2"
    dest: "{{ monitoring_home_dir }}/grafana/dashboards/{{ item }}"
    owner: "{{ monitoring_user }}"
    group: "{{ monitoring_group }}"
    mode: '0644'
  loop:
    - jenkins-overview.json
    - jenkins-builds.json
    - jenkins-dynamic-agents.json
    - infrastructure-health.json
    - security-metrics.json
  notify: restart grafana

- name: Deploy enhanced Jenkins dashboards
  template:
    src: "dashboards/{{ item.name }}.j2"
    dest: "{{ monitoring_home_dir }}/grafana/dashboards/{{ item.name }}"
    owner: "{{ monitoring_user }}"
    group: "{{ monitoring_group }}"
    mode: '0644'
  loop:
    - name: jenkins-performance-health.json
      config: "{{ jenkins_dashboard_config.performance_health }}"
    - name: jenkins-build-statistics.json
      config: "{{ jenkins_dashboard_config.build_statistics }}"
    - name: jenkins-advanced-overview.json
      config: "{{ jenkins_dashboard_config.advanced_overview }}"
  when: 
    - jenkins_enhanced_dashboards_enabled | default(true)
    - item.config.enabled | default(true)
  notify: restart grafana

- name: Deploy Grafana container
  community.docker.docker_container:
    name: grafana-{{ deployment_environment | default('local') }}
    image: "grafana/grafana:{{ grafana_version }}"
    state: started
    restart_policy: "{{ monitoring_restart_policy }}"
    ports:
      - "{{ grafana_port }}:3000"
    volumes:
      - "{{ monitoring_home_dir }}/grafana/data:/var/lib/grafana"
      - "{{ monitoring_home_dir }}/grafana/provisioning:/etc/grafana/provisioning"
      - "{{ monitoring_home_dir }}/grafana/dashboards:/var/lib/grafana/dashboards"
    env:
      GF_SECURITY_ADMIN_USER: "{{ grafana_admin_user }}"
      GF_SECURITY_ADMIN_PASSWORD: "{{ grafana_admin_password }}"
      GF_USERS_ALLOW_SIGN_UP: "{{ grafana_allow_sign_up | lower }}"
      GF_USERS_DEFAULT_THEME: "dark"
      GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH: "/var/lib/grafana/dashboards/jenkins-overview.json"
    networks:
      - name: "{{ monitoring_docker_network }}"
    user: "{{ monitoring_uid }}:{{ monitoring_gid }}"
  when: grafana_enabled | default(true)