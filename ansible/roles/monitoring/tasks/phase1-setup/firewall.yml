---
# Firewall Configuration for Monitoring Stack
# Configures firewall rules for separate VM deployment

- name: Display firewall configuration info
  debug:
    msg: |
      ==========================================================
      Monitoring Firewall Configuration
      ==========================================================
      Deployment type: {{ monitoring_deployment_type }}
      OS Family: {{ ansible_os_family }}
      Firewall: {{ 'firewalld' if ansible_os_family == 'RedHat' else 'ufw' if ansible_os_family == 'Debian' else 'unknown' }}
      ==========================================================
  tags: ['monitoring', 'firewall']

# FirewallD Configuration (RHEL/CentOS)
- name: Configure firewalld for monitoring services (RHEL/CentOS)
  block:
    - name: Ensure firewalld is installed
      package:
        name: firewalld
        state: present
      become: yes

    - name: Ensure firewalld is running
      service:
        name: firewalld
        state: started
        enabled: yes
      become: yes

    - name: Open Prometheus port
      ansible.posix.firewalld:
        port: "{{ prometheus_port }}/tcp"
        permanent: yes
        immediate: yes
        state: enabled
      become: yes
      when: prometheus_enabled | default(true)

    - name: Open Grafana port
      ansible.posix.firewalld:
        port: "{{ grafana_port }}/tcp"
        permanent: yes
        immediate: yes
        state: enabled
      become: yes
      when: grafana_enabled | default(true)

    - name: Open Node Exporter port
      ansible.posix.firewalld:
        port: "{{ node_exporter_port }}/tcp"
        permanent: yes
        immediate: yes
        state: enabled
      become: yes
      when: node_exporter_enabled | default(true)

    - name: Open cAdvisor port
      ansible.posix.firewalld:
        port: "{{ cadvisor_port }}/tcp"
        permanent: yes
        immediate: yes
        state: enabled
      become: yes
      when: cadvisor_enabled | default(true)

    - name: Open Loki port
      ansible.posix.firewalld:
        port: "{{ loki_port }}/tcp"
        permanent: yes
        immediate: yes
        state: enabled
      become: yes
      when: loki_enabled | default(true)

    - name: Open Promtail port
      ansible.posix.firewalld:
        port: "{{ promtail_port }}/tcp"
        permanent: yes
        immediate: yes
        state: enabled
      become: yes
      when: promtail_enabled | default(true)

    - name: Open Alertmanager port
      ansible.posix.firewalld:
        port: "{{ alertmanager_port }}/tcp"
        permanent: yes
        immediate: yes
        state: enabled
      become: yes
      when: alertmanager_enabled | default(false)

    - name: Reload firewalld
      command: firewall-cmd --reload
      become: yes
      changed_when: false

  when:
    - ansible_os_family == "RedHat"
    - monitoring_deployment_type == 'separate'
  tags: ['monitoring', 'firewall', 'firewalld']

# UFW Configuration (Debian/Ubuntu)
- name: Configure UFW for monitoring services (Debian/Ubuntu)
  block:
    - name: Ensure UFW is installed
      package:
        name: ufw
        state: present
      become: yes

    - name: Allow Prometheus port
      community.general.ufw:
        rule: allow
        port: "{{ prometheus_port }}"
        proto: tcp
        comment: "Prometheus monitoring"
      become: yes
      when: prometheus_enabled | default(true)

    - name: Allow Grafana port
      community.general.ufw:
        rule: allow
        port: "{{ grafana_port }}"
        proto: tcp
        comment: "Grafana dashboards"
      become: yes
      when: grafana_enabled | default(true)

    - name: Allow Node Exporter port
      community.general.ufw:
        rule: allow
        port: "{{ node_exporter_port }}"
        proto: tcp
        comment: "Node Exporter metrics"
      become: yes
      when: node_exporter_enabled | default(true)

    - name: Allow cAdvisor port
      community.general.ufw:
        rule: allow
        port: "{{ cadvisor_port }}"
        proto: tcp
        comment: "cAdvisor container metrics"
      become: yes
      when: cadvisor_enabled | default(true)

    - name: Allow Loki port
      community.general.ufw:
        rule: allow
        port: "{{ loki_port }}"
        proto: tcp
        comment: "Loki log aggregation"
      become: yes
      when: loki_enabled | default(true)

    - name: Allow Promtail port
      community.general.ufw:
        rule: allow
        port: "{{ promtail_port }}"
        proto: tcp
        comment: "Promtail log shipping"
      become: yes
      when: promtail_enabled | default(true)

    - name: Allow Alertmanager port
      community.general.ufw:
        rule: allow
        port: "{{ alertmanager_port }}"
        proto: tcp
        comment: "Alertmanager alerts"
      become: yes
      when: alertmanager_enabled | default(false)

    - name: Enable UFW
      community.general.ufw:
        state: enabled
      become: yes

  when:
    - ansible_os_family == "Debian"
    - monitoring_deployment_type == 'separate'
  tags: ['monitoring', 'firewall', 'ufw']

# Verification
- name: Verify firewall rules
  block:
    - name: Check firewalld rules (RHEL/CentOS)
      command: firewall-cmd --list-all
      register: firewalld_rules
      become: yes
      changed_when: false
      when: ansible_os_family == "RedHat"

    - name: Check UFW rules (Debian/Ubuntu)
      command: ufw status verbose
      register: ufw_rules
      become: yes
      changed_when: false
      when: ansible_os_family == "Debian"

    - name: Display firewall rules
      debug:
        msg: |
          ==========================================================
          Firewall Rules Verification
          ==========================================================
          {{ firewalld_rules.stdout if ansible_os_family == 'RedHat' else ufw_rules.stdout if ansible_os_family == 'Debian' else 'Firewall not configured' }}
          ==========================================================
  when: monitoring_deployment_type == 'separate'
  tags: ['monitoring', 'firewall', 'verify']

- name: Display firewall configuration summary
  debug:
    msg: |
      ==========================================================
      Firewall Configuration Complete
      ==========================================================
      {% if monitoring_deployment_type == 'separate' %}
      Opened ports:
      - Prometheus: {{ prometheus_port }}/tcp
      - Grafana: {{ grafana_port }}/tcp
      - Node Exporter: {{ node_exporter_port }}/tcp
      - cAdvisor: {{ cadvisor_port }}/tcp
      - Loki: {{ loki_port }}/tcp
      - Promtail: {{ promtail_port }}/tcp
      {% if alertmanager_enabled %}
      - Alertmanager: {{ alertmanager_port }}/tcp
      {% endif %}

      Access URLs:
      - Grafana: http://{{ ansible_default_ipv4.address }}:{{ grafana_port }}
      - Prometheus: http://{{ ansible_default_ipv4.address }}:{{ prometheus_port }}
      - Loki: http://{{ ansible_default_ipv4.address }}:{{ loki_port }}
      {% else %}
      Co-located deployment - firewall rules not modified
      {% endif %}
      ==========================================================
  tags: ['monitoring', 'firewall', 'summary']
