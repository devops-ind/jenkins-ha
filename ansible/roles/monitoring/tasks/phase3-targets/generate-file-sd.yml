---
# Phase 1 Modernization: File-Based Prometheus Service Discovery
# Generates JSON target files for dynamic target management
# Enables zero-downtime target updates via Prometheus HTTP reload

- name: Create Prometheus file-sd targets directory
  file:
    path: "{{ monitoring_home_dir }}/prometheus/targets.d"
    state: directory
    owner: "{{ monitoring_user }}"
    group: "{{ monitoring_group }}"
    mode: '0755'
  when: inventory_hostname == monitoring_server_host
  tags: ['monitoring', 'phase1-file-sd', 'targets']

- name: Create Prometheus targets backup directory
  file:
    path: "{{ monitoring_home_dir }}/prometheus/targets.d/.backups"
    state: directory
    owner: "{{ monitoring_user }}"
    group: "{{ monitoring_group }}"
    mode: '0755'
  when: inventory_hostname == monitoring_server_host
  tags: ['monitoring', 'phase1-file-sd', 'targets']

- name: Validate team configuration for file-sd targets
  set_fact:
    prometheus_teams_validated: "{{ jenkins_teams if (jenkins_teams is defined and jenkins_teams is iterable and jenkins_teams is not string and jenkins_teams | length > 0) else [] }}"
  when: inventory_hostname == monitoring_server_host
  tags: ['monitoring', 'phase1-file-sd', 'phase3-targets', 'targets']

- name: Generate Jenkins team targets for BOTH blue and green environments in file-sd format
  copy:
    content: |
      [
      {% for host in monitoring_jenkins_hosts %}
      {% for env in ['blue', 'green'] %}
      {% set env_port = team_web_port if env == 'blue' else (team_web_port | int + 100) %}
        {
          "targets": ["{% if monitoring_use_fqdn and hostvars[host]['host_fqdn'] is defined %}{{ hostvars[host]['host_fqdn'] }}{% else %}{{ hostvars[host]['ansible_default_ipv4']['address'] }}{% endif %}:{{ env_port }}"],
          "labels": {
            "job": "jenkins-{{ team.team_name }}",
            "team": "{{ team.team_name }}",
            "environment": "{{ env }}",
            "active_environment": "{{ team_active_env }}",
            "is_active": "{{ 'true' if env == team_active_env else 'false' }}",
            "deployment_mode": "{{ deployment_mode | default('local') }}",
            "blue_green_enabled": "{{ team_bg_enabled }}"
          }
        }{% if not (loop.last and loop.index0 == 1) %},{% endif %}
      {% endfor %}
      {% endfor %}
      ]
    dest: "{{ monitoring_home_dir }}/prometheus/targets.d/jenkins-{{ team.team_name }}.json"
    owner: "{{ monitoring_user }}"
    group: "{{ monitoring_group }}"
    mode: '0644'
  vars:
    monitoring_jenkins_hosts: "{{ groups['jenkins_masters'] | default(['localhost']) }}"
    team_web_port: "{{ team.ports.web | default(8080) | int }}"
    team_active_env: "{{ team.active_environment | default('blue') }}"
    team_bg_enabled: "{{ team.blue_green_enabled | default(true) }}"
  loop: "{{ prometheus_teams_validated }}"
  loop_control:
    loop_var: team
    label: "jenkins-{{ team.team_name }}.json (both blue and green)"
  when:
    - inventory_hostname == monitoring_server_host
    - prometheus_teams_validated | length > 0
  notify: reload prometheus
  tags: ['monitoring', 'phase1-file-sd', 'targets']

- name: Generate default Jenkins target in file-sd format (fallback)
  copy:
    content: |
      [
      {% for host in monitoring_jenkins_hosts %}
        {
          "targets": ["{% if monitoring_use_fqdn and hostvars[host]['host_fqdn'] is defined %}{{ hostvars[host]['host_fqdn'] }}{% else %}{{ hostvars[host]['ansible_default_ipv4']['address'] }}{% endif %}:8080"],
          "labels": {
            "job": "jenkins-default",
            "team": "default",
            "environment": "blue",
            "deployment_mode": "{{ deployment_mode | default('local') }}",
            "blue_green_enabled": "false"
          }
        }{% if not loop.last %},{% endif %}
      {% endfor %}
      ]
    dest: "{{ monitoring_home_dir }}/prometheus/targets.d/jenkins-default.json"
    owner: "{{ monitoring_user }}"
    group: "{{ monitoring_group }}"
    mode: '0644'
  vars:
    monitoring_jenkins_hosts: "{{ groups['jenkins_masters'] | default(['localhost']) }}"
  when:
    - inventory_hostname == monitoring_server_host
    - prometheus_teams_validated | length == 0
  notify: reload prometheus
  tags: ['monitoring', 'phase1-file-sd', 'targets']

- name: Generate node-exporter targets in file-sd format
  copy:
    content: |
      [
      {% if prometheus_node_exporter_targets is defined and prometheus_node_exporter_targets | length > 0 %}
      {% for target in prometheus_node_exporter_targets %}
        {
          "targets": ["{{ target }}"],
          "labels": {
            "job": "node-exporter",
            "role": "system-metrics"
          }
        }{% if not loop.last %},{% endif %}
      {% endfor %}
      {% else %}
        {
          "targets": ["{{ monitoring_server_address }}:{{ node_exporter_port }}"],
          "labels": {
            "job": "node-exporter",
            "role": "system-metrics"
          }
        }
      {% endif %}
      ]
    dest: "{{ monitoring_home_dir }}/prometheus/targets.d/node-exporter.json"
    owner: "{{ monitoring_user }}"
    group: "{{ monitoring_group }}"
    mode: '0644'
  when: inventory_hostname == monitoring_server_host
  notify: reload prometheus
  tags: ['monitoring', 'phase1-file-sd', 'targets']

- name: Generate cAdvisor targets in file-sd format
  copy:
    content: |
      [
        {
          "targets": ["{{ monitoring_server_address }}:{{ cadvisor_port }}"],
          "labels": {
            "job": "cadvisor",
            "role": "container-metrics"
          }
        }{% if monitoring_deployment_type == 'separate' and prometheus_cadvisor_targets is defined and prometheus_cadvisor_targets | length > 0 %},
      {% for target in prometheus_cadvisor_targets %}
        {
          "targets": ["{{ target }}"],
          "labels": {
            "job": "cadvisor",
            "role": "jenkins-vm",
            "deployment_type": "cross-vm"
          }
        }{% if not loop.last %},{% endif %}
      {% endfor %}
      {% endif %}
      ]
    dest: "{{ monitoring_home_dir }}/prometheus/targets.d/cadvisor.json"
    owner: "{{ monitoring_user }}"
    group: "{{ monitoring_group }}"
    mode: '0644'
  when:
    - inventory_hostname == monitoring_server_host
    - cadvisor_enabled | default(true)
  notify: reload prometheus
  tags: ['monitoring', 'phase1-file-sd', 'targets']

- name: Generate Loki targets in file-sd format
  copy:
    content: |
      [
        {
          "targets": ["{{ monitoring_server_address }}:{{ loki_port }}"],
          "labels": {
            "job": "loki",
            "role": "log-aggregation"
          }
        }
      ]
    dest: "{{ monitoring_home_dir }}/prometheus/targets.d/loki.json"
    owner: "{{ monitoring_user }}"
    group: "{{ monitoring_group }}"
    mode: '0644'
  when:
    - inventory_hostname == monitoring_server_host
    - loki_enabled | default(true)
  notify: reload prometheus
  tags: ['monitoring', 'phase1-file-sd', 'targets']

- name: Generate Promtail targets in file-sd format
  copy:
    content: |
      [
      {% if prometheus_promtail_targets is defined and prometheus_promtail_targets | length > 0 %}
      {% for target in prometheus_promtail_targets %}
        {
          "targets": ["{{ target }}"],
          "labels": {
            "job": "promtail",
            "role": "log-processor"
          }
        }{% if not loop.last %},{% endif %}
      {% endfor %}
      {% else %}
        {
          "targets": ["{{ monitoring_server_address }}:{{ promtail_port }}"],
          "labels": {
            "job": "promtail",
            "role": "log-processor"
          }
        }
      {% endif %}
      ]
    dest: "{{ monitoring_home_dir }}/prometheus/targets.d/promtail.json"
    owner: "{{ monitoring_user }}"
    group: "{{ monitoring_group }}"
    mode: '0644'
  when:
    - inventory_hostname == monitoring_server_host
    - promtail_enabled | default(true)
  notify: reload prometheus
  tags: ['monitoring', 'phase1-file-sd', 'targets']

- name: Generate Grafana targets in file-sd format
  copy:
    content: |
      [
        {
          "targets": ["{{ monitoring_server_address }}:{{ grafana_port }}"],
          "labels": {
            "job": "grafana",
            "role": "visualization"
          }
        }
      ]
    dest: "{{ monitoring_home_dir }}/prometheus/targets.d/grafana.json"
    owner: "{{ monitoring_user }}"
    group: "{{ monitoring_group }}"
    mode: '0644'
  when:
    - inventory_hostname == monitoring_server_host
    - grafana_enabled | default(true)
  notify: reload prometheus
  tags: ['monitoring', 'phase1-file-sd', 'targets']

- name: Backup existing target files (rotation management)
  shell: |
    if [ -f "{{ monitoring_home_dir }}/prometheus/targets.d/jenkins-*.json" ]; then
      BACKUP_DATE=$(date +%Y%m%d_%H%M%S)
      for file in {{ monitoring_home_dir }}/prometheus/targets.d/jenkins-*.json \
                  {{ monitoring_home_dir }}/prometheus/targets.d/node-exporter.json \
                  {{ monitoring_home_dir }}/prometheus/targets.d/cadvisor.json \
                  {{ monitoring_home_dir }}/prometheus/targets.d/loki.json \
                  {{ monitoring_home_dir }}/prometheus/targets.d/promtail.json \
                  {{ monitoring_home_dir }}/prometheus/targets.d/grafana.json; do
        if [ -f "$file" ]; then
          mkdir -p "{{ monitoring_home_dir }}/prometheus/targets.d/.backups"
          cp "$file" "{{ monitoring_home_dir }}/prometheus/targets.d/.backups/$(basename $file)-${BACKUP_DATE}"
        fi
      done

      # Keep only last N versions
      find "{{ monitoring_home_dir }}/prometheus/targets.d/.backups" -type f -name "*.json-*" | \
        sort -r | tail -n +{{ prometheus_targets_backup_versions | default(10) + 1 }} | xargs -r rm
    fi
  args:
    executable: /bin/bash
  when: inventory_hostname == monitoring_server_host
  changed_when: false
  tags: ['monitoring', 'phase1-file-sd', 'targets', 'backup']

- name: Validate generated targets contain BOTH blue and green environments with is_active labels
  shell: |
    set -e
    VALIDATION_PASSED=true
    VALIDATION_ERRORS=""

    {% for team in prometheus_teams_validated %}
    {% set team_active_env = team.active_environment | default('blue') %}
    {% set team_web_port = team.ports.web | default(8080) %}
    {% set blue_port = team_web_port %}
    {% set green_port = team_web_port | int + 100 %}

    # Validate team {{ team.team_name }}: active={{ team_active_env }}
    TARGET_FILE="{{ monitoring_home_dir }}/prometheus/targets.d/jenkins-{{ team.team_name }}.json"
    if [ -f "$TARGET_FILE" ]; then
      # Check for BOTH blue and green environment ports
      if ! grep -q ":{{ blue_port }}" "$TARGET_FILE"; then
        VALIDATION_PASSED=false
        VALIDATION_ERRORS="${VALIDATION_ERRORS}\n‚ùå Team {{ team.team_name }}: Missing blue environment port {{ blue_port }}"
      fi

      if ! grep -q ":{{ green_port }}" "$TARGET_FILE"; then
        VALIDATION_PASSED=false
        VALIDATION_ERRORS="${VALIDATION_ERRORS}\n‚ùå Team {{ team.team_name }}: Missing green environment port {{ green_port }}"
      fi

      # Verify BOTH environment labels present
      if ! grep -q "\"environment\": \"blue\"" "$TARGET_FILE"; then
        VALIDATION_PASSED=false
        VALIDATION_ERRORS="${VALIDATION_ERRORS}\n‚ùå Team {{ team.team_name }}: Missing blue environment label"
      fi

      if ! grep -q "\"environment\": \"green\"" "$TARGET_FILE"; then
        VALIDATION_PASSED=false
        VALIDATION_ERRORS="${VALIDATION_ERRORS}\n‚ùå Team {{ team.team_name }}: Missing green environment label"
      fi

      # Verify active_environment label matches team configuration
      if ! grep -q "\"active_environment\": \"{{ team_active_env }}\"" "$TARGET_FILE"; then
        VALIDATION_PASSED=false
        VALIDATION_ERRORS="${VALIDATION_ERRORS}\n‚ùå Team {{ team.team_name }}: active_environment label mismatch (expected {{ team_active_env }})"
      fi

      # Verify is_active labels (one true, one false)
      ACTIVE_COUNT=$(grep -c "\"is_active\": \"true\"" "$TARGET_FILE" || true)
      PASSIVE_COUNT=$(grep -c "\"is_active\": \"false\"" "$TARGET_FILE" || true)

      if [ "$ACTIVE_COUNT" -ne 1 ]; then
        VALIDATION_PASSED=false
        VALIDATION_ERRORS="${VALIDATION_ERRORS}\n‚ùå Team {{ team.team_name }}: Expected 1 active target, found $ACTIVE_COUNT"
      fi

      if [ "$PASSIVE_COUNT" -ne 1 ]; then
        VALIDATION_PASSED=false
        VALIDATION_ERRORS="${VALIDATION_ERRORS}\n‚ùå Team {{ team.team_name }}: Expected 1 passive target, found $PASSIVE_COUNT"
      fi
    else
      VALIDATION_PASSED=false
      VALIDATION_ERRORS="${VALIDATION_ERRORS}\n‚ùå Team {{ team.team_name }}: Target file not found"
    fi
    {% endfor %}

    if [ "$VALIDATION_PASSED" = "true" ]; then
      echo "‚úÖ Validation PASSED: All targets contain both blue and green environments with correct is_active labels"
      exit 0
    else
      echo "‚ùå Validation FAILED: Issues detected in generated targets"
      echo -e "$VALIDATION_ERRORS"
      exit 1
    fi
  args:
    executable: /bin/bash
  when:
    - inventory_hostname == monitoring_server_host
    - prometheus_teams_validated | length > 0
  register: validation_result
  failed_when: validation_result.rc != 0
  tags: ['monitoring', 'phase1-file-sd', 'targets', 'validation']

- name: Display validation results
  debug:
    msg: "{{ validation_result.stdout_lines }}"
  when:
    - inventory_hostname == monitoring_server_host
    - prometheus_teams_validated | length > 0
    - validation_result.stdout_lines is defined
  tags: ['monitoring', 'phase1-file-sd', 'targets', 'validation']

- name: Display file-sd target generation summary
  debug:
    msg: |
      ========================================================
      ‚úÖ File-Based Service Discovery Targets Generated
      ========================================================
      Location: {{ monitoring_home_dir }}/prometheus/targets.d/

      Generated Target Files:
      {% for team in prometheus_teams_validated %}
      ‚Ä¢ jenkins-{{ team.team_name }}.json (BOTH blue and green environments)
      {% endfor %}
      {% if prometheus_teams_validated | length == 0 %}
      ‚Ä¢ jenkins-default.json
      {% endif %}
      ‚Ä¢ node-exporter.json
      {% if cadvisor_enabled | default(true) %}
      ‚Ä¢ cadvisor.json
      {% endif %}
      {% if loki_enabled | default(true) %}
      ‚Ä¢ loki.json
      {% endif %}
      {% if promtail_enabled | default(true) %}
      ‚Ä¢ promtail.json
      {% endif %}
      {% if grafana_enabled | default(true) %}
      ‚Ä¢ grafana.json
      {% endif %}

      üéØ Both-Environment Monitoring Strategy:
      {% for team in prometheus_teams_validated %}
      {% set team_web_port = team.ports.web | default(8080) %}
      {% set team_active_env = team.active_environment | default('blue') %}
      {% set team_passive_env = 'green' if team_active_env == 'blue' else 'blue' %}
      {% set blue_port = team_web_port %}
      {% set green_port = team_web_port | int + 100 %}
      ‚Ä¢ {{ team.team_name }}:
        - Active: {{ team_active_env }} (port {% if team_active_env == 'blue' %}{{ blue_port }}{% else %}{{ green_port }}{% endif %}) ‚Üê Critical alerts
        - Passive: {{ team_passive_env }} (port {% if team_passive_env == 'blue' %}{{ blue_port }}{% else %}{{ green_port }}{% endif %}) ‚Üê Info alerts only
      {% endfor %}

      ‚úÖ BOTH blue and green environments monitored for complete visibility
      ‚úÖ Critical alerts ONLY for active environment (is_active="true")
      ‚úÖ Informational alerts for passive environment issues
      ‚úÖ Pre-switch validation enabled: verify passive health before switching
      ‚úÖ Zero false alerts: passive environment monitored but alerts suppressed

      Benefits:
      ‚Ä¢ Complete infrastructure visibility (no blind spots)
      ‚Ä¢ Safe blue-green switches with pre-validation
      ‚Ä¢ Faster incident response with full context
      ‚Ä¢ Better troubleshooting with metrics from both environments
      ‚Ä¢ Continuous metrics history across environment switches

      Backup Retention: {{ prometheus_targets_backup_versions | default(10) }} versions
      Backup Location: {{ monitoring_home_dir }}/prometheus/targets.d/.backups/

      Next Step: Prometheus will reload configuration to use file_sd_configs
      ========================================================
  when: inventory_hostname == monitoring_server_host
  tags: ['monitoring', 'phase1-file-sd', 'targets']
