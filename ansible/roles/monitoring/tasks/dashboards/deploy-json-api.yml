---
# Deploy dashboards via Grafana HTTP API (no restart required)
- name: Wait for Grafana to be ready
  uri:
    url: "http://{{ monitoring_host | default(ansible_default_ipv4.address) }}:{{ grafana_port }}/api/health"
    method: GET
    status_code: 200
  register: grafana_health
  until: grafana_health.status == 200
  retries: 30
  delay: 5
  ignore_errors: yes

- name: Deploy JSON dashboards via API
  uri:
    url: "http://{{ monitoring_host | default(ansible_default_ipv4.address) }}:{{ grafana_port }}/api/dashboards/db"
    method: POST
    user: "{{ grafana_admin_user }}"
    password: "{{ grafana_admin_password }}"
    body_format: json
    body:
      dashboard: "{{ lookup('file', 'dashboards/json/' + item) | from_json }}"
      overwrite: true
      message: "Deployed via Ansible API"
    status_code: 200
    force_basic_auth: yes
  loop: "{{ grafana_json_dashboards }}"
  when:
    - grafana_health.status == 200
    - grafana_json_dashboards is defined
    - grafana_json_dashboards | length > 0
  register: dashboard_api_result
  ignore_errors: yes

- name: Display API deployment results
  debug:
    msg: "Dashboard {{ item.item }} deployment: {{ 'SUCCESS' if item.status == 200 else 'FAILED' }}"
  loop: "{{ dashboard_api_result.results }}"
  when: dashboard_api_result is defined and dashboard_api_result.results is defined
