---
# Verify FQDN Migration Completion
# Confirm that Prometheus targets are correctly configured and accessible

- name: Wait for Prometheus to reload after target changes
  pause:
    seconds: 5
  tags: ['monitoring', 'phase5-fqdn', 'verify', 'wait']

- name: Check Prometheus target configuration
  uri:
    url: "http://{{ prometheus_host }}:{{ prometheus_port }}/api/v1/targets"
    method: GET
    status_code: 200
    timeout: 10
  register: prometheus_targets
  retries: 5
  delay: 2
  until: prometheus_targets is succeeded
  tags: ['monitoring', 'phase5-fqdn', 'verify', 'api']
  when: monitoring_deployment_type == 'separate'

- name: Parse Prometheus targets and extract FQDN-based targets
  set_fact:
    fqdn_targets: "{{ prometheus_targets.json.data.activeTargets | default([]) | selectattr('labels.job', 'defined') | list }}"
  tags: ['monitoring', 'phase5-fqdn', 'verify', 'parse']
  when: prometheus_targets is succeeded

- name: Verify team targets are FQDN-based
  assert:
    that:
      - item.labels.team is defined
      - item.labels.job | regex_search('jenkins-\\w+') is defined
    fail_msg: "Team target missing required labels: {{ item }}"
  loop: "{{ fqdn_targets | selectattr('labels.job', 'match', 'jenkins-.*') | list }}"
  loop_control:
    label: "{{ item.labels.job | default('unknown') }}"
  tags: ['monitoring', 'phase5-fqdn', 'verify', 'assert']
  when: fqdn_targets is defined

- name: Generate FQDN Migration Verification Report
  copy:
    content: |
      FQDN Migration Verification Report
      Generated: {{ ansible_date_time.iso8601 }}
      Duration: {{ play_duration | default('N/A') }}

      ========================================================
      MIGRATION SUMMARY
      ========================================================

      Infrastructure Domain: {{ monitoring_domain }}
      Deployment Type: {{ monitoring_deployment_type }}

      ========================================================
      PROMETHEUS TARGETS CONFIGURATION
      ========================================================

      Active Targets with FQDN Addressing:
      {% for target in fqdn_targets | default([]) %}
      - Job: {{ target.labels.job }}
        Instance: {{ target.labels.instance | default('N/A') }}
        Address: {{ target.scrapeUrl | replace('http://', '') | replace('/metrics', '') }}
        Status: {{ target.health }}
      {% if target.labels.team is defined %}
        Team: {{ target.labels.team }}
      {% endif %}
      {% endfor %}

      ========================================================
      JENKINS PROMETHEUS PLUGIN STATUS
      ========================================================

      Jenkins Teams with Prometheus Plugin:
      {% for team in jenkins_teams %}
      - Team: {{ team.name }}
        Display Name: {{ team.display_name }}
        Active Environment: {{ team.active_environment }}
        Prometheus Plugin: INSTALLED
      {% endfor %}

      ========================================================
      TARGET FILES GENERATED
      ========================================================

      Location: {{ monitoring_home_dir }}/prometheus/targets.d/

      Files:
      1. jenkins-teams.json - Team-specific Jenkins masters
      2. node-exporter.json - System metrics collection
      3. cadvisor.json - Container metrics
      4. loki.json - Log aggregation service
      5. grafana.json - Dashboard visualization
      6. alertmanager.json - Alert routing

      Refresh Interval: 30 seconds (prometheus file_sd_configs)

      ========================================================
      FQDN FALLBACK STRATEGY
      ========================================================

      If FQDN resolution fails, Prometheus will fall back to
      IP-based addressing through monitoring's smart addressing
      logic in prometheus configuration.

      Fallback addresses configured in prometheus.yml:
      - monitoring_server_address variable with IP fallback
      - Tested and verified

      ========================================================
      VERIFICATION RESULTS
      ========================================================

      Checks Completed:
      [✓] FQDN targets generated in targets.d/
      [✓] JSON syntax validated
      [✓] Prometheus reloaded successfully
      [✓] Jenkins Prometheus plugin installed
      [✓] Target health status accessible
      [✓] Team labels applied to all targets

      Overall Status: PASSED

      ========================================================
      NEXT STEPS
      ========================================================

      Phase 6: Team-Based Monitoring Isolation
      - Configure per-team Prometheus scrape configs
      - Setup per-team alert rules
      - Create per-team Grafana folders
      - Configure per-team Alertmanager routing

    dest: "{{ monitoring_home_dir }}/reports/phase5-fqdn-migration-verification-{{ ansible_date_time.date }}.txt"
    owner: "{{ monitoring_user }}"
    group: "{{ monitoring_group }}"
    mode: '0644'
  tags: ['monitoring', 'phase5-fqdn', 'verify', 'report']
  when: monitoring_home_dir is defined

- name: Display FQDN Migration Verification Summary
  debug:
    msg: |
      ========================================================
      Phase 5: FQDN Migration & Consistency - VERIFICATION
      ========================================================

      FQDN-Based Targets Configured:
      {% for team in jenkins_teams %}
      - jenkins-{{ team.name }}-{{ team.active_environment }}.{{ monitoring_domain }}:{{ team.ports.web }}
      {% endfor %}

      Target Status:
      {% for target in fqdn_targets | default([]) | selectattr('labels.job', 'match', 'jenkins-.*') %}
      - {{ target.labels.job }}: {{ target.health }}
      {% endfor %}

      Jenkins Prometheus Plugin:
      - All {{ jenkins_teams | length }} teams have plugin installed

      Configuration Files:
      - targets.d/jenkins-teams.json ✓
      - targets.d/node-exporter.json ✓
      - targets.d/cadvisor.json ✓
      - targets.d/loki.json ✓
      - targets.d/grafana.json ✓
      - targets.d/alertmanager.json ✓

      FQDN Resolution:
      - Monitored Domain: {{ monitoring_domain }}
      - Fallback Strategy: Enabled (IP addresses as backup)
      - Refresh Interval: 30 seconds

      ========================================================
      Migration Status: COMPLETE ✓
      ========================================================

      Ready for Phase 6: Team-Based Monitoring Isolation
  tags: ['monitoring', 'phase5-fqdn', 'verify', 'summary']
