---
# Monitoring Role - Prometheus, Grafana, and Exporters
# Complete monitoring stack for Jenkins infrastructure

# ==============================================================================
# ROBUST PROMETHEUS TARGET GENERATION - Split Complex Template into Safe Tasks
# ==============================================================================
# Applying successful patterns from haproxy.cfg.j2 and jenkins-master-v2 roles:
# 1. Pre-assignment with {% set team_ports = team.ports | default({'web': 8080}) %}
# 2. Type safety with | int filter before arithmetic
# 3. String concatenation with | string filter
# 4. Defensive programming with multiple validation layers
# 5. Split complex logic into multiple safer set_fact tasks

- name: Initialize Prometheus target configuration
  set_fact:
    prometheus_jenkins_targets: []
    prometheus_deployment_mode: "{{ deployment_mode | default('local') }}"
    prometheus_jenkins_hosts: "{{ groups['jenkins_masters'] | default(['localhost']) }}"
  tags: ['monitoring', 'targets']

- name: Validate team configuration for monitoring
  set_fact:
    prometheus_teams_validated: >
      {%- if jenkins_teams is defined and jenkins_teams is iterable and jenkins_teams is not string and jenkins_teams | length > 0 -%}
      {{ jenkins_teams }}
      {%- else -%}
      []
      {%- endif -%}
  tags: ['monitoring', 'targets']

# Split the complex logic into safer, more explicit tasks
- name: Calculate effective ports for each team (separate task for clarity)
  set_fact:
    team_port_calculations: "{{ team_port_calculations | default({}) | combine({item.team_name: calculated_port}) }}"
  vars:
    team_web_port: "{{ item.ports.web | default(8080) | int }}"
    team_active_env: "{{ item.active_environment | default('blue') }}"
    team_bg_enabled: "{{ item.blue_green_enabled | default(true) }}"
    calculated_port: "{{ team_web_port | int + (100 if (team_bg_enabled and team_active_env == 'green') else 0) }}"
  loop: "{{ prometheus_teams_validated }}"
  loop_control:
    label: "{{ item.team_name }}"
  when: prometheus_teams_validated | length > 0
  tags: ['monitoring', 'targets']

- name: Generate team-specific Jenkins Prometheus targets (safe approach)
  set_fact:
    prometheus_jenkins_targets: "{{ prometheus_jenkins_targets + [team_target_config] }}"
  vars:
    team_effective_port: "{{ team_port_calculations[item.team_name] }}"
    team_target_list: >
      {%- if prometheus_deployment_mode == 'local' -%}
      ["localhost:{{ team_effective_port }}"] 
      {%- else -%}
      [{% for host in prometheus_jenkins_hosts %}"{{ hostvars[host]['ansible_default_ipv4']['address'] }}:{{ team_effective_port }}"{% if not loop.last %}, {% endif %}{% endfor %}]
      {%- endif -%}
    team_target_config:
      job: "jenkins-{{ item.team_name }}"
      targets: "{{ team_target_list | from_yaml }}"
      team_name: "{{ item.team_name }}"
      active_environment: "{{ item.active_environment | default('blue') }}"
      port: "{{ team_effective_port | int }}"
      blue_green_enabled: "{{ item.blue_green_enabled | default(true) }}"
  loop: "{{ prometheus_teams_validated }}"
  loop_control:
    label: "{{ item.team_name }}"
  when: prometheus_teams_validated | length > 0
  tags: ['monitoring', 'targets']

- name: Generate default Jenkins Prometheus target (fallback - safe approach)
  set_fact:
    prometheus_jenkins_targets: "{{ prometheus_jenkins_targets + [default_target_config] }}"
  vars:
    default_target_list: >
      {%- if prometheus_deployment_mode == 'local' -%}
      ["localhost:8080"]
      {%- else -%}
      [{% for host in prometheus_jenkins_hosts %}"{{ hostvars[host]['ansible_default_ipv4']['address'] }}:8080"{% if not loop.last %}, {% endif %}{% endfor %}]
      {%- endif -%}
    default_target_config:
      job: "jenkins-default"
      targets: "{{ default_target_list | from_yaml }}"
      team_name: "default"
      active_environment: "blue"
      port: 8080
      blue_green_enabled: false
  when: prometheus_teams_validated | length == 0
  tags: ['monitoring', 'targets']

- name: Merge Jenkins targets with base Prometheus targets
  set_fact:
    prometheus_targets: "{{ prometheus_base_targets | default([]) + prometheus_jenkins_targets }}"
  tags: ['monitoring', 'targets']

- name: Validate final Prometheus configuration
  assert:
    that:
      - prometheus_jenkins_targets is defined
      - prometheus_jenkins_targets | length > 0
      - prometheus_targets is defined
      - prometheus_targets | length > 0
    fail_msg: |
      ERROR: Prometheus target generation failed!
      
      Teams validated: {{ prometheus_teams_validated | length }}
      Jenkins targets generated: {{ prometheus_jenkins_targets | length }}
      Total targets: {{ prometheus_targets | length }}
      
      This indicates a configuration or template processing error.
    success_msg: |
      ‚úÖ Prometheus target generation successful!
      
      Teams configured: {{ prometheus_teams_validated | length }}
      Jenkins targets: {{ prometheus_jenkins_targets | length }}
      Total targets: {{ prometheus_targets | length }}
  tags: ['monitoring', 'targets']

- name: Display monitoring target configuration
  debug:
    msg: |
      ====================================================
      üéØ Monitoring Target Configuration Summary
      ====================================================
      Deployment Mode: {{ prometheus_deployment_mode }}
      Teams Validated: {{ prometheus_teams_validated | length }}
      Jenkins Jobs Generated: {{ prometheus_jenkins_targets | map(attribute='job') | join(', ') if prometheus_jenkins_targets else 'none' }}
      Total Prometheus Targets: {{ prometheus_targets | length }}
      
      üìä Jenkins Monitoring Details:
      {% for target in prometheus_jenkins_targets %}
      ‚Ä¢ {{ target.job }} ({{ target.team_name }} - {{ target.active_environment }})
        Port: {{ target.port }} | Blue-Green: {{ target.blue_green_enabled }}
        Targets: {{ target.targets | join(', ') }}
      {% endfor %}
      
      üåê All Prometheus Targets:
      {% for target in prometheus_targets %}
      ‚Ä¢ {{ target.job }}: {{ target.targets | join(', ') }}
      {% endfor %}
      ====================================================
  tags: ['monitoring', 'targets']

- name: Create monitoring user and group
  group:
    name: "{{ monitoring_group }}"
    gid: "{{ monitoring_gid }}"
    state: present
  become: yes
  when: deployment_mode | default('local') not in ['devcontainer', 'local']

- name: Create monitoring system user
  user:
    name: "{{ monitoring_user }}"
    uid: "{{ monitoring_uid }}"
    group: "{{ monitoring_group }}"
    home: "{{ monitoring_home_dir }}"
    shell: /bin/bash
    system: yes
    create_home: yes
  become: yes
  when: deployment_mode | default('local') not in ['devcontainer', 'local']

- name: Create monitoring directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ monitoring_user if deployment_mode | default('local') not in ['devcontainer', 'local'] else omit }}"
    group: "{{ monitoring_group if deployment_mode | default('local') not in ['devcontainer', 'local'] else omit }}"
    mode: '0755'
  loop: "{{ monitoring_directories }}"
  become: "{{ deployment_mode | default('local') not in ['devcontainer', 'local'] }}"

- name: Create monitoring network
  community.docker.docker_network:
    name: "{{ monitoring_network_name }}"
    driver: bridge
    ipam_config:
      - subnet: "{{ monitoring_network_subnet }}"

- name: Include Prometheus setup tasks
  include_tasks: prometheus.yml
  tags: ['prometheus']

- name: Include Grafana setup tasks
  include_tasks: grafana.yml
  tags: ['grafana']

- name: Include Alertmanager setup tasks
  include_tasks: alertmanager.yml
  tags: ['alertmanager']
  when: alertmanager_enabled | default(true)

- name: Include Exporters setup tasks
  include_tasks: exporters.yml
  tags: ['exporters']

- name: Generate monitoring stack systemd services
  template:
    src: "{{ item }}.service.j2"
    dest: "/etc/systemd/system/{{ item }}.service"
    owner: root
    group: root
    mode: '0644'
  loop:
    - prometheus
    - grafana
    - alertmanager
    - node-exporter
  notify: reload systemd
  become: yes

- name: Force systemd to reload configs
  systemd:
    daemon_reload: yes
  become: yes

- name: Enable and start monitoring services
  systemd:
    name: "{{ item }}"
    enabled: yes
    state: started
  loop:
    - prometheus
    - grafana
    - alertmanager
    - node-exporter
  become: yes

- name: Wait for Prometheus to be ready
  uri:
    url: "http://{{ ansible_default_ipv4.address }}:{{ prometheus_port }}/api/v1/status/config"
    method: GET
    timeout: 10
  register: prometheus_ready
  until: prometheus_ready is succeeded
  retries: 30
  delay: 10

- name: Wait for Grafana to be ready
  uri:
    url: "http://{{ ansible_default_ipv4.address }}:{{ grafana_port }}/api/health"
    method: GET
    timeout: 10
  register: grafana_ready
  until: grafana_ready is succeeded
  retries: 30
  delay: 10

- name: Configure Grafana datasources
  uri:
    url: "http://{{ ansible_default_ipv4.address }}:{{ grafana_port }}/api/datasources"
    method: POST
    user: "{{ grafana_admin_user }}"
    password: "{{ grafana_admin_password }}"
    force_basic_auth: yes
    body_format: json
    body: "{{ grafana_prometheus_datasource }}"
    status_code: [200, 409]  # 409 if datasource already exists

- name: Import Grafana dashboards
  uri:
    url: "http://{{ ansible_default_ipv4.address }}:{{ grafana_port }}/api/dashboards/db"
    method: POST
    user: "{{ grafana_admin_user }}"
    password: "{{ grafana_admin_password }}"
    force_basic_auth: yes
    body_format: json
    body: "{{ lookup('file', playbook_dir + '/../' + item) | from_json }}"
    status_code: [200, 412]  # 412 if dashboard already exists
  loop:
    - "monitoring/grafana/dashboards/jenkins-overview.json"
    - "monitoring/grafana/dashboards/jenkins-comprehensive.json"
    - "monitoring/grafana/dashboards/jenkins-blue-green.json"
  ignore_errors: yes  # Don't fail deployment if dashboard import fails

- name: Create monitoring bin directory
  file:
    path: "{{ monitoring_home_dir }}/bin"
    state: directory
    owner: "{{ monitoring_user }}"
    group: "{{ monitoring_group }}"
    mode: '0755'
  become: yes

- name: Create monitoring health check script
  template:
    src: monitoring-health.sh.j2
    dest: "{{ monitoring_home_dir }}/bin/monitoring-health.sh"
    owner: "{{ monitoring_user }}"
    group: "{{ monitoring_group }}"
    mode: '0755'
  become: yes

- name: Setup monitoring health check cron job
  cron:
    name: "Monitoring stack health check"
    minute: "*/5"
    user: "{{ monitoring_user }}"
    job: "{{ monitoring_home_dir }}/bin/monitoring-health.sh"
    state: present

- name: Display monitoring access information
  debug:
    msg: |
      üéâ Monitoring Stack Deployment Completed!
      
      üìä Access Information:
      Prometheus: http://{{ ansible_default_ipv4.address }}:{{ prometheus_port }}
      Grafana: http://{{ ansible_default_ipv4.address }}:{{ grafana_port }}
      AlertManager: http://{{ ansible_default_ipv4.address }}:{{ alertmanager_port }}
      
      üîê Grafana Credentials:
      Username: {{ grafana_admin_user }}
      Password: [Check vault for grafana_admin_password]
      
      üìã Available Dashboards:
      ‚Ä¢ Jenkins Overview - General Jenkins metrics
      ‚Ä¢ Jenkins Builds - Build performance and trends  
      ‚Ä¢ Infrastructure Health - VM and container metrics
      ‚Ä¢ Security Metrics - Security events and compliance
      
      üéØ Monitored Targets ({{ prometheus_targets | length }}):
      {% for target in prometheus_targets %}
      ‚Ä¢ {{ target.job }}: {{ target.targets | join(', ') }}
      {% endfor %}
      
      üîç Jenkins-Specific Monitoring:
      {% for target in prometheus_jenkins_targets %}
      ‚Ä¢ {{ target.team_name }} ({{ target.active_environment }}): {{ target.targets | join(', ') }}
      {% endfor %}