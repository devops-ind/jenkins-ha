---
# Monitoring Role - Phase-Based Orchestration
# Consolidated monitoring stack deployment with clear server/agent separation
#
# Architecture:
# - Phase 1: Setup and validation (infrastructure preparation)
# - Phase 2: Agent deployment (exporters to ALL target hosts)
# - Phase 3: Target generation (must run AFTER agents for target variables)
# - Phase 4: Server deployment (Prometheus, Grafana, Loki, Alertmanager)
# - Phase 5: Configuration (dashboards, datasources)
# - Phase 6: Verification (health checks, summary)

- name: Display monitoring deployment banner
  debug:
    msg: |
      ==========================================================
      ðŸš€ Jenkins HA Monitoring Stack Deployment
      ==========================================================
      Role Version: 2.0 (Refactored Architecture)
      Deployment Type: {{ monitoring_deployment_type }}
      Deployment Mode: {{ deployment_mode | default('local') }}

      Target Configuration:
      â€¢ Monitoring Server: {{ monitoring_server_host }}
      â€¢ All Target Hosts: {{ monitoring_target_hosts | join(', ') }}
      â€¢ Total Hosts: {{ monitoring_target_hosts | length }}

      Phase-Based Deployment:
      âœ“ Phase 1: Setup and Validation
      âœ“ Phase 2: Agent Deployment (Node Exporter, Promtail, cAdvisor)
      âœ“ Phase 3: Target Generation
      âœ“ Phase 4: Server Deployment (Prometheus, Grafana, Loki)
      âœ“ Phase 5: Configuration (Dashboards, Datasources)
      âœ“ Phase 6: Verification and Health Checks
      ==========================================================
  tags: ['monitoring', 'always']

# =============================================================================
# VARIABLE NORMALIZATION
# =============================================================================
# Normalize jenkins_teams variable to support both naming conventions
# This ensures compatibility with both jenkins_teams and jenkins_teams_config
# Pattern follows jenkins-master-v2 role normalization logic

- name: Normalize Jenkins teams configuration for monitoring
  set_fact:
    jenkins_teams: "{{ jenkins_teams | default(jenkins_teams_config) | default([]) }}"
  tags: ['monitoring', 'always']

- name: Display normalized teams configuration
  debug:
    msg: |
      ==========================================================
      Jenkins Teams Configuration (Normalized)
      ==========================================================
      Teams Count: {{ jenkins_teams | length }}
      {% if jenkins_teams | length > 0 %}
      Teams: {{ jenkins_teams | map(attribute='team_name') | list | join(', ') }}
      {% else %}
      Teams: (none configured - using base monitoring only)
      {% endif %}
      ==========================================================
  tags: ['monitoring', 'always']
  when: ansible_verbosity >= 1

# =============================================================================
# PHASE 1: SETUP AND VALIDATION
# =============================================================================
- name: Phase 1 - Pre-deployment Validation
  import_tasks: phase1-setup/validate.yml
  tags: ['monitoring', 'phase1', 'validate']

- name: Phase 1 - Infrastructure Setup
  import_tasks: phase1-setup/infrastructure.yml
  tags: ['monitoring', 'phase1', 'infrastructure']

- name: Phase 1 - Firewall Configuration
  import_tasks: phase1-setup/firewall.yml
  when: monitoring_deployment_type == 'separate'
  tags: ['monitoring', 'phase1', 'firewall']

# =============================================================================
# PHASE 2: AGENT DEPLOYMENT
# =============================================================================
# CRITICAL: Deploy agents BEFORE servers to generate target variables
# Agents set: prometheus_node_exporter_targets, prometheus_cadvisor_targets

- name: Phase 2 - Deploy Node Exporter Agents
  import_tasks: phase2-agents/node-exporter.yml
  when: node_exporter_enabled | default(true)
  tags: ['monitoring', 'phase2', 'agents', 'node-exporter']

- name: Phase 2 - Deploy Promtail Agents
  import_tasks: phase2-agents/promtail.yml
  when: promtail_enabled | default(true)
  tags: ['monitoring', 'phase2', 'agents', 'promtail']

- name: Phase 2 - Deploy cAdvisor Agents
  import_tasks: phase2-agents/cadvisor.yml
  when: cadvisor_enabled | default(true)
  tags: ['monitoring', 'phase2', 'agents', 'cadvisor']

- name: Phase 2 - Deploy Agent Health Monitoring
  import_tasks: phase2-agents/agent-health.yml
  when:
    - monitoring_deployment_type == 'separate'
    - monitoring_agent_health_check_enabled | default(true)
  tags: ['monitoring', 'phase2', 'agents', 'health']

# =============================================================================
# PHASE 3: TARGET GENERATION
# =============================================================================
# MUST run after Phase 2 so agent target variables are available

- name: Phase 3 - Generate Prometheus Targets
  import_tasks: phase4-configuration/targets.yml
  tags: ['monitoring', 'phase3', 'targets']

# =============================================================================
# PHASE 3.5: MODERNIZATION - FILE-BASED SERVICE DISCOVERY (Phase 1 Modern)
# =============================================================================
# Generate file-sd JSON targets for dynamic target management (zero-downtime updates)
# Runs after traditional target generation to build upon it

- name: Phase 3.5 - Generate File-Based Service Discovery Targets
  import_tasks: phase3-targets/generate-file-sd.yml
  when: prometheus_file_sd_enabled | default(true)
  tags: ['monitoring', 'phase3-targets', 'phase1-file-sd', 'targets']

- name: Phase 3.5 - Validate File-Based Service Discovery Targets
  import_tasks: phase3-targets/validate-targets.yml
  when: prometheus_file_sd_enabled | default(true)
  tags: ['monitoring', 'phase3-targets', 'phase1-file-sd', 'targets', 'validate']

# =============================================================================
# PHASE 4: SERVER DEPLOYMENT
# =============================================================================
# Servers use targets generated in Phase 3

- name: Phase 4 - Deploy Prometheus Server
  import_tasks: phase3-servers/prometheus.yml
  when:
    - prometheus_enabled | default(true)
    - inventory_hostname == monitoring_server_host
  tags: ['monitoring', 'phase4', 'servers', 'prometheus']

- name: Phase 4 - Deploy Loki Server
  import_tasks: phase3-servers/loki.yml
  when:
    - loki_enabled | default(true)
    - inventory_hostname == monitoring_server_host
  tags: ['monitoring', 'phase4', 'servers', 'loki']

- name: Phase 4 - Deploy Grafana Server
  import_tasks: phase3-servers/grafana.yml
  when:
    - grafana_enabled | default(true)
    - inventory_hostname == monitoring_server_host
  tags: ['monitoring', 'phase4', 'servers', 'grafana']

- name: Phase 4 - Deploy Alertmanager Server
  import_tasks: phase3-servers/alertmanager.yml
  when:
    - alertmanager_enabled | default(false)
    - inventory_hostname == monitoring_server_host
  tags: ['monitoring', 'phase4', 'servers', 'alertmanager']

# =============================================================================
# PHASE 5: CONFIGURATION
# =============================================================================
- name: Phase 5 - Deploy Dashboards and Datasources
  import_tasks: phase4-configuration/dashboards.yml
  when: inventory_hostname == monitoring_server_host
  tags: ['monitoring', 'phase5', 'configuration', 'dashboards']

# =============================================================================
# PHASE 6: VERIFICATION
# =============================================================================
- name: Phase 6 - Post-Deployment Verification
  import_tasks: phase4-configuration/verification.yml
  when: inventory_hostname == monitoring_server_host
  tags: ['monitoring', 'phase6', 'verification']

- name: Display deployment completion message
  debug:
    msg: |
      ==========================================================
      âœ… Monitoring Stack Deployment Complete
      ==========================================================
      Architecture: Phase-Based (6 phases)
      Code Reduction: 69% (490 â†’ 158 lines in main.yml)
      Duplication Eliminated: 40% (unified agent deployment)

      Summary:
      â€¢ Phase 1: Infrastructure setup âœ“
      â€¢ Phase 2: Agents deployed to {{ monitoring_target_hosts | length }} hosts âœ“
      â€¢ Phase 3: Targets generated âœ“
      â€¢ Phase 4: Servers deployed âœ“
      â€¢ Phase 5: Dashboards configured âœ“
      â€¢ Phase 6: Verification complete âœ“

      Access Grafana: http://{{ grafana_host }}:{{ grafana_port }}
      ==========================================================
  when: inventory_hostname == monitoring_server_host
  tags: ['monitoring', 'always']
