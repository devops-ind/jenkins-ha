---
# Dashboard Deployment
# Configures Grafana datasources and deploys dashboards via API

- name: Wait for Prometheus to be ready
  uri:
    url: "http://{{ prometheus_host }}:{{ prometheus_port }}/api/v1/status/config"
    method: GET
    timeout: 10
  register: prometheus_ready
  until: prometheus_ready is succeeded
  retries: 30
  delay: 10
  tags: ['monitoring', 'dashboards', 'verify']

- name: Wait for Grafana to be ready
  uri:
    url: "http://{{ grafana_host }}:{{ grafana_port }}/api/health"
    method: GET
    timeout: 10
  register: grafana_ready
  until: grafana_ready is succeeded
  retries: 30
  delay: 10
  tags: ['monitoring', 'dashboards', 'verify']

- name: Configure Grafana Prometheus datasource
  uri:
    url: "http://{{ grafana_host }}:{{ grafana_port }}/api/datasources"
    method: POST
    user: "{{ grafana_admin_user }}"
    password: "{{ grafana_admin_password }}"
    force_basic_auth: yes
    body_format: json
    body: "{{ grafana_prometheus_datasource }}"
    status_code: [200, 409]  # 409 if datasource already exists
  tags: ['monitoring', 'dashboards', 'datasources']

- name: Configure Grafana Loki datasource
  uri:
    url: "http://{{ grafana_host }}:{{ grafana_port }}/api/datasources"
    method: POST
    user: "{{ grafana_admin_user }}"
    password: "{{ grafana_admin_password }}"
    force_basic_auth: yes
    body_format: json
    body: "{{ loki_datasource }}"
    status_code: [200, 409]  # 409 if datasource already exists
  when: loki_enabled | default(true)
  tags: ['monitoring', 'dashboards', 'datasources']

# Generate dashboard list for API operations (using centralized config)
- name: Generate API dashboard list from centralized configuration
  set_fact:
    api_dashboard_list: |
      [
      {% for dashboard_id, config in grafana_dashboards.items() %}
      {% if config.enabled and ((config.category == 'core' and dashboard_deployment.core_enabled) or (config.category == 'enhanced' and dashboard_deployment.enhanced_enabled)) %}
        {
          "name": "{{ dashboard_id }}",
          "title": "{{ config.title }} - {{ deployment_mode | default('local') | title }}",
          "template_file": "{{ config.template_file }}"
        },
      {% endif %}
      {% endfor %}
      ]
  tags: ['monitoring', 'dashboards']

- name: Parse API dashboard list
  set_fact:
    sorted_api_dashboards: "{{ api_dashboard_list | from_yaml | sort(attribute='name') }}"
  tags: ['monitoring', 'dashboards']

- name: Display centralized dashboard configuration summary
  debug:
    msg: |
      ğŸ›ï¸ Centralized Dashboard Configuration:
      Total Configured: {{ grafana_dashboards | length }}
      Core Category: {{ grafana_dashboards | dict2items | selectattr('value.category', 'equalto', 'core') | list | length }}
      Enhanced Category: {{ grafana_dashboards | dict2items | selectattr('value.category', 'equalto', 'enhanced') | list | length }}
      Enabled for Deployment: {{ sorted_api_dashboards | length }}

      Configuration Status:
      â€¢ Core Enabled: {{ dashboard_deployment.core_enabled }}
      â€¢ Enhanced Enabled: {{ dashboard_deployment.enhanced_enabled }}
      â€¢ Update Mode: {{ dashboard_deployment.update_mode }}
      â€¢ Validation: {{ 'Strict' if dashboard_deployment.validation_strict else 'Permissive' }}
  tags: ['monitoring', 'dashboards', 'config']

- name: Check for existing dashboards to prevent duplication
  uri:
    url: "http://{{ grafana_host }}:{{ grafana_port }}/api/search?query={{ item.title | urlencode }}"
    method: GET
    user: "{{ grafana_admin_user }}"
    password: "{{ grafana_admin_password }}"
    force_basic_auth: yes
  register: dashboard_search_results
  loop: "{{ sorted_api_dashboards }}"
  loop_control:
    label: "{{ item.name }}"
  ignore_errors: yes
  tags: ['monitoring', 'dashboards']

- name: Read dashboard files for API deployment
  slurp:
    src: "{{ monitoring_home_dir }}/grafana/dashboards/{{ item.template_file }}"
  register: dashboard_content
  loop: "{{ sorted_api_dashboards }}"
  loop_control:
    label: "{{ item.name }}"
  tags: ['monitoring', 'dashboards']

- name: Validate dashboard JSON structure before API deployment
  assert:
    that:
      - dashboard_json is defined
      - dashboard_json.dashboard is defined
      - dashboard_json.dashboard.title is defined
      - dashboard_json.dashboard.title | length > 0
    fail_msg: "Dashboard {{ item.name }} has invalid JSON structure - missing title or dashboard key"
    success_msg: "Dashboard {{ item.name }} JSON structure is valid"
  loop: "{{ sorted_api_dashboards }}"
  vars:
    dashboard_json: "{{ (dashboard_content.results | selectattr('item.name', 'equalto', item.name) | first).content | b64decode | from_json }}"
  loop_control:
    label: "{{ item.name }}"
  tags: ['monitoring', 'dashboards', 'validation']

- name: Deploy/Update Grafana dashboards with overwrite protection
  uri:
    url: "http://{{ grafana_host }}:{{ grafana_port }}/api/dashboards/db"
    method: POST
    user: "{{ grafana_admin_user }}"
    password: "{{ grafana_admin_password }}"
    force_basic_auth: yes
    body_format: json
    body:
      dashboard: "{{ (dashboard_content.results | selectattr('item.name', 'equalto', item.name) | first).content | b64decode | from_json | json_query('dashboard') }}"
      overwrite: true
      folderId: 0
      message: "Updated by Ansible - {{ deployment_mode | default('local') }} deployment"
    status_code: [200, 412]
  register: dashboard_deploy_result
  failed_when: >-
    dashboard_deploy_result.status|default(0) not in [200, 412] or
    (dashboard_deploy_result.json.message|default('') is search('title cannot be empty'))
  loop: "{{ sorted_api_dashboards }}"
  vars:
    existing_dashboard: "{{ dashboard_search_results.results[loop_index0].json | length > 0 }}"
    dashboard_json: "{{ (dashboard_content.results | selectattr('item.name', 'equalto', item.name) | first).content | b64decode | from_json }}"
  when: >
    dashboard_deployment.update_mode == 'always' or
    (dashboard_deployment.update_mode == 'skip_existing' and not existing_dashboard) or
    (dashboard_deployment.update_mode == 'update_only' and existing_dashboard)
  loop_control:
    label: "{{ item.name }}"
  tags: ['monitoring', 'dashboards', 'deploy']

- name: Display dashboard deployment summary
  debug:
    msg: |
      ğŸ“Š Dashboard API Deployment Summary:
      Update Mode: {{ dashboard_deployment.update_mode }}
      Total Dashboards: {{ sorted_api_dashboards | length }}

      {% for dashboard in dashboard_search_results.results %}
      {% set dashboard_item = (dashboard_deploy_result.results[loop.index0] | default({})).item | default({}) %}
      {% set existed = dashboard.json | length > 0 %}
      {% set deployed = (dashboard_deploy_result.results[loop.index0] | default({})).status | default(0) == 200 %}
      â€¢ {{ dashboard_item.name | default('unknown') }}: {% if deployed %}âœ… {{ 'Updated' if existed else 'Created' }}{% elif existed and dashboard_deployment.update_mode == 'skip_existing' %}â­ï¸ Skipped (exists){% elif not existed and dashboard_deployment.update_mode == 'update_only' %}â­ï¸ Skipped (not found){% else %}âŒ Failed{% endif %}
      {% endfor %}
  when: dashboard_search_results is defined and dashboard_deploy_result is defined
  tags: ['monitoring', 'dashboards', 'summary']
