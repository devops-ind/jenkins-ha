---
# Cross-VM cAdvisor Deployment
# Deploys cAdvisor on Jenkins VMs for container-level metrics collection

- name: Display cAdvisor cross-VM deployment info
  debug:
    msg: |
      ==========================================================
      cAdvisor Cross-VM Deployment
      ==========================================================
      Deployment type: {{ monitoring_deployment_type }}
      Target Jenkins VMs: {{ groups['jenkins_masters'] | join(', ') if groups['jenkins_masters'] is defined else 'N/A' }}
      cAdvisor port: {{ cadvisor_port }}
      cAdvisor enabled: {{ cadvisor_enabled | default(true) }}
      ==========================================================
  tags: ['monitoring', 'cross-vm', 'cadvisor']

- name: Check for existing cAdvisor containers on Jenkins VMs
  community.docker.docker_container_info:
    name: cadvisor-{{ deployment_environment | default('local') }}
  register: cadvisor_container_info
  delegate_to: "{{ item }}"
  loop: "{{ groups['jenkins_masters'] }}"
  failed_when: false
  when:
    - monitoring_deployment_type == 'separate'
    - cadvisor_enabled | default(true)
    - item not in groups['monitoring']
  tags: ['monitoring', 'cross-vm', 'cadvisor', 'check']

- name: Deploy cAdvisor container on Jenkins VMs
  community.docker.docker_container:
    name: cadvisor-{{ deployment_environment | default('local') }}
    image: "gcr.io/cadvisor/cadvisor:{{ cadvisor_version }}"
    state: started
    restart_policy: "{{ monitoring_restart_policy }}"
    privileged: yes  # Required for cAdvisor to access system info
    network_mode: host  # Use host network for cross-VM communication with Prometheus
    volumes:
      - "/:/rootfs:ro"
      - "/var/run:/var/run:ro"
      - "/sys:/sys:ro"
      - "/var/lib/docker/:/var/lib/docker:ro"
      - "/dev/disk/:/dev/disk:ro"
    command:
      - '--docker_only=true'
      - '--housekeeping_interval=30s'
      - '--disable_metrics=percpu,sched,tcp,udp,disk,diskIO,accelerator,hugetlb,referenced_memory,cpu_topology,resctrl'
      - '--port={{ cadvisor_port }}'  # Explicitly set port for host network mode
    labels:
      monitoring.role: "agent"
      monitoring.type: "cadvisor"
      monitoring.environment: "{{ deployment_environment | default('local') }}"
  delegate_to: "{{ item }}"
  loop: "{{ groups['jenkins_masters'] }}"
  when:
    - monitoring_deployment_type == 'separate'
    - cadvisor_enabled | default(true)
    - item not in groups['monitoring']
  tags: ['monitoring', 'cross-vm', 'cadvisor', 'deploy']

- name: Wait for cAdvisor to be ready on Jenkins VMs
  uri:
    url: "http://{% if monitoring_use_fqdn and hostvars[item]['host_fqdn'] is defined %}{{ hostvars[item]['host_fqdn'] }}{% else %}{{ hostvars[item]['ansible_default_ipv4']['address'] }}{% endif %}:{{ cadvisor_port }}/metrics"
    method: GET
    status_code: 200
    timeout: 10
  register: cadvisor_ready
  until: cadvisor_ready.status == 200
  retries: 10
  delay: 3
  loop: "{{ groups['jenkins_masters'] }}"
  when:
    - monitoring_deployment_type == 'separate'
    - cadvisor_enabled | default(true)
    - item not in groups['monitoring']
  tags: ['monitoring', 'cross-vm', 'cadvisor', 'verify']

- name: Update Prometheus scrape targets for cross-VM cAdvisor
  set_fact:
    prometheus_cadvisor_targets: >-
      {% set targets = [] %}
      {% for host in groups['jenkins_masters'] %}
        {% if monitoring_use_fqdn and hostvars[host]['host_fqdn'] is defined %}
          {% set _ = targets.append(hostvars[host]['host_fqdn'] + ':' + (cadvisor_port | string)) %}
        {% else %}
          {% set _ = targets.append(hostvars[host]['ansible_default_ipv4']['address'] + ':' + (cadvisor_port | string)) %}
        {% endif %}
      {% endfor %}
      {{ targets }}
  when:
    - monitoring_deployment_type == 'separate'
    - cadvisor_enabled | default(true)
    - groups['jenkins_masters'] is defined
  tags: ['monitoring', 'cross-vm', 'cadvisor', 'targets']

- name: Display cAdvisor cross-VM deployment summary
  debug:
    msg: |
      ==========================================================
      cAdvisor Cross-VM Deployment Complete
      ==========================================================
      {% if monitoring_deployment_type == 'separate' and cadvisor_enabled | default(true) %}
      cAdvisor deployed to: {{ groups['jenkins_masters'] | length }} Jenkins VMs
      Scrape targets:
      {% for vm in groups['jenkins_masters'] %}
      - {% if monitoring_use_fqdn and hostvars[vm]['host_fqdn'] is defined %}{{ hostvars[vm]['host_fqdn'] }}{% else %}{{ hostvars[vm]['ansible_default_ipv4']['address'] }}{% endif %}:{{ cadvisor_port }}/metrics
      {% endfor %}

      Prometheus Query Examples:
      - Container CPU: container_cpu_usage_seconds_total{job="cadvisor"}
      - Container Memory: container_memory_usage_bytes{job="cadvisor"}
      - Container Network: container_network_receive_bytes_total{job="cadvisor"}

      Verification Commands:
      {% for vm in groups['jenkins_masters'] %}
      - curl http://{% if monitoring_use_fqdn and hostvars[vm]['host_fqdn'] is defined %}{{ hostvars[vm]['host_fqdn'] }}{% else %}{{ hostvars[vm]['ansible_default_ipv4']['address'] }}{% endif %}:{{ cadvisor_port }}/metrics
      {% endfor %}
      {% else %}
      Co-located deployment or cAdvisor disabled - no cross-VM deployment performed
      {% endif %}
      ==========================================================
  tags: ['monitoring', 'cross-vm', 'cadvisor', 'summary']
