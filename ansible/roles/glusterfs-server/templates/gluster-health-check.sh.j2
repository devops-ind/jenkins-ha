#!/bin/bash
# GlusterFS Health Check Script
# Generated by Ansible - DO NOT EDIT MANUALLY
# Purpose: Monitor GlusterFS cluster health and report issues

set -euo pipefail

TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
GLUSTER_CMD="/usr/sbin/gluster"

echo "=== GlusterFS Health Check - ${TIMESTAMP} ==="
echo ""

# Check if glusterd service is running
echo "1. Service Status:"
if systemctl is-active --quiet {{ glusterfs_service_name }}; then
    echo "   ✅ GlusterFS service: Running"
    SERVICE_OK=1
else
    echo "   ❌ GlusterFS service: Down"
    SERVICE_OK=0
fi
echo ""

# Check peer status
echo "2. Peer Status:"
PEER_OUTPUT=$($GLUSTER_CMD peer status 2>/dev/null || echo "ERROR")
if [[ "$PEER_OUTPUT" == "ERROR" ]]; then
    echo "   ❌ Cannot get peer status"
    PEER_COUNT=0
else
    PEER_COUNT=$(echo "$PEER_OUTPUT" | grep -c "Peer in Cluster" || echo "0")
    echo "   ✅ Connected peers: $PEER_COUNT"

    # Display peer details
    if [[ $PEER_COUNT -gt 0 ]]; then
        echo "$PEER_OUTPUT" | grep -A 3 "Hostname:" | sed 's/^/      /'
    fi
fi
echo ""

# Check volume status
echo "3. Volume Status:"
VOLUMES=$($GLUSTER_CMD volume list 2>/dev/null || echo "")
if [[ -z "$VOLUMES" ]]; then
    echo "   ⚠️  No volumes found"
else
    VOLUME_COUNT=$(echo "$VOLUMES" | wc -l)
    echo "   Total volumes: $VOLUME_COUNT"
    echo ""

    for VOL in $VOLUMES; do
        echo "   Volume: $VOL"

        # Get volume status
        STATUS=$($GLUSTER_CMD volume info $VOL 2>/dev/null | grep "Status:" | awk '{print $2}' || echo "Unknown")
        if [[ "$STATUS" == "Started" ]]; then
            echo "      ✅ Status: Started"
        else
            echo "      ❌ Status: $STATUS"
        fi

        # Check for split-brain
        SPLIT_BRAIN=$($GLUSTER_CMD volume heal $VOL info split-brain 2>/dev/null | grep -c "in split-brain" || echo "0")
        if [[ $SPLIT_BRAIN -eq 0 ]]; then
            echo "      ✅ Split-brain: None"
        else
            echo "      ⚠️  Split-brain: $SPLIT_BRAIN files affected"
        fi

        # Check heal queue
        HEAL_PENDING=$($GLUSTER_CMD volume heal $VOL info 2>/dev/null | grep "Number of entries:" | awk '{sum+=$4} END {print sum+0}')
        if [[ $HEAL_PENDING -eq 0 ]]; then
            echo "      ✅ Heal queue: Empty"
        else
            echo "      ⚠️  Heal queue: $HEAL_PENDING entries pending"
        fi

        echo ""
    done
fi

# Check disk usage
echo "4. Disk Usage:"
df -h {{ glusterfs_brick_base_path }} 2>/dev/null | tail -n +2 | awk '{printf "   Brick Storage: %s used of %s (%s)\n", $3, $2, $5}'
echo ""

# Check mount points (if this node has mounts)
echo "5. Mount Points:"
MOUNTS=$(df -t fuse.glusterfs 2>/dev/null | tail -n +2 || echo "")
if [[ -z "$MOUNTS" ]]; then
    echo "   No GlusterFS mounts on this node"
else
    echo "$MOUNTS" | awk '{printf "   ✅ %s mounted at %s (%s used)\n", $1, $6, $5}'
fi
echo ""

# Overall health status
echo "=== Overall Health Status ==="
if [[ $SERVICE_OK -eq 1 ]] && [[ $PEER_COUNT -ge {{ (glusterfs_cluster_nodes | default(groups['glusterfs_servers'] | default([])) | length) - 1 }} ]]; then
    echo "✅ HEALTHY - All systems operational"
    EXIT_CODE=0
else
    echo "⚠️  WARNING - Some issues detected"
    EXIT_CODE=1
fi
echo ""
echo "=== Health Check Complete - ${TIMESTAMP} ==="

exit $EXIT_CODE
