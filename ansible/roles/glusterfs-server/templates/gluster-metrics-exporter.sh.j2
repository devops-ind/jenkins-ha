#!/bin/bash
# GlusterFS Prometheus Metrics Exporter
# Generated by Ansible - DO NOT EDIT MANUALLY
# Purpose: Export GlusterFS metrics for Prometheus scraping

set -euo pipefail

METRICS_FILE="{{ glusterfs_metrics_file }}"
METRICS_TMP="${METRICS_FILE}.$$"
GLUSTER_CMD="/usr/sbin/gluster"

# Create metrics output
{
    echo "# HELP glusterfs_service_up GlusterFS service status (1=up, 0=down)"
    echo "# TYPE glusterfs_service_up gauge"
    if systemctl is-active --quiet {{ glusterfs_service_name }}; then
        echo "glusterfs_service_up{node=\"{{ inventory_hostname }}\"} 1"
    else
        echo "glusterfs_service_up{node=\"{{ inventory_hostname }}\"} 0"
    fi

    echo ""
    echo "# HELP glusterfs_peer_count Number of connected peers"
    echo "# TYPE glusterfs_peer_count gauge"
    PEER_COUNT=$($GLUSTER_CMD peer status 2>/dev/null | grep -c "Peer in Cluster" || echo "0")
    echo "glusterfs_peer_count{node=\"{{ inventory_hostname }}\"} $PEER_COUNT"

    echo ""
    echo "# HELP glusterfs_volume_status Volume status (1=Started, 0=Stopped)"
    echo "# TYPE glusterfs_volume_status gauge"

    VOLUMES=$($GLUSTER_CMD volume list 2>/dev/null || echo "")
    if [[ -n "$VOLUMES" ]]; then
        for VOL in $VOLUMES; do
            STATUS=$($GLUSTER_CMD volume info $VOL 2>/dev/null | grep "Status:" | awk '{print $2}' || echo "Unknown")
            VALUE=0
            [[ "$STATUS" == "Started" ]] && VALUE=1
            echo "glusterfs_volume_status{node=\"{{ inventory_hostname }}\",volume=\"$VOL\"} $VALUE"
        done
    fi

    echo ""
    echo "# HELP glusterfs_volume_split_brain_count Number of files in split-brain state"
    echo "# TYPE glusterfs_volume_split_brain_count gauge"

    if [[ -n "$VOLUMES" ]]; then
        for VOL in $VOLUMES; do
            SPLIT_COUNT=$($GLUSTER_CMD volume heal $VOL info split-brain 2>/dev/null | grep -c "in split-brain" || echo "0")
            echo "glusterfs_volume_split_brain_count{node=\"{{ inventory_hostname }}\",volume=\"$VOL\"} $SPLIT_COUNT"
        done
    fi

    echo ""
    echo "# HELP glusterfs_volume_heal_pending Number of entries pending heal"
    echo "# TYPE glusterfs_volume_heal_pending gauge"

    if [[ -n "$VOLUMES" ]]; then
        for VOL in $VOLUMES; do
            HEAL_COUNT=$($GLUSTER_CMD volume heal $VOL info 2>/dev/null | grep "Number of entries:" | awk '{sum+=$4} END {print sum+0}')
            echo "glusterfs_volume_heal_pending{node=\"{{ inventory_hostname }}\",volume=\"$VOL\"} $HEAL_COUNT"
        done
    fi

    echo ""
    echo "# HELP glusterfs_brick_disk_used_bytes Brick disk space used in bytes"
    echo "# TYPE glusterfs_brick_disk_used_bytes gauge"

    BRICK_USAGE=$(df -B1 {{ glusterfs_brick_base_path }} 2>/dev/null | tail -n 1 | awk '{print $3}')
    echo "glusterfs_brick_disk_used_bytes{node=\"{{ inventory_hostname }}\",path=\"{{ glusterfs_brick_base_path }}\"} ${BRICK_USAGE:-0}"

    echo ""
    echo "# HELP glusterfs_brick_disk_total_bytes Brick disk space total in bytes"
    echo "# TYPE glusterfs_brick_disk_total_bytes gauge"

    BRICK_TOTAL=$(df -B1 {{ glusterfs_brick_base_path }} 2>/dev/null | tail -n 1 | awk '{print $2}')
    echo "glusterfs_brick_disk_total_bytes{node=\"{{ inventory_hostname }}\",path=\"{{ glusterfs_brick_base_path }}\"} ${BRICK_TOTAL:-0}"

    echo ""
    echo "# HELP glusterfs_volume_count Total number of volumes"
    echo "# TYPE glusterfs_volume_count gauge"

    VOLUME_COUNT=$(echo "$VOLUMES" | grep -v "^$" | wc -l || echo "0")
    echo "glusterfs_volume_count{node=\"{{ inventory_hostname }}\"} $VOLUME_COUNT"

} > "$METRICS_TMP"

# Atomic move to prevent partial reads
mv "$METRICS_TMP" "$METRICS_FILE"

# Set permissions
chmod 644 "$METRICS_FILE"

exit 0
