#!/bin/bash
# Jenkins Workspace Cleanup Script for GlusterFS Volumes
# Removes workspaces older than configured retention period
# Usage: workspace-cleanup.sh <team_name> <retention_days> [--dry-run]

set -euo pipefail

# Configuration
TEAM_NAME="${1:-}"
RETENTION_DAYS="${2:-{{ glusterfs_workspace_retention_days | default(7) }}}"
DRY_RUN="${3:-}"
WORKSPACE_BASE_PATH="{{ glusterfs_mount_base_path | default('/var/jenkins') }}"
LOG_FILE="/var/log/glusterfs-retention/workspace-cleanup-${TEAM_NAME}.log"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Logging function
log_message() {
    local level="$1"
    shift
    local message="$*"
    echo "$(date '+%Y-%m-%d %H:%M:%S') [$level] $message" | tee -a "$LOG_FILE"
}

# Usage information
usage() {
    cat <<EOF
Jenkins Workspace Cleanup Script for GlusterFS Volumes

Usage:
    $(basename "$0") <team_name> <retention_days> [--dry-run]

Arguments:
    team_name       - Jenkins team name (e.g., devops, ma, ba, tw)
    retention_days  - Delete workspaces older than this many days
    --dry-run       - Show what would be deleted without actually deleting

Examples:
    # Dry-run cleanup for devops team (7 days retention)
    $(basename "$0") devops 7 --dry-run

    # Actual cleanup for ma team (10 days retention)
    $(basename "$0") ma 10

EOF
    exit 1
}

# Validate inputs
if [ -z "$TEAM_NAME" ]; then
    echo -e "${RED}Error: Team name is required${NC}"
    usage
fi

if ! [[ "$RETENTION_DAYS" =~ ^[0-9]+$ ]]; then
    echo -e "${RED}Error: Retention days must be a positive number${NC}"
    usage
fi

# Workspace paths
TEAM_DATA_PATH="${WORKSPACE_BASE_PATH}/${TEAM_NAME}/data"
WORKSPACE_PATH="${TEAM_DATA_PATH}/workspace"

# Validate workspace path exists
if [ ! -d "$WORKSPACE_PATH" ]; then
    log_message "ERROR" "Workspace path does not exist: $WORKSPACE_PATH"
    echo -e "${RED}Error: Workspace path not found: $WORKSPACE_PATH${NC}"
    exit 1
fi

# Start cleanup
log_message "INFO" "=========================================="
log_message "INFO" "Workspace Cleanup Started"
log_message "INFO" "=========================================="
log_message "INFO" "Team: $TEAM_NAME"
log_message "INFO" "Retention: $RETENTION_DAYS days"
log_message "INFO" "Workspace path: $WORKSPACE_PATH"
if [ "$DRY_RUN" == "--dry-run" ]; then
    log_message "INFO" "Mode: DRY-RUN (no actual deletion)"
else
    log_message "INFO" "Mode: LIVE (actual deletion)"
fi
log_message "INFO" "=========================================="

# Calculate statistics before cleanup
TOTAL_WORKSPACES=$(find "$WORKSPACE_PATH" -mindepth 1 -maxdepth 1 -type d 2>/dev/null | wc -l)
TOTAL_SIZE=$(du -sh "$WORKSPACE_PATH" 2>/dev/null | cut -f1)
log_message "INFO" "Current state: $TOTAL_WORKSPACES workspaces, $TOTAL_SIZE total size"

# Find old workspaces (based on modification time)
OLD_WORKSPACES=$(find "$WORKSPACE_PATH" -mindepth 1 -maxdepth 1 -type d -mtime +${RETENTION_DAYS} 2>/dev/null || echo "")

if [ -z "$OLD_WORKSPACES" ]; then
    log_message "INFO" "No workspaces older than $RETENTION_DAYS days found"
    echo -e "${GREEN}No workspaces need cleanup${NC}"
    exit 0
fi

# Count old workspaces
OLD_COUNT=$(echo "$OLD_WORKSPACES" | wc -l)
log_message "INFO" "Found $OLD_COUNT workspaces older than $RETENTION_DAYS days"

# Calculate size of old workspaces
OLD_SIZE=$(echo "$OLD_WORKSPACES" | xargs du -ch 2>/dev/null | tail -1 | cut -f1)
log_message "INFO" "Size to be reclaimed: $OLD_SIZE"

# List workspaces to be deleted
log_message "INFO" "Workspaces to be cleaned:"
echo "$OLD_WORKSPACES" | while read -r workspace; do
    WORKSPACE_NAME=$(basename "$workspace")
    LAST_MODIFIED=$(stat -c '%y' "$workspace" 2>/dev/null || stat -f '%Sm' -t '%Y-%m-%d %H:%M:%S' "$workspace" 2>/dev/null)
    WORKSPACE_SIZE=$(du -sh "$workspace" 2>/dev/null | cut -f1)
    AGE_DAYS=$(( ($(date +%%s) - $(stat -c '%%Y' "$workspace" 2>/dev/null || stat -f '%%m' "$workspace" 2>/dev/null)) / 86400 ))

    log_message "INFO" "  - $WORKSPACE_NAME (size: $WORKSPACE_SIZE, age: $AGE_DAYS days, last modified: $LAST_MODIFIED)"

    if [ "$DRY_RUN" != "--dry-run" ]; then
        echo -e "${YELLOW}Deleting workspace: $WORKSPACE_NAME${NC}"
    else
        echo -e "${YELLOW}Would delete workspace: $WORKSPACE_NAME${NC}"
    fi
done

# Perform deletion if not dry-run
if [ "$DRY_RUN" != "--dry-run" ]; then
    log_message "INFO" "Starting deletion..."
    DELETED_COUNT=0
    FAILED_COUNT=0

    echo "$OLD_WORKSPACES" | while read -r workspace; do
        WORKSPACE_NAME=$(basename "$workspace")
        if rm -rf "$workspace" 2>/dev/null; then
            log_message "INFO" "Successfully deleted: $WORKSPACE_NAME"
            DELETED_COUNT=$((DELETED_COUNT + 1))
        else
            log_message "ERROR" "Failed to delete: $WORKSPACE_NAME"
            FAILED_COUNT=$((FAILED_COUNT + 1))
        fi
    done

    log_message "INFO" "Deletion complete: $DELETED_COUNT deleted, $FAILED_COUNT failed"

    # Calculate statistics after cleanup
    REMAINING_WORKSPACES=$(find "$WORKSPACE_PATH" -mindepth 1 -maxdepth 1 -type d 2>/dev/null | wc -l)
    REMAINING_SIZE=$(du -sh "$WORKSPACE_PATH" 2>/dev/null | cut -f1)

    log_message "INFO" "After cleanup: $REMAINING_WORKSPACES workspaces, $REMAINING_SIZE total size"
    log_message "INFO" "Space reclaimed: $OLD_SIZE"

    echo -e "${GREEN}=========================================${NC}"
    echo -e "${GREEN}Workspace Cleanup Complete${NC}"
    echo -e "${GREEN}=========================================${NC}"
    echo -e "Team: $TEAM_NAME"
    echo -e "Deleted: $OLD_COUNT workspaces"
    echo -e "Space reclaimed: $OLD_SIZE"
    echo -e "Remaining: $REMAINING_WORKSPACES workspaces ($REMAINING_SIZE)"
    echo -e "${GREEN}=========================================${NC}"
else
    log_message "INFO" "DRY-RUN complete - no actual deletion performed"
    echo -e "${YELLOW}=========================================${NC}"
    echo -e "${YELLOW}Workspace Cleanup Dry-Run Complete${NC}"
    echo -e "${YELLOW}=========================================${NC}"
    echo -e "Team: $TEAM_NAME"
    echo -e "Would delete: $OLD_COUNT workspaces"
    echo -e "Space to reclaim: $OLD_SIZE"
    echo -e "Run without --dry-run to perform actual cleanup"
    echo -e "${YELLOW}=========================================${NC}"
fi

log_message "INFO" "Workspace cleanup finished"
exit 0
