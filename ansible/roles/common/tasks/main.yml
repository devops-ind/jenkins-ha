---
# Tasks for common role

- name: Update package cache
  package:
    update_cache: yes
  become: yes
  when: common_update_packages

- name: Install EPEL repository (RedHat family)
  package:
    name: epel-release
    state: present
  when: 
    - common_install_tools
    - ansible_os_family == "RedHat"

- name: Install essential packages
  package:
    name: "{{ common_packages }}"
    state: present
  when: common_install_tools

# - name: Set timezone
#   timezone:
#     name: "{{ common_timezone }}"
#   notify: restart rsyslog

# Locale configuration disabled - community.general collection not available
# - name: Set locale
#   community.general.locale_gen:
#     name: "{{ common_locale }}"
#     state: present
#   when: ansible_os_family == "Debian" and common_locale is defined

- name: Check for processes using monitoring user
  shell: |
    if id "{{ common_monitoring_user }}" >/dev/null 2>&1; then
      # User exists, check for running processes
      PROCESSES=$(ps -u "{{ common_monitoring_user }}" --no-headers | wc -l | tr -d ' ')
      if [ "$PROCESSES" -gt 0 ]; then
        echo "processes_found:$PROCESSES"
        ps -u "{{ common_monitoring_user }}" -o pid,ppid,cmd --no-headers
      else
        echo "no_processes_found"
      fi
    else
      echo "user_not_exists"
    fi
  register: monitoring_user_check
  changed_when: false
  failed_when: false

- name: Stop monitoring containers to resolve user conflicts
  command: docker stop {{ item }}
  loop:
    - prometheus-production
    - grafana-production
    - alertmanager-production
    - node-exporter-production
  when: monitoring_user_check.stdout is defined and 'processes_found' in monitoring_user_check.stdout
  register: container_stops
  failed_when: false
  changed_when: container_stops.rc == 0

- name: Wait for processes to terminate
  pause:
    seconds: 3
  when: monitoring_user_check.stdout is defined and 'processes_found' in monitoring_user_check.stdout

- name: Create monitoring user
  user:
    name: "{{ common_monitoring_user }}"
    home: "{{ common_monitoring_user_home }}"
    shell: /bin/bash
    system: yes
    create_home: yes

- name: Restart monitoring containers if they were stopped
  command: docker start {{ item }}
  loop:
    - prometheus-production
    - grafana-production
    - alertmanager-production
    - node-exporter-production
  when: container_stops is defined and container_stops.changed
  register: container_restarts
  failed_when: false
  changed_when: container_restarts.rc == 0

- name: Wait for containers to be ready
  pause:
    seconds: 5
  when: container_restarts is defined and container_restarts.changed

# SSH hardening removed - no longer needed for Jenkins agent connections
# SSH is still available for system administration but not used for Jenkins communication

# UFW firewall configuration disabled - community.general collection not available
# Firewall should be managed by infrastructure team separately
# - name: Install and configure UFW firewall
#   package:
#     name: ufw
#     state: present
#   when: common_firewall_enabled and ansible_os_family == "Debian"

# - name: Configure NTP service
#   template:
#     src: ntp.conf.j2
#     dest: /etc/ntp.conf
#     backup: yes
#   notify: restart ntp
#   when: common_ntp_enabled

# - name: Start and enable NTP service
#   service:
#     name: "{{ ntp_service_name }}"
#     state: started
#     enabled: yes
#   when: common_ntp_enabled and ntp_service_name is defined

- name: Configure logrotate for system logs
  template:
    src: logrotate.j2
    dest: /etc/logrotate.d/jenkins-system
  when: common_logrotate_enabled

- name: Ensure system is up to date (disabled in production)
  package:
    name: "*"
    state: latest
  when: 
    - common_update_packages
    - ansible_os_family == "RedHat"
    - deployment_environment | default('local') != 'production'
