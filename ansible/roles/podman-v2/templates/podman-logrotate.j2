# Podman log rotation configuration
# Generated by Ansible - DO NOT EDIT MANUALLY

# Podman container logs
/var/lib/containers/storage/overlay-containers/*/userdata/ctr.log {
    daily
    missingok
    rotate {{ podman_log_max_files | default(7) }}
    compress
    delaycompress
    notifempty
    sharedscripts
    create 0640 root root
    size {{ podman_log_max_size | default('10M') }}
    
    postrotate
        # Signal Podman to reopen log files
        /usr/bin/podman system prune -f --volumes > /dev/null 2>&1 || true
    endscript
}

# Podman system logs
/var/log/containers/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 0640 root root
    maxage 30
}

# Conmon logs
/var/log/conmon/*.log {
    daily
    missingok
    rotate 7
    compress
    delaycompress
    notifempty
    create 0640 root root
    maxsize 100M
}

# Rootless user container logs
{% if podman_enable_rootless %}
{% for user in podman_users %}
/home/{{ user }}/.local/share/containers/storage/overlay-containers/*/userdata/ctr.log {
    daily
    missingok
    rotate {{ podman_log_max_files | default(7) }}
    compress
    delaycompress
    notifempty
    su {{ user }} {{ user }}
    create 0640 {{ user }} {{ user }}
    size {{ podman_log_max_size | default('10M') }}
    
    postrotate
        su {{ user }} -c '/usr/bin/podman system prune -f --volumes > /dev/null 2>&1' || true
    endscript
}

# User-specific container logs
/home/{{ user }}/.local/share/containers/logs/*.log {
    daily
    missingok
    rotate 14
    compress
    delaycompress
    notifempty
    su {{ user }} {{ user }}
    create 0640 {{ user }} {{ user }}
    maxage 14
}
{% endfor %}
{% endif %}

# Buildah logs (if enabled)
{% if podman_buildah_enabled %}
/var/log/buildah/*.log {
    daily
    missingok
    rotate 7
    compress
    delaycompress
    notifempty
    create 0640 root root
    maxsize 50M
}
{% endif %}

# Network backend logs
{% if podman_network_backend == "netavark" %}
/var/log/netavark/*.log {
    daily
    missingok
    rotate 7
    compress
    delaycompress
    notifempty
    create 0640 root root
}
{% endif %}

# Systemd journal logs for Podman services
# Note: These are handled by systemd/journald, but we can set limits
{% if ansible_service_mgr == "systemd" %}
# This is configured in /etc/systemd/journald.conf
# SystemMaxUse=1G
# SystemMaxFiles=10
# MaxRetentionSec=2weeks
{% endif %}