# Podman storage.conf configuration
# Generated by Ansible - DO NOT EDIT MANUALLY

[storage]
# Storage driver to use (overlay, vfs, etc.)
driver = "{{ podman_storage_driver }}"

# Root directory for storage
runroot = "/run/containers/storage"
graphroot = "/var/lib/containers/storage"

{% if podman_enable_rootless %}
# Rootless storage configuration
[storage.options.overlay]
# Rootless overlay options
mount_program = "/usr/bin/fuse-overlayfs"
mountopt = "nodev,metacopy=on"
{% endif %}

# Overlay driver options
[storage.options.overlay]
{% if not podman_enable_rootless %}
# Rootful overlay options
mountopt = "nodev"
{% endif %}

# Skip mount home
skip_mount_home = false

# Size limit for overlay storage (optional)
{% if podman_storage_size_limit is defined %}
size = "{{ podman_storage_size_limit }}"
{% endif %}

# Metadata storage options
force_mask = 0000

{% if podman_storage_driver == "vfs" %}
# VFS driver options (for testing/development)
[storage.options.vfs]
# VFS doesn't use copy-on-write, uses more disk space
# But is more compatible across different filesystems
ignore_chown_errors = true
{% endif %}

{% if podman_storage_driver == "devicemapper" %}
# Device mapper options (legacy, not recommended)
[storage.options.devicemapper]
dm.fs = "ext4"
dm.basesize = "10G"
dm.loopdatasize = "100G"
dm.loopmetadatasize = "2G"
{% endif %}

# Image store options
[storage.options]
# Pull always use hard links when possible
pull_options = {enable_partial_images = "true"}

# Rootless user remapping
{% if podman_enable_rootless %}
# Rootless storage will use user namespaces
# These settings are automatically configured for rootless users

# Auto user namespace settings
auto_userns = true
auto_userns_min_size = {{ podman_subuid_size }}
auto_userns_max_size = {{ podman_subuid_size }}
{% endif %}

# GC options for image and container cleanup
[storage.options.overlay]
# Overlay cleanup options
skip_mount_home = false

{% if podman_tune_storage %}
# Performance tuning options
use_composefs = false
force_mask = 0000

# Mount options for better performance
mountopt = "nodev{% if podman_enable_rootless %},metacopy=on{% endif %}"
{% endif %}

# Additional mount options
additionalimagestores = []

# Transient storage (for temporary containers)
[storage.options.transient]
# Enable transient storage for better performance
enabled = {{ podman_transient_storage_enabled | default('false') | lower }}

{% if podman_transient_storage_enabled | default(false) %}
# Transient storage location (tmpfs/memory)
runroot = "/run/user/{{ ansible_user_uid | default('1000') }}/containers"
{% endif %}

# Volume storage options
[storage.options.volume]
# Default volume driver
default_driver = "local"

# Local volume options
[storage.options.volume.local]
# Mount options for local volumes
mount_options = ["nodev", "nosuid"]

{% if podman_backup_enabled %}
# Backup configuration
[storage.options.backup]
# Enable automatic backup of container metadata
enabled = true
backup_location = "{{ podman_export_location }}"
retention_days = {{ podman_cleanup_cron.retention_days | default(30) }}
{% endif %}

# Logging for storage operations
[storage.options.log]
{% if podman_debug_logging %}
# Enable debug logging for storage operations
level = "debug"
{% else %}
level = "error"
{% endif %}

# Platform-specific options
{% if ansible_architecture == "aarch64" %}
[storage.options.platform]
# ARM64 specific optimizations
architecture = "arm64"
{% elif ansible_architecture == "x86_64" %}
[storage.options.platform]
# x86_64 specific optimizations  
architecture = "amd64"
{% endif %}

# SELinux context options
{% if podman_enable_selinux %}
[storage.options.selinux]
# SELinux label for storage
selinux_enabled = true
{% endif %}

# Experimental features
{% if podman_storage_experimental_features is defined %}
[storage.options.experimental]
{% for feature, enabled in podman_storage_experimental_features.items() %}
{{ feature }} = {{ enabled | lower }}
{% endfor %}
{% endif %}