#!/bin/bash

###############################################################################
# Podman System Cleanup Script
# Generated by Ansible - DO NOT EDIT MANUALLY
# 
# This script performs comprehensive cleanup of Podman resources:
# - Removes unused containers, images, volumes, and networks
# - Cleans up build cache and temporary files
# - Manages log files and storage optimization
###############################################################################

set -euo pipefail

# Configuration
LOG_FILE="/var/log/podman-cleanup.log"
DRY_RUN=${1:-false}
VERBOSE=${2:-false}

# Logging functions
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOG_FILE"
}

log_verbose() {
    if [[ "$VERBOSE" == "true" ]]; then
        log "$*"
    fi
}

log_error() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] ERROR: $*" | tee -a "$LOG_FILE" >&2
}

# Cleanup function
cleanup_podman_system() {
    local dry_run_flag=""
    if [[ "$DRY_RUN" == "true" ]]; then
        dry_run_flag="--dry-run"
        log "Running in DRY RUN mode - no changes will be made"
    fi

    log "Starting Podman system cleanup"

    # Stop and remove exited containers
    log_verbose "Cleaning up stopped containers..."
    if podman ps -aq --filter "status=exited" | grep -q .; then
        if [[ "$DRY_RUN" != "true" ]]; then
            podman rm $(podman ps -aq --filter "status=exited") || log_error "Failed to remove exited containers"
        else
            log "Would remove: $(podman ps -aq --filter "status=exited" | wc -l) exited containers"
        fi
    else
        log_verbose "No exited containers to clean"
    fi

    # Remove dangling images
    log_verbose "Cleaning up dangling images..."
    if podman images -q --filter "dangling=true" | grep -q .; then
        if [[ "$DRY_RUN" != "true" ]]; then
            podman rmi $(podman images -q --filter "dangling=true") || log_error "Failed to remove dangling images"
        else
            log "Would remove: $(podman images -q --filter "dangling=true" | wc -l) dangling images"
        fi
    else
        log_verbose "No dangling images to clean"
    fi

    # Clean up unused volumes
    log_verbose "Cleaning up unused volumes..."
    if [[ "$DRY_RUN" != "true" ]]; then
        podman volume prune -f || log_error "Failed to prune volumes"
    else
        log "Would prune unused volumes"
    fi

    # Clean up unused networks
    log_verbose "Cleaning up unused networks..."
    if [[ "$DRY_RUN" != "true" ]]; then
        podman network prune -f || log_error "Failed to prune networks"
    else
        log "Would prune unused networks"
    fi

    # System-wide cleanup
    log_verbose "Running system-wide cleanup..."
    if [[ "$DRY_RUN" != "true" ]]; then
        podman system prune -af --volumes || log_error "Failed to run system prune"
    else
        log "Would run: podman system prune -af --volumes"
    fi

    # Clean up build cache
    {% if podman_buildah_enabled %}
    log_verbose "Cleaning up build cache..."
    if command -v buildah >/dev/null 2>&1; then
        if [[ "$DRY_RUN" != "true" ]]; then
            buildah prune -af || log_error "Failed to prune build cache"
        else
            log "Would run: buildah prune -af"
        fi
    fi
    {% endif %}

    # Clean up old log files
    log_verbose "Cleaning up old log files..."
    find /var/log/containers -name "*.log*" -mtime +{{ podman_cleanup_cron.retention_days | default(30) }} -type f | while read -r logfile; do
        if [[ "$DRY_RUN" != "true" ]]; then
            rm -f "$logfile" && log_verbose "Removed old log file: $logfile"
        else
            log "Would remove old log file: $logfile"
        fi
    done

    # Clean up temporary files
    log_verbose "Cleaning up temporary files..."
    if [[ -d "/tmp/podman-*" ]]; then
        find /tmp -name "podman-*" -type d -mtime +1 | while read -r tmpdir; do
            if [[ "$DRY_RUN" != "true" ]]; then
                rm -rf "$tmpdir" && log_verbose "Removed temporary directory: $tmpdir"
            else
                log "Would remove temporary directory: $tmpdir"
            fi
        done
    fi

    log "Podman system cleanup completed"
}

# Rootless cleanup function
cleanup_rootless_podman() {
    local user="$1"
    log "Cleaning up rootless Podman for user: $user"

    if [[ "$DRY_RUN" != "true" ]]; then
        # Use runuser to execute as the specified user
        runuser -l "$user" -c "
            podman system prune -af --volumes 2>/dev/null || echo 'Failed to cleanup for user $user'
        " || log_error "Failed to cleanup rootless Podman for user: $user"
    else
        log "Would clean up rootless Podman for user: $user"
    fi
}

# Storage optimization
optimize_storage() {
    log_verbose "Optimizing Podman storage..."
    
    if [[ "$DRY_RUN" != "true" ]]; then
        # Reset storage if it becomes corrupted
        if ! podman system info >/dev/null 2>&1; then
            log "Storage appears corrupted, attempting reset..."
            podman system reset -f || log_error "Failed to reset Podman storage"
        fi
        
        # Migrate storage if needed
        podman system migrate || log_error "Failed to migrate Podman storage"
    else
        log "Would optimize and migrate Podman storage"
    fi
}

# Disk space reporting
report_disk_usage() {
    log "=== Disk Usage Report ==="
    
    # Container storage usage
    if command -v podman >/dev/null 2>&1; then
        log "Podman system disk usage:"
        podman system df || log_error "Failed to get Podman disk usage"
    fi
    
    # Overall storage directory usage
    if [[ -d "/var/lib/containers" ]]; then
        log "Container storage directory usage:"
        du -sh /var/lib/containers/* 2>/dev/null | sort -hr | head -10 || true
    fi
    
    log "=========================="
}

# Main execution
main() {
    # Create log file if it doesn't exist
    touch "$LOG_FILE"
    
    # Check if Podman is available
    if ! command -v podman >/dev/null 2>&1; then
        log_error "Podman is not installed or not in PATH"
        exit 1
    fi
    
    # Report initial disk usage
    report_disk_usage
    
    # Clean up system-wide resources
    cleanup_podman_system
    
    # Clean up rootless containers for each configured user
    {% if podman_enable_rootless %}
    {% for user in podman_users %}
    if id "{{ user }}" >/dev/null 2>&1; then
        cleanup_rootless_podman "{{ user }}"
    else
        log_error "User {{ user }} does not exist, skipping rootless cleanup"
    fi
    {% endfor %}
    {% endif %}
    
    # Optimize storage
    optimize_storage
    
    # Report final disk usage
    report_disk_usage
    
    # Rotate cleanup log if it gets too large
    if [[ -f "$LOG_FILE" ]] && [[ $(wc -c < "$LOG_FILE") -gt 10485760 ]]; then  # 10MB
        if [[ "$DRY_RUN" != "true" ]]; then
            mv "$LOG_FILE" "$LOG_FILE.old"
            touch "$LOG_FILE"
            log "Rotated cleanup log file"
        fi
    fi
    
    log "Podman cleanup script completed successfully"
}

# Handle script arguments
case "${1:-}" in
    --dry-run)
        main true false
        ;;
    --verbose)
        main false true
        ;;
    --dry-run --verbose|--verbose --dry-run)
        main true true
        ;;
    --help|-h)
        echo "Usage: $0 [--dry-run] [--verbose] [--help]"
        echo "  --dry-run   Show what would be cleaned without making changes"
        echo "  --verbose   Enable verbose logging"
        echo "  --help      Show this help message"
        exit 0
        ;;
    *)
        main false false
        ;;
esac