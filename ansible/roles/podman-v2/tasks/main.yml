---
# Tasks for podman-v2 role

- name: Install Podman dependencies (Debian/Ubuntu)
  package:
    name:
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
      - uidmap
      - slirp4netns
      - fuse-overlayfs
      - crun
    state: present
  when: ansible_os_family == "Debian"

- name: Add Podman repository (Ubuntu)
  apt_repository:
    repo: "ppa:sergi-dote/podman-next"
    state: present
    update_cache: yes
  when: 
    - ansible_os_family == "Debian"
    - ansible_distribution == "Ubuntu"

- name: Install Podman packages (Debian/Ubuntu)
  apt:
    name:
      - podman
      - podman-compose
      - podman-docker  # Docker compatibility
      - containernetworking-plugins
      - cni-plugins
    state: present
    update_cache: yes
  when: ansible_os_family == "Debian"

- name: Install Podman dependencies (RedHat/CentOS)
  package:
    name:
      - shadow-utils
      - fuse-overlayfs
      - slirp4netns
      - crun
      - uidmap
      - container-selinux
    state: present
  when: ansible_os_family == "RedHat"

- name: Install Podman packages (RedHat/CentOS)
  package:
    name:
      - podman
      - podman-compose
      - podman-docker  # Docker CLI compatibility
      - netavark  # Modern network stack
      - aardvark-dns  # DNS resolution for containers
    state: present
  when: ansible_os_family == "RedHat"

- name: Create containers configuration directory
  file:
    path: /etc/containers
    state: directory
    mode: '0755'

- name: Configure Podman containers.conf
  template:
    src: containers.conf.j2
    dest: /etc/containers/containers.conf
    backup: yes
    mode: '0644'
  notify: restart podman system service

- name: Configure Podman registries.conf
  template:
    src: registries.conf.j2
    dest: /etc/containers/registries.conf
    backup: yes
    mode: '0644'

- name: Configure Podman storage.conf
  template:
    src: storage.conf.j2
    dest: /etc/containers/storage.conf
    backup: yes
    mode: '0644'

- name: Create Podman users with subuid/subgid
  user:
    name: "{{ item }}"
    groups: "{{ podman_user_groups }}"
    append: yes
    state: present
  loop: "{{ podman_users }}"

- name: Configure subuid for Podman users
  lineinfile:
    path: /etc/subuid
    line: "{{ item }}:{{ podman_subuid_start }}:{{ podman_subuid_size }}"
    create: yes
    mode: '0644'
  loop: "{{ podman_users }}"

- name: Configure subgid for Podman users
  lineinfile:
    path: /etc/subgid
    line: "{{ item }}:{{ podman_subgid_start }}:{{ podman_subgid_size }}"
    create: yes
    mode: '0644'
  loop: "{{ podman_users }}"

- name: Enable lingering for Podman users (rootless services)
  command: loginctl enable-linger {{ item }}
  loop: "{{ podman_users }}"
  when: podman_enable_rootless
  changed_when: false

- name: Create Podman socket service directory
  file:
    path: /etc/systemd/system
    state: directory
    mode: '0755'

- name: Enable Podman system service (rootful)
  systemd:
    name: podman.service
    enabled: "{{ podman_system_service_enabled }}"
    state: "{{ 'started' if podman_system_service_enabled else 'stopped' }}"
    daemon_reload: yes
  when: not podman_rootless_only

- name: Enable Podman socket service (rootful)
  systemd:
    name: podman.socket
    enabled: "{{ podman_socket_enabled }}"
    state: "{{ 'started' if podman_socket_enabled else 'stopped' }}"
    daemon_reload: yes
  when: not podman_rootless_only

- name: Create Podman networks
  containers.podman.podman_network:
    name: "{{ item.name }}"
    driver: "{{ item.driver | default('bridge') }}"
    subnet: "{{ item.subnet | default(omit) }}"
    gateway: "{{ item.gateway | default(omit) }}"
    internal: "{{ item.internal | default(false) }}"
    disable_dns: "{{ item.disable_dns | default(false) }}"
    state: present
  loop: "{{ podman_networks }}"
  become: "{{ not podman_rootless_only }}"

- name: Create Podman volumes
  containers.podman.podman_volume:
    name: "{{ item.name }}"
    driver: "{{ item.driver | default('local') }}"
    options: "{{ item.options | default(omit) }}"
    state: present
  loop: "{{ podman_volumes }}"
  become: "{{ not podman_rootless_only }}"

- name: Setup Podman log rotation
  template:
    src: podman-logrotate.j2
    dest: /etc/logrotate.d/podman
    mode: '0644'
  when: podman_cleanup_enabled

- name: Create Podman cleanup script
  template:
    src: podman-cleanup.sh.j2
    dest: /usr/local/bin/podman-cleanup.sh
    mode: '0755'
  when: podman_cleanup_enabled

- name: Setup Podman cleanup cron job
  cron:
    name: "Podman system cleanup"
    minute: "{{ podman_cleanup_cron.minute }}"
    hour: "{{ podman_cleanup_cron.hour }}"
    day: "{{ podman_cleanup_cron.day }}"
    month: "{{ podman_cleanup_cron.month }}"
    weekday: "{{ podman_cleanup_cron.weekday }}"
    job: "/usr/local/bin/podman-cleanup.sh > /dev/null 2>&1"
    user: root
  when: podman_cleanup_enabled and not podman_rootless_only

- name: Setup rootless Podman cleanup for each user
  cron:
    name: "Podman rootless cleanup for {{ item }}"
    minute: "{{ podman_cleanup_cron.minute }}"
    hour: "{{ podman_cleanup_cron.hour }}"
    day: "{{ podman_cleanup_cron.day }}"
    month: "{{ podman_cleanup_cron.month }}"
    weekday: "{{ podman_cleanup_cron.weekday }}"
    job: "/usr/bin/podman system prune -af --volumes > /dev/null 2>&1"
    user: "{{ item }}"
  loop: "{{ podman_users }}"
  when: podman_cleanup_enabled and podman_enable_rootless

- name: Create systemd directory for user services
  file:
    path: "/home/{{ item }}/.config/systemd/user"
    state: directory
    owner: "{{ item }}"
    group: "{{ item }}"
    mode: '0755'
  loop: "{{ podman_users }}"
  when: podman_enable_rootless

- name: Configure Podman for Docker CLI compatibility
  file:
    src: /usr/bin/podman
    dest: /usr/local/bin/docker
    state: link
  when: podman_docker_compatibility

- name: Install Podman Compose compatibility
  pip:
    name: podman-compose
    state: present
  when: podman_compose_enabled

- name: Enable Podman auto-update timer
  systemd:
    name: podman-auto-update.timer
    enabled: "{{ podman_auto_update_enabled }}"
    state: "{{ 'started' if podman_auto_update_enabled else 'stopped' }}"
    daemon_reload: yes
  when: not podman_rootless_only

- name: Configure SELinux for Podman (if SELinux enabled)
  seboolean:
    name: container_manage_cgroup
    state: yes
    persistent: yes
  when: 
    - ansible_selinux is defined
    - ansible_selinux.status == "enabled"
    - ansible_os_family == "RedHat"

- name: Verify Podman installation
  command: podman --version
  register: podman_version_check
  changed_when: false
  failed_when: podman_version_check.rc != 0

- name: Display Podman version
  debug:
    msg: "Podman installed successfully: {{ podman_version_check.stdout }}"

- name: Verify Podman system info
  command: podman system info --format json
  register: podman_info
  changed_when: false
  failed_when: podman_info.rc != 0
  become: "{{ not podman_rootless_only }}"

- name: Create Podman systemd unit files directory
  file:
    path: "{{ podman_systemd_units_dir }}"
    state: directory
    mode: '0755'
  when: podman_systemd_integration

# Example systemd service creation for Jenkins containers
- name: Create example Podman systemd service template
  template:
    src: podman-service.service.j2
    dest: "{{ podman_systemd_units_dir }}/podman-example.service"
    mode: '0644'
  when: 
    - podman_systemd_integration
    - podman_create_example_service
  notify: reload systemd

- name: Configure Podman machine (if on macOS)
  block:
    - name: Initialize Podman machine
      command: podman machine init {{ podman_machine_name }}
      become: false
    
    - name: Start Podman machine
      command: podman machine start {{ podman_machine_name }}
      become: false
  when: 
    - ansible_os_family == "Darwin"
    - podman_machine_enabled