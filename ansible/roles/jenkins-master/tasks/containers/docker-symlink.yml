---
# Jenkins Master - Docker Container Deployment with Symlink-Based Config
# Single container per team with hot-reloadable configuration via symlinks

- name: Deploy Jenkins containers with symlink-based config (Single container mode)
  community.docker.docker_container:
    name: "jenkins-{{ item.team_name }}"
    image: "{{ _jenkins_image }}"
    state: started
    restart_policy: "{{ jenkins_master_restart_policy }}"
    networks:
      - name: "{{ jenkins_master_network_name }}"
    ports: "{{ _container_ports }}"
    volumes: "{{ _container_volumes }}"
    env: "{{ _jenkins_env_vars }}"
    memory: "{{ item.resources.memory }}"
    cpus: "{{ item.resources.cpu }}"
    log_driver: "{{ jenkins_master_log_driver }}"
    log_options: "{{ _log_options }}"
    labels:
      service: "{{ jenkins_master_labels.service | default('jenkins-master') }}"
      managed_by: "{{ jenkins_master_labels.managed_by | default('ansible') }}"
      role: "{{ jenkins_master_labels.role | default('jenkins-master') }}"
      team: "{{ item.team_name }}"
      tier: "{{ item.labels.tier | default('production') | string }}"
      deployment_mode: "symlink-config"
      config_update_mode: "hot-reload"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:{{ jenkins_master_port }}/login"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
  vars:
    _jenkins_env_vars: "{{ jenkins_master_env_vars | combine(item.env_vars | default({})) | combine({'JENKINS_TEAM': item.team_name, 'CASC_JENKINS_CONFIG': '/var/jenkins_home/casc_configs'}) }}"
    _jenkins_image: "{{ _jenkins_team_custom_image if (_jenkins_team_custom_image_available | default(false)) else (_jenkins_fallback_image) }}"
    _jenkins_team_custom_image: "{{ jenkins_master_custom_image_prefix }}-{{ item.team_name }}:{{ jenkins_master_base_image_tag }}"
    _jenkins_team_custom_image_available: "{{ jenkins_custom_image_registry is defined and item.team_name in jenkins_custom_image_registry }}"
    _jenkins_fallback_image: "{{ jenkins_master_image_registry }}/{{ jenkins_master_image_name }}:{{ jenkins_master_image_tag }}"
    _container_ports:
      - "{{ item.ports.web | string }}:{{ jenkins_master_port | string }}"
      - "{{ item.ports.agent | string }}:{{ jenkins_jnlp_port | string }}"
    # Mount the 'active' symlink as read-only config directory
    _container_volumes: "{{ _base_volumes + _config_volume + (_socket_volume if jenkins_socket_available | default(false) else []) }}"
    _base_volumes:
      - "jenkins-{{ item.team_name }}-home:{{ jenkins_master_container_home }}"
      - "jenkins-{{ item.team_name }}-shared:{{ jenkins_master_shared_path }}"
    # CRITICAL: Mount the symlink directory as READ-ONLY for security
    _config_volume:
      - "/var/jenkins/{{ item.team_name }}/configs/active:{{ jenkins_master_container_home }}/casc_configs:ro"
    _socket_volume:
      - "{{ jenkins_socket_mount_string }}"
    _log_options: "{{ {'max-size': jenkins_master_log_max_size, 'max-file': jenkins_master_log_max_files} if jenkins_master_log_driver == 'json-file' else {} }}"
  loop: "{{ jenkins_effective_config }}"
  loop_control:
    label: "jenkins-{{ item.team_name }}"
  register: jenkins_symlink_docker
  tags: ['containers', 'docker', 'symlink']

- name: Display symlink-based container deployment summary
  debug:
    msg: |
      Deployed Jenkins container for {{ item.item.team_name }}:
      - Container: jenkins-{{ item.item.team_name }}
      - Mode: Symlink-based configuration (hot-reload enabled)
      - Config mount: /var/jenkins/{{ item.item.team_name }}/configs/active -> /var/jenkins_home/casc_configs (ro)
      - Web port: {{ item.item.ports.web }}
      - Agent port: {{ item.item.ports.agent }}
      - State: {{ item.container.State.Status }}
  loop: "{{ jenkins_symlink_docker.results }}"
  loop_control:
    label: "jenkins-{{ item.item.team_name }}"
  when: jenkins_symlink_docker is defined
  tags: ['containers', 'docker', 'symlink']
