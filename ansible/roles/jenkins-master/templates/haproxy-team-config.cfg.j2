# HAProxy Configuration for Jenkins Team: {{ jenkins_master_config.team_name }}
# Generated by Ansible jenkins-master role

# Backend configuration for {{ jenkins_master_config.team_name }}
backend jenkins_{{ jenkins_master_config.team_name }}_backend
    balance roundrobin
    option httpchk GET /login
    http-check expect status 200
    
    # Active environment ({{ jenkins_master_config.active_environment }})
    server {{ jenkins_master_config.team_name }}_{{ jenkins_master_config.active_environment }} {{ ansible_default_ipv4.address }}:{{ jenkins_master_config.ports.web }} check inter 5s rise 2 fall 3
    
    # Standby environment (backup)
    {% set standby_env = 'green' if jenkins_master_config.active_environment == 'blue' else 'blue' %}
    server {{ jenkins_master_config.team_name }}_{{ standby_env }} {{ ansible_default_ipv4.address }}:{{ jenkins_master_config.ports.web }} check inter 10s rise 3 fall 2 backup

# Frontend configuration for {{ jenkins_master_config.team_name }}
frontend jenkins_{{ jenkins_master_config.team_name }}_frontend
    bind *:{{ jenkins_master_config.ports.web | default(jenkins_master_config.ports.web) }}
    mode http
    
    # Security headers
    http-response set-header X-Frame-Options SAMEORIGIN
    http-response set-header X-Content-Type-Options nosniff
    http-response set-header X-XSS-Protection "1; mode=block"
    
    # Jenkins-specific configuration
    http-request set-header X-Forwarded-Proto https if { ssl_fc }
    http-request set-header X-Forwarded-Port %[dst_port]
    
    # Route to backend
    default_backend jenkins_{{ jenkins_master_config.team_name }}_backend

# Stats configuration (optional)
{% if jenkins_master_haproxy_stats_enabled | default(false) %}
listen stats_{{ jenkins_master_config.team_name }}
    bind *:{{ jenkins_master_config.stats_port | default(8404) }}
    stats enable
    stats uri /stats
    stats refresh 10s
    stats show-legends
    stats show-node
    stats realm Jenkins\ {{ jenkins_master_config.team_name | title }}\ HAProxy\ Statistics
{% endif %}