---
# Main Jenkins Infrastructure Orchestration Playbook
# Production-grade deployment with unified jenkins-master role

# Dynamic host selection based on deployment_mode
- name: Set target hosts based on deployment mode
  hosts: localhost
  gather_facts: no
  run_once: true
  tasks:
    - name: Determine target hosts for deployment
      set_fact:
        target_hosts: >-
          {% if hostvars[groups['all'][0]]['deployment_mode'] | default('local') == 'production' %}
          jenkins_masters:monitoring:load_balancers:shared_storage
          {% else %}
          localhost
          {% endif %}
        jenkins_target_hosts: >-
          {% if hostvars[groups['all'][0]]['deployment_mode'] | default('local') == 'production' %}
          jenkins_masters
          {% else %}
          localhost
          {% endif %}
        monitoring_target_hosts: >-
          {% if hostvars[groups['all'][0]]['deployment_mode'] | default('local') == 'production' %}
          monitoring
          {% else %}
          localhost
          {% endif %}
    
    - name: Display deployment configuration
      debug:
        msg:
          - "Deployment Mode: {{ hostvars[groups['all'][0]]['deployment_mode'] | default('local') }}"
          - "Target Hosts: {{ target_hosts }}"
          - "Jenkins Hosts: {{ jenkins_target_hosts }}"
          - "Monitoring Hosts: {{ monitoring_target_hosts }}"

- name: Pre-Deployment Validation Suite
  hosts: "{{ (deployment_mode | default('local') == 'local') | ternary('localhost', 'all') }}"
  become: "{{ deployment_mode | default('local') != 'production' }}"
  gather_facts: yes
  serial: "100%"  # Run validation on all hosts in parallel
  vars:
    deployment_environment: "{{ lookup('env', 'DEPLOYMENT_ENV') | default('local') }}"
    validation_mode: "{{ validation_mode_override | default('strict') }}"  # strict, warn, skip
  tasks:
    - name: ğŸ” Pre-deployment validation framework
      block:
        - name: Set resource requirements based on deployment mode
          set_fact:
            # Adjusted for realistic VM-based deployments that we know work
            # Based on actual working system: 696MB RAM, 2 CPUs running successfully
            min_memory_mb: "{{ 512 if environment_tier == 'prod' else 256 }}"
            min_cpu_cores: "{{ 1 if environment_tier == 'prod' else 1 }}"
            min_disk_gb: "{{ 5 if environment_tier == 'prod' else 3 }}"
            
        - name: Validate deployment prerequisites
          assert:
            that:
              - ansible_memtotal_mb >= (min_memory_mb | int)
              - ansible_processor_vcpus >= (min_cpu_cores | int)
              - (ansible_mounts | selectattr('mount', 'equalto', '/') | first).size_available > (min_disk_gb | int * 1000000000)
              - ansible_distribution in ['Ubuntu', 'Debian', 'CentOS', 'RedHat', 'Rocky', 'AlmaLinux']
            fail_msg: |
              âŒ System requirements not met for {{ deployment_mode | default('local') }} deployment:
              - Memory: {{ ansible_memtotal_mb }}MB (minimum: {{ min_memory_mb }}MB)
              - CPU cores: {{ ansible_processor_vcpus }} (minimum: {{ min_cpu_cores }})
              - Disk space: {{ (ansible_mounts | selectattr('mount', 'equalto', '/') | first).size_available // 1000000000 }}GB (minimum: {{ min_disk_gb }}GB)
              - OS: {{ ansible_distribution }} (supported: Ubuntu, Debian, CentOS, RedHat, Rocky, AlmaLinux)
            success_msg: "âœ… System requirements validated for {{ deployment_mode | default('local') }} deployment"
          when: inventory_hostname != 'localhost' and ansible_mounts is defined

        - name: Check network connectivity to dependencies
          uri:
            url: "{{ item.url }}"
            method: "{{ item.method | default('HEAD') }}"
            timeout: 10
            status_code: [200, 301, 302, 403]  # Some services may return 403 for HEAD requests
          loop:
            - { url: "https://registry-1.docker.io", name: "Docker Hub" }
            - { url: "https://github.com", name: "GitHub" }
            - { url: "https://repo1.maven.org/maven2/", name: "Maven Central" }
            - { url: "https://registry.npmjs.org/", name: "NPM Registry" }
          loop_control:
            label: "{{ item.name }}"
          register: connectivity_check
          failed_when: false
          
        - name: Report connectivity issues
          debug:
            msg: |
              âš ï¸ Network connectivity issues detected:
              {% for result in connectivity_check.results %}
              {% if result.status is defined and result.status != 200 %}
              - {{ result.item.name }}: {{ result.status | default('Failed') }} ({{ result.msg | default('Unknown error') }})
              {% endif %}
              {% endfor %}
          when: connectivity_check is defined and connectivity_check.results is defined and 
                (connectivity_check.results | selectattr('status', 'defined') | selectattr('status', 'ne', 200) | list | length > 0)

        - name: Validate container runtime availability
          block:
            - name: Check container runtime
              shell: docker info >/dev/null 2>&1
              register: runtime_functional
              failed_when: runtime_functional.rc != 0
              changed_when: false

        - name: Display validation summary
          debug:
            msg: |
              ğŸ” Pre-deployment Validation Summary for {{ inventory_hostname }}:
              âœ… System Requirements: PASSED
              âœ… Container Runtime: DOCKER available
              âœ… Network Connectivity: {{ connectivity_check.results | selectattr('status', 'eq', 200) | list | length }}/{{ connectivity_check.results | length }} services reachable
              
              Validation Mode: {{ validation_mode | upper }}

      rescue:
        - name: Handle validation failures
          debug:
            msg: |
              âŒ Pre-deployment validation failed: {{ ansible_failed_result.msg | default('Unknown validation error') }}
              
              Validation can proceed in different modes:
              - strict: Deployment blocked on any validation failure (current)
              - warn: Deployment continues with warnings
              - skip: Validation bypassed (not recommended for production)
              
              To change mode: ansible-playbook site.yml -e validation_mode=warn
              
        - name: Fail on strict validation mode
          fail:
            msg: |
              Deployment blocked due to validation failures in strict mode.
              Review the validation report and resolve issues before proceeding.
              
              To bypass (not recommended): ansible-playbook site.yml -e validation_mode=skip
          when: validation_mode == 'strict'
          
        - name: Continue with warnings in warn mode
          debug:
            msg: "âš ï¸ Continuing deployment despite validation warnings (warn mode)"
          when: validation_mode == 'warn'

      when: validation_mode != 'skip'
      tags: ['validation', 'pre-deployment']

- name: Setup GlusterFS Replicated Storage (if enabled)
  hosts: "{{ (deployment_mode | default('local') == 'local') | ternary('localhost', 'glusterfs_servers') }}"
  become: yes
  gather_facts: yes
  serial: "100%"  # Deploy to all GlusterFS servers in parallel
  vars:
    deployment_environment: "{{ lookup('env', 'DEPLOYMENT_ENV') | default('local') }}"
  roles:
    - role: glusterfs-server
      tags: ['glusterfs', 'storage', 'bootstrap']
      when:
        - shared_storage_enabled | default(false)
        - shared_storage_type is defined
        - shared_storage_type == "glusterfs"
        - groups['glusterfs_servers'] is defined
        - groups['glusterfs_servers'] | length > 0

- name: Bootstrap Infrastructure
  hosts: "{{ (deployment_mode | default('local') == 'local') | ternary('localhost', 'all') }}"
  become: "{{ deployment_mode | default('local') != 'production' }}"
  gather_facts: yes
  serial: "{{ serial_execution | default('100%') }}"
  vars:
    deployment_environment: "{{ lookup('env', 'DEPLOYMENT_ENV') | default('local') }}"
  roles:
    - role: common
      tags: ['common', 'bootstrap']
    - role: docker
      tags: ['docker', 'bootstrap']
    - role: shared-storage
      tags: ['storage', 'bootstrap']
      when: shared_storage_enabled | default(true)
    - role: security
      tags: ['security', 'bootstrap']


# - name: Build and Manage Jenkins Images
#   hosts: "{{ (deployment_mode | default('local') == 'local') | ternary('localhost', 'jenkins_masters[0]') }}"  # Build on primary master only
#   become: yes
#   gather_facts: yes
#   vars:
#     jenkins_images_build: false
#     jenkins_images_push: false
#   roles:
#     - role: jenkins-images
#       tags: ['images', 'build']
#       when: build_jenkins_images | default(false) | bool

- name: Deploy Jenkins Infrastructure
  hosts: "{{ (deployment_mode | default('local') == 'local') | ternary('localhost', 'jenkins_masters') }}"
  become: yes
  gather_facts: yes
  serial: 1  # Deploy masters one by one for HA
  vars:
    jenkins_ha_enabled: "{{ groups['jenkins_masters'] | default([]) | length > 1 }}"
    jenkins_master_priority: "{{ play_hosts.index(inventory_hostname) + 1 }}"
  roles:
    - role: jenkins-master-v2
      tags: ['jenkins', 'deploy']
  post_tasks:
    - name: Wait for Jenkins teams to be ready
      uri:
        url: "http://{{ ansible_default_ipv4.address }}:{% if item.active_environment | default('blue') == 'blue' %}{{ item.ports.web | default(8080) }}{% else %}{{ (item.ports.web | default(8080)) + 100 }}{% endif %}/login"
        method: GET
        status_code: [200, 403]
      register: jenkins_ready
      until: jenkins_ready is succeeded
      retries: 60
      delay: 10
      loop: "{{ jenkins_teams_config | default(jenkins_teams) | default([{'ports': {'web': 8080}}]) }}"
      tags: ['jenkins', 'verify']

- name: Configure High Availability (HAProxy Load Balancer + Multi-Team Routing)
  hosts: "{{ (deployment_mode | default('local') == 'local') | ternary('localhost', 'load_balancers:jenkins_masters') }}"
  become: yes
  gather_facts: yes
  pre_tasks:
    - name: Apply team filtering logic for HAProxy configuration - Deploy Teams
      set_fact:
        jenkins_teams_for_haproxy: "{{ jenkins_teams_config | selectattr('team_name', 'in', deploy_teams.split(',') | map('trim') | list) | list }}"
      when: deploy_teams is defined and deploy_teams != ""
      tags: ['ha', 'filter']

    - name: Apply team filtering logic for HAProxy configuration - Exclude Teams
      set_fact:
        jenkins_teams_for_haproxy: "{{ jenkins_teams_config | rejectattr('team_name', 'in', exclude_teams.split(',') | map('trim') | list) | list }}"
      when: 
        - exclude_teams is defined and exclude_teams != ""
        - deploy_teams is not defined or deploy_teams == ""
      tags: ['ha', 'filter']

    - name: Apply team filtering logic for HAProxy configuration - All Teams
      set_fact:
        jenkins_teams_for_haproxy: "{{ jenkins_teams_config | default([]) }}"
      when:
        - deploy_teams is not defined or deploy_teams == ""
        - exclude_teams is not defined or exclude_teams == ""
      tags: ['ha', 'filter']
  roles:
    - role: high-availability-v2
      vars:
        jenkins_teams: "{{ jenkins_teams_for_haproxy }}"
      tags: ['ha', 'cluster', 'haproxy', 'loadbalancer']
      when: 
        - (jenkins_ha_enabled | default(false)) | bool
        - (groups['jenkins_masters'] | default([]) | length > 1) or (jenkins_teams_for_haproxy | default([]) | length > 1)

- name: Setup Monitoring Stack
  hosts: "{{ (deployment_mode | default('local') == 'local') | ternary('localhost', 'monitoring') }}"
  become: yes
  gather_facts: yes
  pre_tasks:
    - name: Apply team filtering logic for Monitoring configuration - Deploy Teams
      set_fact:
        jenkins_teams_for_monitoring: "{{ jenkins_teams_config | selectattr('team_name', 'in', deploy_teams.split(',') | map('trim') | list) | list }}"
      when: deploy_teams is defined and deploy_teams != ""
      tags: ['monitoring', 'filter']

    - name: Apply team filtering logic for Monitoring configuration - Exclude Teams
      set_fact:
        jenkins_teams_for_monitoring: "{{ jenkins_teams_config | rejectattr('team_name', 'in', exclude_teams.split(',') | map('trim') | list) | list }}"
      when: 
        - exclude_teams is defined and exclude_teams != ""
        - deploy_teams is not defined or deploy_teams == ""
      tags: ['monitoring', 'filter']

    - name: Apply team filtering logic for Monitoring configuration - All Teams
      set_fact:
        jenkins_teams_for_monitoring: "{{ jenkins_teams_config | default([]) }}"
      when:
        - deploy_teams is not defined or deploy_teams == ""
        - exclude_teams is not defined or exclude_teams == ""
      tags: ['monitoring', 'filter']
  roles:
    - role: monitoring
      vars:
        jenkins_teams: "{{ jenkins_teams_for_monitoring }}"
        jenkins_deployment_mode: "{{ 'multi-team' if jenkins_teams_for_monitoring | length > 1 else 'single-team' }}"
      tags: ['monitoring', 'prometheus', 'grafana']
      when: monitoring_enabled | default(true)

# Backup functionality is now integrated into jenkins-master-v2 role via dedicated backup daemon scripts
# Sync operations are handled by Ansible-native tasks for improved reliability and control

- name: Post-Deployment Verification
  hosts: "{{ (deployment_mode | default('local') == 'local') | ternary('localhost', 'jenkins_masters:monitoring') }}"
  become: no
  gather_facts: yes
  tasks:
    - name: Apply robust team filtering logic for verification - Deploy Teams
      set_fact:
        jenkins_teams_for_verification: "{{ jenkins_teams_config | default([]) | selectattr('team_name', 'in', deploy_teams.split(',') | map('trim') | list) | list }}"
      when: deploy_teams is defined and deploy_teams != ""
      tags: ['verify', 'filter']

    - name: Apply robust team filtering logic for verification - Exclude Teams
      set_fact:
        jenkins_teams_for_verification: "{{ jenkins_teams_config | default([]) | rejectattr('team_name', 'in', exclude_teams.split(',') | map('trim') | list) | list }}"
      when: 
        - exclude_teams is defined and exclude_teams != ""
        - deploy_teams is not defined or deploy_teams == ""
      tags: ['verify', 'filter']

    - name: Apply robust team filtering logic for verification - All Teams
      set_fact:
        jenkins_teams_for_verification: "{{ jenkins_teams_config | default([]) }}"
      when:
        - deploy_teams is not defined or deploy_teams == ""
        - exclude_teams is not defined or exclude_teams == ""
      tags: ['verify', 'filter']

    - name: Display teams for verification
      debug:
        msg: |
          [VERIFICATION] Team Filtering Summary:
          {% if jenkins_teams_for_verification | length > 0 %}
          Teams to Verify: {{ jenkins_teams_for_verification | map(attribute='team_name') | list | join(', ') }}
          Teams Count: {{ jenkins_teams_for_verification | length }}
          {% else %}
          No teams to verify (all teams filtered out)
          {% endif %}
      tags: ['verify', 'filter']

    - name: Verify Jenkins teams accessibility
      uri:
        url: "http://{{ ansible_default_ipv4.address }}:{% if item.active_environment | default('blue') == 'blue' %}{{ item.ports.web | default(8080) }}{% else %}{{ (item.ports.web | default(8080)) + 100 }}{% endif %}/api/json"
        method: GET
        user: "{{ jenkins_admin_user }}"
        password: "{{ jenkins_admin_password }}"
        force_basic_auth: yes
        status_code: [200, 403]
      register: jenkins_team_checks
      loop: "{{ jenkins_teams_for_verification | default([{'team_name': 'default', 'ports': {'web': 8080}}]) }}"
      ignore_errors: yes
      tags: ['verify', 'api']

    - name: Verify monitoring endpoints
      uri:
        url: "{{ (deployment_mode | default('local') == 'local') | ternary('http://localhost:9090/api/v1/query?query=up', 'http://' + hostvars[groups['monitoring'][0]]['ansible_default_ipv4']['address'] + ':9090/api/v1/query?query=up') }}"
        method: GET
      register: prometheus_check
      when: 
        - monitoring_enabled | default(true)
        - (deployment_mode | default('local') == 'local') or (groups['monitoring'] is defined and groups['monitoring'] | length > 0)
      ignore_errors: yes
      tags: ['verify', 'monitoring']

    - name: Display deployment summary
      debug:
        msg: |
          ğŸ‰ Jenkins Infrastructure Deployment Completed!
          
          ğŸ“‹ Team Access Information:
          {% if deployment_mode | default('local') == 'local' %}
          {% for team in jenkins_teams | default([{'team_name': 'default', 'ports': {'web': 8080}}]) %}
          {{ team.team_name | title }} Team: http://localhost:{% if team.active_environment | default('blue') == 'blue' %}{{ team.ports.web | default(8080) }}{% else %}{{ (team.ports.web | default(8080)) + 100 }}{% endif %}
          {% endfor %}
          {% else %}
          {% for host in groups['jenkins_masters'] | default([]) %}
          {% for team in jenkins_teams | default([{'team_name': 'default', 'ports': {'web': 8080}}]) %}
          {{ team.team_name | title }} Team: http://{{ hostvars[host]['ansible_default_ipv4']['address'] }}:{% if team.active_environment | default('blue') == 'blue' %}{{ team.ports.web | default(8080) }}{% else %}{{ (team.ports.web | default(8080)) + 100 }}{% endif %}
          {% endfor %}
          {% endfor %}
          {% endif %}
          {% if jenkins_ha_enabled | default(false) %}
          Load Balancer: http://{{ ansible_default_ipv4.address | default(inventory_hostname) }}:{{ jenkins_port | default(80) }}
          {% endif %}
          {% if monitoring_enabled | default(true) %}
          {% if deployment_mode | default('local') == 'local' %}
          Prometheus: http://localhost:9090
          Grafana: http://localhost:3000
          {% elif groups['monitoring'] is defined and groups['monitoring'] | length > 0 %}
          Prometheus: http://{{ hostvars[groups['monitoring'][0]]['ansible_default_ipv4']['address'] }}:9090
          Grafana: http://{{ hostvars[groups['monitoring'][0]]['ansible_default_ipv4']['address'] }}:3000
          {% endif %}
          {% endif %}
          
          ğŸ”§ Default Credentials:
          Username: {{ jenkins_admin_user }}
          Password: [ENCRYPTED - Check vault]
          
          ğŸ”§ Management Scripts (per team):
          {% for team in jenkins_teams | default([{'team_name': 'default'}]) %}
          â€¢ {{ team.team_name | title }} Blue-Green Switch: /var/jenkins/scripts/blue-green-switch-{{ team.team_name }}.sh
          â€¢ {{ team.team_name | title }} Health Check: /var/jenkins/scripts/blue-green-healthcheck-{{ team.team_name }}.sh
          {% endfor %}
          
          ğŸ·ï¸ Available Agent Labels (per team):
          {% for team in jenkins_teams | default([{'team_name': 'default'}]) %}
          â€¢ {{ team.team_name }}-maven (Java/Maven builds)
          â€¢ {{ team.team_name }}-python (Python builds) 
          â€¢ {{ team.team_name }}-nodejs (Node.js/Frontend builds)
          â€¢ {{ team.team_name }}-dind (Docker-in-Docker builds)
          {% endfor %}
          
          ğŸ“Š Monitoring Status: {{ monitoring_enabled | default(true) and 'Enabled' or 'Disabled' }}
          ğŸ’¾ Backup Status: {{ backup_enabled | default(true) and 'Enabled' or 'Disabled' }}
          ğŸ”ï¸ HA Status: {{ jenkins_ha_enabled | default(false) and 'Active' or 'Single Node' }}
          
          ğŸ“Š Blue-Green Status:
          â€¢ All teams start with BLUE environment active
          â€¢ Use switch scripts for zero-downtime deployments
          â€¢ HAProxy provides load balancing and health checks
      tags: ['verify', 'summary']