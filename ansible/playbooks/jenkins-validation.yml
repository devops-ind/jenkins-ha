---
# Jenkins Post-Deployment Validation
# Validates passive Jenkins environment is identical to active

- name: Validate Jenkins Deployment
  hosts: "{{ target_vm | default('jenkins_masters') }}"
  gather_facts: yes

  pre_tasks:
    - name: Load jenkins_teams configuration
      set_fact:
        jenkins_teams_config: "{{ lookup('file', inventory_dir + '/group_vars/all/jenkins_teams.yml') | from_yaml | json_query('jenkins_teams') }}"

    - name: Resolve host IP address
      set_fact:
        jenkins_host_ip: >-
          {%- if ansible_host is defined -%}
          {{ ansible_host }}
          {%- elif ansible_default_ipv4 is defined and ansible_default_ipv4.address is defined -%}
          {{ ansible_default_ipv4.address }}
          {%- elif ansible_all_ipv4_addresses is defined and ansible_all_ipv4_addresses | length > 0 -%}
          {{ ansible_all_ipv4_addresses[0] }}
          {%- else -%}
          127.0.0.1
          {%- endif -%}

  vars:
    jenkins_teams_filtered: "{{ jenkins_teams_config if deploy_teams is not defined or deploy_teams == 'all' else (jenkins_teams_config | selectattr('team_name', 'in', deploy_teams.split(',') | map('trim') | list) | list) }}"

  tasks:
    - name: Calculate passive environment details for each team
      set_fact:
        team_passive_envs: >-
          {{
            jenkins_teams_filtered | map('combine', {
              'passive_environment': ('green' if (item.active_environment | default('blue') == 'blue') else 'blue'),
              'passive_port': ((item.ports.web + 100) if (item.active_environment | default('blue') == 'blue') else item.ports.web)
            })
          }}
      loop: "{{ jenkins_teams_filtered }}"
      run_once: true

    - name: Display validation summary
      debug:
        msg: |
          ====================================================
          Jenkins Post-Deployment Validation (PASSIVE Environment)
          ====================================================
          Target VM: {{ inventory_hostname }}
          Teams: {{ jenkins_teams_filtered | map(attribute='team_name') | join(', ') }}

          Validation Target: PASSIVE (newly deployed) environments
          {% for team in jenkins_teams_filtered %}
          - {{ team.team_name }}: {{ 'green' if team.active_environment | default('blue') == 'blue' else 'blue' }} environment (port {{ (team.ports.web + 100) if team.active_environment | default('blue') == 'blue' else team.ports.web }})
          {% endfor %}

          Note: In resource-optimized architecture, passive containers
          only exist during deployment/validation window.
          ====================================================

    - name: Check if PASSIVE containers exist
      command: >
        docker inspect --format='exists' jenkins-{{ item.team_name }}-{{ 'green' if item.active_environment | default('blue') == 'blue' else 'blue' }}
      loop: "{{ jenkins_teams_filtered }}"
      loop_control:
        label: "{{ item.team_name }} (passive={{ 'green' if item.active_environment | default('blue') == 'blue' else 'blue' }})"
      register: container_existence
      failed_when: false
      changed_when: false

    - name: Container health check - verify PASSIVE containers running
      command: >
        docker inspect --format='{{ '{{' }}.State.Status{{ '}}' }}'
        jenkins-{{ item.item.team_name }}-{{ 'green' if item.item.active_environment | default('blue') == 'blue' else 'blue' }}
      loop: "{{ container_existence.results }}"
      loop_control:
        label: "{{ item.item.team_name }} (passive={{ 'green' if item.item.active_environment | default('blue') == 'blue' else 'blue' }})"
      register: container_status
      when: item.rc == 0
      failed_when: container_status.stdout != 'running'
      changed_when: false

    - name: Display container existence summary
      debug:
        msg: |
          ====================================================
          Container Existence Check
          ====================================================
          {% for result in container_existence.results %}
          {{ result.item.team_name }} (passive={{ 'green' if result.item.active_environment | default('blue') == 'blue' else 'blue' }}): {% if result.rc == 0 %}EXISTS{% else %}NOT FOUND (not deployed yet){% endif %}
          {% endfor %}
          ====================================================

    - name: HTTP endpoint validation - verify PASSIVE Jenkins responding
      uri:
        url: "http://{{ jenkins_host_ip }}:{% if (item.item.active_environment | default('blue') == 'blue') %}{{ item.item.ports.web + 100 }}{% else %}{{ item.item.ports.web }}{% endif %}/login"
        method: GET
        status_code: [200, 403]
        timeout: 30
      loop: "{{ container_existence.results }}"
      loop_control:
        label: "{{ item.item.team_name }} (passive_port={% if (item.item.active_environment | default('blue') == 'blue') %}{{ item.item.ports.web + 100 }}{% else %}{{ item.item.ports.web }}{% endif %})"
      register: http_health
      when: item.rc == 0
      retries: 5
      delay: 10
      until: http_health.status in [200, 403]

    - name: Check Jenkins process inside PASSIVE container
      command: >
        docker exec jenkins-{{ item.item.team_name }}-{{ 'green' if item.item.active_environment | default('blue') == 'blue' else 'blue' }}
        pgrep -f jenkins.war
      loop: "{{ container_existence.results }}"
      loop_control:
        label: "{{ item.item.team_name }} (passive={{ 'green' if item.item.active_environment | default('blue') == 'blue' else 'blue' }})"
      register: jenkins_process
      when: item.rc == 0
      failed_when: jenkins_process.rc != 0
      changed_when: false

    - name: Display validation results
      debug:
        msg: |
          ====================================================
          Validation Results (Passive Environment)
          ====================================================
          {% for result in container_existence.results %}
          Team: {{ result.item.team_name }} (passive={{ 'green' if result.item.active_environment | default('blue') == 'blue' else 'blue' }})
          {% if result.rc == 0 %}
          ✓ Container Exists: YES
          ✓ Container Status: RUNNING
          ✓ HTTP Health: PASSED
          ✓ Jenkins Process: RUNNING
          {% else %}
          ⊘ Container Exists: NO (not deployed to passive yet)
          ⊘ Validation: SKIPPED
          {% endif %}
          {% endfor %}
          ====================================================
          Overall Result: {% if container_existence.results | selectattr('rc', 'equalto', 0) | list | length > 0 %}✅ VALIDATION PASSED for deployed containers{% else %}⚠️  NO PASSIVE CONTAINERS DEPLOYED{% endif %}

          Note: This is expected in resource-optimized deployments.
          Passive containers are only created during deployment.
          ====================================================
