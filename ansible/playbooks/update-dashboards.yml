---
# Quick Grafana dashboard update via API (no restart required)
# Usage: ansible-playbook -i $PROD_INV playbooks/update-dashboards.yml
- name: Update Grafana Dashboards via API
  hosts: monitoring
  gather_facts: yes

  tasks:
    - name: Wait for Grafana to be ready
      uri:
        url: "http://{{ ansible_default_ipv4.address }}:{{ grafana_port }}/api/health"
        method: GET
        status_code: 200
      register: grafana_health
      until: grafana_health.status == 200
      retries: 30
      delay: 5

    - name: Deploy JSON dashboards via API
      uri:
        url: "http://{{ ansible_default_ipv4.address }}:{{ grafana_port }}/api/dashboards/db"
        method: POST
        user: "{{ grafana_admin_user }}"
        password: "{{ grafana_admin_password }}"
        body_format: json
        body:
          dashboard: "{{ lookup('file', role_path + '/files/dashboards/json/' + item) | from_json }}"
          overwrite: true
          message: "Updated via Ansible API"
        status_code: 200
        force_basic_auth: yes
      loop: "{{ grafana_json_dashboards }}"
      when:
        - grafana_json_enabled | default(false)
        - grafana_json_dashboards is defined
        - grafana_json_dashboards | length > 0
      vars:
        role_path: "{{ playbook_dir }}/../roles/monitoring"

    - name: Summary
      debug:
        msg: "Dashboard update completed. Check Grafana UI at http://{{ ansible_default_ipv4.address }}:{{ grafana_port }}"
