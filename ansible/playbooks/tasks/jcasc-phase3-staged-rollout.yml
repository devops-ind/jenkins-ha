---
# JCasC Phase 3: Staged Rollout
# - Applies config to inactive environment first
# - Performs health checks and smoke tests
# - Manual approval gate before traffic switch
# - Switches HAProxy traffic (blue-green)
# - Updates former active environment
# - Auto-rollback on any failure

- name: "Phase 3: Staged Rollout - Initialize"
  debug:
    msg: |
      ========================================
      Phase 3: Staged Rollout
      ========================================
      Team: {{ current_team }}
      Manual Approval: {{ require_manual_approval | default(true) }}
      ========================================

# Step 3.1: Apply to Inactive Environment
- name: "Phase 3.1: Apply to Inactive Environment"
  block:
    # Sub-step A: Pre-deployment Checks
    - name: "Phase 3.1.A: Determine inactive environment"
      set_fact:
        team_config: "{{ jenkins_teams | selectattr('team_name', 'equalto', current_team) | first }}"

    - name: "Phase 3.1.A: Set active and inactive environments"
      set_fact:
        active_env: "{{ team_config.active_environment | default('blue') }}"
        inactive_env: "{{ 'green' if (team_config.active_environment | default('blue')) == 'blue' else 'blue' }}"

    - name: "Phase 3.1.A: Display environment info"
      debug:
        msg: |
          Team: {{ current_team }}
          Active Environment: {{ active_env }}
          Inactive Environment: {{ inactive_env }}
          Will deploy to: {{ inactive_env }} (inactive)

    - name: "Phase 3.1.A: Get inactive environment port"
      set_fact:
        inactive_port: "{{ team_config.ports.web if inactive_env == 'blue' else (team_config.ports.web + 100) }}"
        active_port: "{{ team_config.ports.web if active_env == 'blue' else (team_config.ports.web + 100) }}"

    - name: "Phase 3.1.A: Check for running builds on inactive environment"
      uri:
        url: "http://{{ ansible_host }}:{{ inactive_port }}/api/json?tree=jobs[name,builds[number,running]]"
        method: GET
        return_content: yes
        status_code: [200, 403]
      register: running_builds_check
      ignore_errors: yes
      failed_when: false

    - name: "Phase 3.1.A: Display running builds warning"
      debug:
        msg: |
          WARNING: Found running builds on {{ current_team }} {{ inactive_env }}
          This is unusual for inactive environment but proceeding...
      when:
        - running_builds_check.status == 200
        - running_builds_check.json.jobs is defined
        - running_builds_check.json.jobs | selectattr('builds', 'defined') | selectattr('builds', '!=', []) | list | length > 0

    # Sub-step B: Config Deployment
    - name: "Phase 3.1.B: Copy rendered config to VM"
      copy:
        src: "/tmp/jcasc-validation/{{ current_team }}/jenkins.yaml"
        dest: "{{ jenkins_base_path | default('/var/jenkins') }}/{{ current_team }}/configs/proposed.yaml"
        mode: '0644'

    - name: "Phase 3.1.B: Backup current config"
      copy:
        src: "{{ jenkins_base_path | default('/var/jenkins') }}/{{ current_team }}/configs/current.yaml"
        dest: "{{ jenkins_base_path | default('/var/jenkins') }}/{{ current_team }}/backups/current.yaml.{{ ansible_date_time.epoch }}"
        remote_src: yes
      ignore_errors: yes

    - name: "Phase 3.1.B: Cleanup old backups (keep last 10)"
      shell: |
        cd {{ jenkins_base_path | default('/var/jenkins') }}/{{ current_team }}/backups
        ls -t current.yaml.* 2>/dev/null | tail -n +11 | xargs -r rm -f
        echo "Cleaned up old backups"
      args:
        executable: /bin/bash
      ignore_errors: yes

    - name: "Phase 3.1.B: Update environment-specific config"
      copy:
        src: "{{ jenkins_base_path | default('/var/jenkins') }}/{{ current_team }}/configs/proposed.yaml"
        dest: "{{ jenkins_base_path | default('/var/jenkins') }}/{{ current_team }}/configs/{{ inactive_env }}.yaml"
        remote_src: yes
        mode: '0644'

    - name: "Phase 3.1.B: Update current.yaml symlink"
      file:
        src: "{{ jenkins_base_path | default('/var/jenkins') }}/{{ current_team }}/configs/{{ inactive_env }}.yaml"
        dest: "{{ jenkins_base_path | default('/var/jenkins') }}/{{ current_team }}/configs/current.yaml"
        state: link
        force: yes
      when: jenkins_config_mode | default('symlink') == 'symlink'

    - name: "Phase 3.1.B: Copy to current.yaml (file mode)"
      copy:
        src: "{{ jenkins_base_path | default('/var/jenkins') }}/{{ current_team }}/configs/{{ inactive_env }}.yaml"
        dest: "{{ jenkins_base_path | default('/var/jenkins') }}/{{ current_team }}/configs/current.yaml"
        remote_src: yes
        mode: '0644'
      when: jenkins_config_mode | default('symlink') == 'file'

    # Sub-step C: JCasC Reload
    - name: "Phase 3.1.C: Trigger JCasC reload on inactive container"
      uri:
        url: "http://{{ ansible_host }}:{{ inactive_port }}/configuration-as-code/reload"
        method: POST
        user: "{{ jenkins_admin_user }}"
        password: "{{ jenkins_admin_token }}"
        force_basic_auth: yes
        status_code: [200, 201, 204]
        timeout: 60
      register: reload_response
      retries: 3
      delay: 5

    - name: "Phase 3.1.C: Display reload response"
      debug:
        msg: "JCasC reload triggered successfully on {{ inactive_env }} - Status: {{ reload_response.status }}"

    # Sub-step D: Multi-Layer Health Checks
    - name: "Phase 3.1.D: HTTP health check on inactive environment"
      uri:
        url: "http://{{ ansible_host }}:{{ inactive_port }}/api/json"
        method: GET
        status_code: 200
      register: health_check
      retries: 5
      delay: 5
      until: health_check.status == 200

    - name: "Phase 3.1.D: Verify container health"
      shell: |
        docker ps --filter "name=jenkins-{{ current_team }}-{{ inactive_env }}" --format "{{{{.Status}}}}"
      register: container_health
      failed_when: "'Up' not in container_health.stdout"

    - name: "Phase 3.1.D: Check JCasC application in logs"
      shell: |
        docker logs jenkins-{{ current_team }}-{{ inactive_env }} 2>&1 | tail -100 | grep -i "configuration as code"
      register: jcasc_logs
      failed_when: false
      changed_when: false

    - name: "Phase 3.1.D: Display JCasC log status"
      debug:
        msg: "JCasC plugin is active on {{ inactive_env }}"
      when: jcasc_logs.rc == 0

    - name: "Phase 3.1.D: Run smoke tests on inactive environment"
      include_tasks: smoke-tests.yml
      vars:
        jenkins_test_url: "http://{{ ansible_host }}:{{ inactive_port }}"
        jenkins_test_team: "{{ current_team }}"

    - name: "Phase 3.1: Inactive Environment Update Complete"
      debug:
        msg: |
          ========================================
          Phase 3.1: Inactive Environment Update COMPLETED
          ========================================
          Team: {{ current_team }}
          Environment: {{ inactive_env }}
          Status: SUCCESS
          All health checks passed
          Ready for approval gate
          ========================================

  rescue:
    # Sub-step E: Auto-Rollback on Failure
    - name: "Phase 3.1.E: ROLLBACK - Restore from latest backup"
      shell: |
        BACKUP_DIR="{{ jenkins_base_path | default('/var/jenkins') }}/{{ current_team }}/backups"
        LATEST_BACKUP=$(ls -t $BACKUP_DIR/current.yaml.* 2>/dev/null | head -1)

        if [ -n "$LATEST_BACKUP" ]; then
          cp "$LATEST_BACKUP" "{{ jenkins_base_path | default('/var/jenkins') }}/{{ current_team }}/configs/current.yaml"
          echo "Restored from backup: $LATEST_BACKUP"
          exit 0
        else
          echo "ERROR: No backup found for rollback"
          exit 1
        fi
      register: restore_result

    - name: "Phase 3.1.E: ROLLBACK - Trigger reload with restored config"
      uri:
        url: "http://{{ ansible_host }}:{{ inactive_port }}/configuration-as-code/reload"
        method: POST
        user: "{{ jenkins_admin_user }}"
        password: "{{ jenkins_admin_token }}"
        force_basic_auth: yes
        status_code: [200, 201, 204]
      ignore_errors: yes

    - name: "Phase 3.1.E: ROLLBACK - Log rollback event"
      lineinfile:
        path: "{{ jenkins_audit_log | default('/var/log/jenkins/jcasc-updates.log') }}"
        create: yes
        line: "[{{ ansible_date_time.iso8601 }}] [{{ current_team }}] [ROLLBACK] Stage: Inactive Update | Reason: {{ ansible_failed_result.msg | default('Unknown error') }} | Operator: {{ ansible_user_id }}"

    - name: "Phase 3.1.E: ROLLBACK - Fail with context"
      fail:
        msg: |
          ========================================
          ROLLBACK APPLIED
          ========================================
          Team: {{ current_team }}
          Environment: {{ inactive_env }}
          Stage: Inactive environment update
          Reason: {{ ansible_failed_result.msg | default('Health check or reload failed') }}

          Automatic rollback has been applied
          Previous config restored from backup
          ========================================

# Step 3.2: Manual Approval Gate
- name: "Phase 3.2: Manual Approval Gate"
  block:
    - name: "Phase 3.2: Display approval summary"
      debug:
        msg: |
          ========================================
          MANUAL APPROVAL REQUIRED
          ========================================
          Team: {{ current_team }}
          Inactive Environment: {{ inactive_env }} - VALIDATED ✓
          Active Environment: {{ active_env }} - Currently receiving traffic

          Validation Summary:
            - Phase 1: Pre-Validation ✓
            - Phase 2: Plugin Compatibility ✓
            - Phase 3.1: Inactive Environment Update ✓
            - All health checks passed ✓
            - Smoke tests passed ✓

          Next Step: Switch HAProxy traffic
            FROM: {{ active_env }} (port {{ active_port }})
            TO:   {{ inactive_env }} (port {{ inactive_port }})

          Review metrics: http://{{ monitoring_host | default('monitoring') }}:9300/d/jcasc-updates
          ========================================

    - name: "Phase 3.2: Pause for manual approval"
      pause:
        prompt: |

          Press ENTER to approve traffic switch to validated environment
          Press Ctrl+C then 'A' to abort

      when: require_manual_approval | default(true) | bool

    - name: "Phase 3.2: Manual approval granted"
      debug:
        msg: "Manual approval granted - Proceeding with traffic switch"

  when: require_manual_approval | default(true) | bool

# Step 3.3: Blue-Green Traffic Switch
- name: "Phase 3.3: Blue-Green Traffic Switch"
  block:
    - name: "Phase 3.3: Display traffic switch plan"
      debug:
        msg: |
          ========================================
          HAProxy Traffic Switch
          ========================================
          Team: {{ current_team }}
          FROM: {{ active_env }} → TO: {{ inactive_env }}
          ========================================

    - name: "Phase 3.3: Switch HAProxy traffic via Runtime API"
      shell: |
        # Set old active backend to maintenance
        echo "Setting {{ active_env }} backend to maintenance..."
        curl -X POST \
          -u "{{ haproxy_admin_user | default('admin') }}:{{ haproxy_admin_password | default('admin123') }}" \
          "http://{{ haproxy_host | default(ansible_host) }}:8404/v2/services/haproxy/runtime/servers/state/jenkins-{{ current_team }}-{{ active_env }}/ready" \
          -H "Content-Type: application/json" \
          -d '{"admin_state":"maint"}' || echo "Old backend set to maint (or manual config needed)"

        # Set new inactive backend to ready
        echo "Setting {{ inactive_env }} backend to ready..."
        curl -X POST \
          -u "{{ haproxy_admin_user | default('admin') }}:{{ haproxy_admin_password | default('admin123') }}" \
          "http://{{ haproxy_host | default(ansible_host) }}:8404/v2/services/haproxy/runtime/servers/state/jenkins-{{ current_team }}-{{ inactive_env }}/ready" \
          -H "Content-Type: application/json" \
          -d '{"admin_state":"ready"}' || echo "New backend set to ready (or manual config needed)"

        echo "Traffic switch initiated"
      args:
        executable: /bin/bash
      register: haproxy_switch
      ignore_errors: yes

    - name: "Phase 3.3: Update environment tracking file"
      copy:
        content: "{{ inactive_env }}"
        dest: "{{ jenkins_base_path | default('/var/jenkins') }}/{{ current_team }}/active-environment"
        mode: '0644'

    - name: "Phase 3.3: Grace period for traffic switch"
      pause:
        seconds: 60
        prompt: "Waiting 60 seconds for traffic to stabilize..."

    - name: "Phase 3.3: Traffic switch complete"
      debug:
        msg: |
          ========================================
          Traffic Switch COMPLETED
          ========================================
          Team: {{ current_team }}
          New Active: {{ inactive_env }}
          Traffic now flowing to validated environment
          ========================================

# Step 3.4: Update Former Active Environment
- name: "Phase 3.4: Update Former Active (now inactive)"
  block:
    - name: "Phase 3.4: Display update plan"
      debug:
        msg: |
          ========================================
          Updating Former Active Environment
          ========================================
          Team: {{ current_team }}
          Environment: {{ active_env }} (now inactive)
          ========================================

    - name: "Phase 3.4: Update config on former active"
      copy:
        src: "{{ jenkins_base_path | default('/var/jenkins') }}/{{ current_team }}/configs/proposed.yaml"
        dest: "{{ jenkins_base_path | default('/var/jenkins') }}/{{ current_team }}/configs/{{ active_env }}.yaml"
        remote_src: yes
        mode: '0644'

    - name: "Phase 3.4: Trigger JCasC reload on former active"
      uri:
        url: "http://{{ ansible_host }}:{{ active_port }}/configuration-as-code/reload"
        method: POST
        user: "{{ jenkins_admin_user }}"
        password: "{{ jenkins_admin_token }}"
        force_basic_auth: yes
        status_code: [200, 201, 204]
        timeout: 60
      register: former_active_reload
      retries: 3
      delay: 5

    - name: "Phase 3.4: Health check on former active"
      uri:
        url: "http://{{ ansible_host }}:{{ active_port }}/api/json"
        method: GET
        status_code: 200
      register: former_active_health
      retries: 5
      delay: 5
      until: former_active_health.status == 200

    - name: "Phase 3.4: Both environments synchronized"
      debug:
        msg: |
          ========================================
          Both Environments Synchronized
          ========================================
          Team: {{ current_team }}
          {{ inactive_env }}: Updated ✓ (Active - receiving traffic)
          {{ active_env }}: Updated ✓ (Standby)
          ========================================

# Update config state tracking
- name: "Phase 3: Update config state tracking"
  copy:
    content: |
      {
        "active_config": "{{ inactive_env }}",
        "previous_config": "{{ active_env }}",
        "last_update": "{{ ansible_date_time.iso8601 }}",
        "last_update_by": "{{ ansible_user_id }}",
        "last_validation_timestamp": "{{ ansible_date_time.iso8601 }}",
        "last_validation_status": "success",
        "plugin_compatibility_tested": true,
        "smoke_tests_passed": true,
        "rollback_available": true,
        "haproxy_switched": true,
        "manual_approval_granted": {{ require_manual_approval | default(true) }},
        "approval_timestamp": "{{ ansible_date_time.iso8601 }}"
      }
    dest: "{{ jenkins_base_path | default('/var/jenkins') }}/{{ current_team }}/config-state.json"
    mode: '0644'

# Log successful update
- name: "Phase 3: Log successful update to audit log"
  lineinfile:
    path: "{{ jenkins_audit_log | default('/var/log/jenkins/jcasc-updates.log') }}"
    create: yes
    line: "[{{ ansible_date_time.iso8601 }}] [{{ current_team }}] [UPDATE] Status: SUCCESS | Operator: {{ ansible_user_id }} | Active: {{ inactive_env }} | Method: Blue-Green"

- name: "Phase 3: Staged Rollout Complete"
  debug:
    msg: |
      ========================================
      Phase 3: Staged Rollout COMPLETED
      ========================================
      Team: {{ current_team }}
      Status: SUCCESS
      Active Environment: {{ inactive_env }}
      Both environments synchronized
      Zero-downtime deployment achieved
      ========================================
