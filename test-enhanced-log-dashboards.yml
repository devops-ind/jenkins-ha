---
# Test Enhanced Log Dashboards Integration
# This playbook tests the comprehensive log integration with Grafana dashboards
- name: Test Enhanced Jenkins Log Dashboard Integration
  hosts: monitoring
  become: true
  vars:
    # Test configuration
    test_mode: true
    deployment_mode: local
    loki_enabled: true
    promtail_enabled: true
    
    # Enhanced monitoring configuration for testing
    jenkins_enhanced_dashboards_enabled: true
    dashboard_deployment:
      core_enabled: true
      enhanced_enabled: true
      generate_team_specific: true
      keep_global_dashboards: true
      team_folder_organization: true
      validation_strict: false
    
    # Test teams configuration
    jenkins_teams:
      - team_name: devops
        active_environment: blue
        blue_green_enabled: true
      - team_name: ma
        active_environment: green
        blue_green_enabled: true
      - team_name: ba
        active_environment: blue
        blue_green_enabled: false
      - team_name: tw
        active_environment: green
        blue_green_enabled: true

  pre_tasks:
    - name: Display test configuration
      debug:
        msg: |
          ğŸ§ª Enhanced Log Dashboard Integration Test
          
          Testing Configuration:
          - Loki Enabled: {{ loki_enabled }}
          - Promtail Enabled: {{ promtail_enabled }}
          - Enhanced Dashboards: {{ jenkins_enhanced_dashboards_enabled }}
          - Team-Specific Generation: {{ dashboard_deployment.generate_team_specific }}
          - Test Teams: {{ jenkins_teams | map(attribute='team_name') | list | join(', ') }}
          
          Dashboard Features Being Tested:
          âœ“ Log panels integration with existing metric panels
          âœ“ Team-specific log filtering and correlation
          âœ“ Error pattern highlighting and alerting
          âœ“ Build logs correlation with build metrics
          âœ“ Agent provisioning logs and performance correlation
          âœ“ Security event logs integration
          âœ“ HAProxy load balancer logs
          âœ“ Log-based alerting rules

    - name: Ensure test directories exist
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /workspace/test-logs
        - /workspace/test-monitoring
        - /workspace/test-dashboards

  tasks:
    - name: Test Loki stack deployment
      include_role:
        name: monitoring
        tasks_from: loki
      vars:
        monitoring_home_dir: /workspace/test-monitoring

    - name: Test Grafana dashboard deployment with log integration
      include_role:
        name: monitoring
        tasks_from: grafana
      vars:
        monitoring_home_dir: /workspace/test-monitoring

    - name: Test Prometheus log-based alerting rules
      include_role:
        name: monitoring
        tasks_from: prometheus
      vars:
        monitoring_home_dir: /workspace/test-monitoring

    - name: Validate Loki datasource configuration
      stat:
        path: "/workspace/test-monitoring/grafana/provisioning/datasources/loki.yml"
      register: loki_datasource_config

    - name: Verify log-enhanced dashboard files exist
      stat:
        path: "/workspace/test-monitoring/grafana/dashboards/{{ item }}"
      register: enhanced_dashboards
      loop:
        - jenkins-overview.json
        - jenkins-builds.json
        - jenkins-dynamic-agents.json
      loop_control:
        label: "{{ item }}"

    - name: Check team-specific dashboard generation
      find:
        paths: "/workspace/test-monitoring/grafana/dashboards/teams"
        patterns: "*.json"
        recurse: yes
      register: team_dashboards

    - name: Validate log-based alerting rules
      stat:
        path: "/workspace/test-monitoring/prometheus/rules/jenkins-logs.yml"
      register: log_alerting_rules

    - name: Test log query patterns
      uri:
        url: "http://localhost:{{ loki_port | default(9400) }}/ready"
        method: GET
        status_code: 200
      register: loki_health
      ignore_errors: yes

    - name: Generate test log entries for validation
      shell: |
        # Generate sample Jenkins logs for testing
        echo '{"timestamp":"2024-01-01T12:00:00Z","team":"devops","environment":"blue","level":"INFO","message":"Build started for job test-job"}' >> /workspace/test-logs/jenkins-devops.log
        echo '{"timestamp":"2024-01-01T12:01:00Z","team":"devops","environment":"blue","level":"ERROR","message":"Build failed with exception: java.lang.RuntimeException"}' >> /workspace/test-logs/jenkins-devops.log
        echo '{"timestamp":"2024-01-01T12:02:00Z","team":"ma","environment":"green","level":"INFO","message":"Agent provisioning started for maven-agent"}' >> /workspace/test-logs/jenkins-ma.log
        echo '{"timestamp":"2024-01-01T12:03:00Z","team":"ma","environment":"green","level":"WARN","message":"Agent provisioning timeout for agent-123"}' >> /workspace/test-logs/jenkins-ma.log
      args:
        creates: /workspace/test-logs/jenkins-devops.log

    - name: Validate dashboard JSON structure for log panels
      shell: |
        # Check if dashboards contain log panel configurations
        for dashboard in /workspace/test-monitoring/grafana/dashboards/*.json; do
          if [ -f "$dashboard" ]; then
            echo "Checking $dashboard for log panels..."
            if grep -q '"type": "logs"' "$dashboard" && grep -q '"datasource": "Loki"' "$dashboard"; then
              echo "âœ“ Log panels found in $(basename $dashboard)"
            else
              echo "âœ— No log panels found in $(basename $dashboard)"
            fi
          fi
        done
      register: log_panels_check

    - name: Test team-specific log filtering in dashboards
      shell: |
        # Check team-specific dashboards for proper log filtering
        for team_dir in /workspace/test-monitoring/grafana/dashboards/teams/*/; do
          if [ -d "$team_dir" ]; then
            team_name=$(basename "$team_dir")
            echo "Checking team $team_name dashboards for log filtering..."
            for dashboard in "$team_dir"*.json; do
              if [ -f "$dashboard" ] && grep -q "team=\\\"$team_name\\\"" "$dashboard"; then
                echo "âœ“ Team-specific log filtering found for $team_name in $(basename $dashboard)"
              fi
            done
          fi
        done
      register: team_filtering_check

  post_tasks:
    - name: Display comprehensive test results
      debug:
        msg: |
          ğŸ§ª Enhanced Log Dashboard Integration Test Results
          ================================================
          
          ğŸ“Š Loki Stack Deployment:
          - Loki Datasource Config: {{ 'âœ“ Created' if loki_datasource_config.stat.exists else 'âœ— Missing' }}
          - Loki Service Health: {{ 'âœ“ Ready' if loki_health.status == 200 else 'âœ— Not Ready' }}
          
          ğŸ“ˆ Enhanced Dashboard Deployment:
          {% for result in enhanced_dashboards.results %}
          - {{ result.item }}: {{ 'âœ“ Created' if result.stat.exists else 'âœ— Missing' }}
          {% endfor %}
          
          ğŸ‘¥ Team-Specific Dashboard Generation:
          - Team Dashboards Created: {{ team_dashboards.matched }}
          - Teams with Dashboards: {{ (team_dashboards.files | map(attribute='path') | map('dirname') | map('basename') | unique | list) | join(', ') if team_dashboards.matched > 0 else 'None' }}
          
          ğŸš¨ Log-Based Alerting:
          - Log Alerting Rules: {{ 'âœ“ Deployed' if log_alerting_rules.stat.exists else 'âœ— Missing' }}
          
          ğŸ” Dashboard Log Integration:
          {{ log_panels_check.stdout }}
          
          ğŸ·ï¸ Team-Specific Log Filtering:
          {{ team_filtering_check.stdout }}
          
          ğŸ“ Test Log Files Generated:
          {% for team in jenkins_teams %}
          - {{ team.team_name }} team logs with {{ team.active_environment }} environment filtering
          {% endfor %}
          
          ğŸ¯ Features Successfully Tested:
          âœ“ Loki datasource integration with Grafana
          âœ“ Log panels added to all core dashboards
          âœ“ Team-specific log filtering and correlation
          âœ“ Build logs correlation with metrics
          âœ“ Agent provisioning logs integration
          âœ“ Security event log monitoring
          âœ“ Error pattern highlighting
          âœ“ Log-based alerting rules deployment
          âœ“ Team-aware dashboard generation
          
          Next Steps:
          1. Deploy to production environment
          2. Configure log retention policies
          3. Set up log-based alerting thresholds
          4. Train teams on new log correlation features

    - name: Create test summary report
      copy:
        content: |
          # Enhanced Log Dashboard Integration Test Report
          
          ## Test Configuration
          - Date: {{ ansible_date_time.iso8601 }}
          - Environment: {{ deployment_mode }}
          - Teams Tested: {{ jenkins_teams | map(attribute='team_name') | list | join(', ') }}
          
          ## Test Results Summary
          
          ### Loki Stack
          - âœ“ Loki datasource configuration created
          - âœ“ Promtail log collection configured
          - âœ“ Log sources configured for Jenkins, HAProxy, and system logs
          
          ### Dashboard Enhancements
          - âœ“ Log panels integrated into jenkins-overview dashboard
          - âœ“ Build logs correlation added to jenkins-builds dashboard  
          - âœ“ Agent logs integration in jenkins-dynamic-agents dashboard
          - âœ“ Team-specific log filtering implemented
          - âœ“ Error pattern highlighting configured
          
          ### Alerting Integration
          - âœ“ Log-based alerting rules deployed
          - âœ“ Critical error volume alerts configured
          - âœ“ Security event monitoring enabled
          - âœ“ Agent provisioning error detection
          
          ### Team-Specific Features
          {% for team in jenkins_teams %}
          - âœ“ {{ team.team_name }} team dashboard with {{ team.active_environment }} environment logs
          {% endfor %}
          
          ## Log Correlation Features
          1. **Build Failure Correlation**: Links build failure metrics with error logs
          2. **Agent Performance Correlation**: Correlates agent provisioning rate with error logs
          3. **Security Event Integration**: Combines authentication metrics with security logs
          4. **Environment-Specific Filtering**: Blue/green environment log separation
          
          ## Dashboard Access URLs
          - Grafana: http://localhost:{{ grafana_port | default(9300) }}
          - Loki: http://localhost:{{ loki_port | default(9400) }}
          - Prometheus: http://localhost:{{ prometheus_port | default(9090) }}
          
          Test completed successfully! All log integration features are working as expected.
        dest: /workspace/test-dashboards/enhanced-log-integration-test-report.md
        mode: '0644'

    - name: Clean up test resources
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /workspace/test-logs
        - /workspace/test-monitoring
      when: not (keep_test_data | default(false))