#!/usr/bin/env groovy

pipeline {
    agent {
        label 'python'
    }
    
    options {
        buildDiscarder(logRotator(daysToKeepStr: '30', numToKeepStr: '20'))
        timeout(time: 2, unit: 'HOURS')
        timestamps()
        ansiColor('xterm')
    }
    
    environment {
        DOCKER_REGISTRY = "docker.io"
        DOCKER_PROJECT = "jenkins"
        JENKINS_VERSION = "${JENKINS_VERSION}"
        AGENT_VERSION = "${JENKINS_AGENT_VERSION}"
        BUILD_DATE = sh(script: 'date -u +"%Y-%m-%dT%H:%M:%SZ"', returnStdout: true).trim()
        GIT_COMMIT = sh(script: 'git rev-parse HEAD', returnStdout: true).trim()
        IMAGE_TAG = "${(params.IMAGE_TAG != 'latest') ? params.IMAGE_TAG : env.BUILD_NUMBER}"
        DOCKER_BUILDKIT = '1'
        COMPOSE_DOCKER_CLI_BUILD = '1'
    }
    
    stages {
        stage('Checkout Code') {
            steps {
                script {
                    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                    echo "ğŸ“¦ Checking out repository..."
                    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                }

                checkout scm

                script {
                    // Verify repository contents
                    sh '''
                        echo "âœ… Repository checked out successfully"
                        echo ""
                        echo "Verifying required directories..."
                        ls -la ansible/ || echo "Warning: ansible/ not found"
                        ls -la scripts/ || echo "Warning: scripts/ not found"
                    '''
                }
            }
        }

        stage('Preparation') {
            steps {
                script {
                    echo "ğŸš€ Jenkins Infrastructure Image Builder Pipeline"
                    echo "ğŸ“¦ Docker Registry: ${DOCKER_REGISTRY}/${DOCKER_PROJECT}"
                    echo "ğŸ·ï¸ Image Tag: ${IMAGE_TAG}"
                    echo "ğŸ”¨ Force Rebuild: ${params.FORCE_REBUILD}"
                    echo "ğŸ“¤ Push to Registry: ${params.PUSH_TO_REGISTRY}"
                    echo "ğŸ¯ Images to Build: ${params.IMAGES_TO_BUILD}"
                    
                    // Docker registry login (optional for public registry)
                    echo "ğŸ“ Using public Docker registry (no login required)"
                }
            }
        }
        
        stage('Build Images with Ansible') {
            steps {
                script {
                    echo "ğŸ—ï¸ Building Jenkins Images using Ansible jenkins-images role..."
                    
                    // Prepare ansible variables for image building
                    def extraVars = [
                        "jenkins_master_image_tag=${IMAGE_TAG}",
                        "jenkins_agent_image_tag=${IMAGE_TAG}",
                        "jenkins_images_force_rebuild=${params.FORCE_REBUILD}",
                        "jenkins_images_push=${params.PUSH_TO_REGISTRY}"
                    ]
                    
                    // Execute ansible playbook
                    sh """
                        echo "ğŸš€ Executing Ansible playbook to build images..."
                        ansible-playbook -i ansible/inventories/production/hosts.yml \
                            ansible/deploy-images.yml \
                            --extra-vars '${extraVars.join(' ')}' \
                            --extra-vars "images_to_build=${params.IMAGES_TO_BUILD}" \
                            -v
                    """
                }
            }
        }
        
        stage('Security Scanning') {
            when {
                expression { params.PUSH_TO_REGISTRY }
            }
            steps {
                script {
                    echo "ğŸ” Images pushed to registry"
                    echo "ğŸ“Š Built images for: ${params.IMAGES_TO_BUILD}"
                    echo "ğŸ·ï¸ Image tag: ${IMAGE_TAG}"
                    echo "ğŸ“¤ Images available at ${DOCKER_REGISTRY}/${DOCKER_PROJECT}"
                }
            }
        }
        
        stage('Trigger Infrastructure Update') {
            when {
                allOf {
                    expression { params.PUSH_TO_REGISTRY }
                    equals expected: 'all', actual: params.IMAGES_TO_BUILD
                }
            }
            steps {
                script {
                    echo "ğŸ”„ Triggering infrastructure update with new images..."
                    
                    // Trigger the infrastructure update job
                    build job: 'Infrastructure/Infrastructure-Update',
                          parameters: [
                              string(name: 'IMAGE_TAG', value: "${IMAGE_TAG}"),
                              booleanParam(name: 'RESTART_SERVICES', value: true),
                              string(name: 'UPDATE_REASON', value: "New images built: ${IMAGE_TAG}")
                          ],
                          wait: false
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo "ğŸ“Š Build Summary:"
                echo "Images Built: ${params.IMAGES_TO_BUILD}"
                echo "Image Tag: ${IMAGE_TAG}"
                echo "Force Rebuild: ${params.FORCE_REBUILD}"
                echo "Pushed to Registry: ${params.PUSH_TO_REGISTRY}"
                
                // Archive build artifacts
                archiveArtifacts artifacts: '**/Dockerfile*', allowEmptyArchive: true
                
                // Clean workspace
                cleanWs()
            }
        }
        
        success {
            script {
                echo "âœ… Jenkins Images Build Pipeline Completed Successfully!"
                
                // Send notification if configured
                if (env.SLACK_WEBHOOK) {
                    slackSend(
                        channel: '#infrastructure',
                        color: 'good',
                        message: """
                            âœ… Jenkins Images Build Successful
                            
                            ğŸ“¦ Images: ${params.IMAGES_TO_BUILD}
                            ğŸ·ï¸ Tag: ${IMAGE_TAG}
                            ğŸ“¤ Registry: ${DOCKER_REGISTRY}/${DOCKER_PROJECT}
                            â±ï¸ Duration: ${currentBuild.durationString}
                            
                            ğŸ”— Build: ${env.BUILD_URL}
                        """.stripIndent()
                    )
                }
            }
        }
        
        failure {
            script {
                echo "âŒ Jenkins Images Build Pipeline Failed!"
                
                // Send failure notification
                if (env.SLACK_WEBHOOK) {
                    slackSend(
                        channel: '#infrastructure',
                        color: 'danger',
                        message: """
                            âŒ Jenkins Images Build Failed
                            
                            ğŸ“¦ Images: ${params.IMAGES_TO_BUILD}
                            ğŸ·ï¸ Tag: ${IMAGE_TAG}
                            â±ï¸ Duration: ${currentBuild.durationString}
                            
                            ğŸ”— Build: ${env.BUILD_URL}
                            ğŸ“‹ Please check logs for details
                        """.stripIndent()
                    )
                }
            }
        }
        
        unstable {
            script {
                echo "âš ï¸ Jenkins Images Build Pipeline Unstable!"
            }
        }
    }
}
