pipeline {
    agent {
        label 'python'
    }
    
    options {
        buildDiscarder(logRotator(daysToKeepStr: '90', numToKeepStr: '50'))
        timeout(time: 1, unit: 'HOURS')
        timestamps()
        ansiColor('xterm')
        skipStagesAfterUnstable()
        disableConcurrentBuilds()
    }
    
    environment {
        PYTHONPATH = '/home/jenkins/agent'
        PIP_CACHE_DIR = '/home/jenkins/.cache/pip'
        BACKUP_TIMESTAMP = sh(script: 'date +"%Y%m%d_%H%M%S"', returnStdout: true).trim()
    }
    
    parameters {
        choice(
            name: 'BACKUP_TYPE',
            choices: ['incremental', 'full', 'configuration-only', 'volumes-only'],
            description: 'Type of backup to perform'
        )
        choice(
            name: 'ENVIRONMENT',
            choices: ['staging', 'production'],
            description: 'Target environment'
        )
        booleanParam(
            name: 'VERIFY_BACKUP',
            defaultValue: true,
            description: 'Verify backup integrity after creation'
        )
        booleanParam(
            name: 'CLEANUP_OLD_BACKUPS',
            defaultValue: true,
            description: 'Clean up old backups according to retention policy'
        )
        string(
            name: 'CUSTOM_TAG',
            defaultValue: '',
            description: 'Custom tag for backup (optional)'
        )
    }
    
    stages {
        stage('Checkout Code') {
            steps {
                script {
                    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                    echo "ğŸ“¦ Checking out repository..."
                    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                }

                checkout scm

                script {
                    // Verify repository contents
                    sh '''
                        echo "âœ… Repository checked out successfully"
                        echo ""
                        echo "Verifying required directories..."
                        ls -la ansible/ || echo "Warning: ansible/ not found"
                        ls -la scripts/ || echo "Warning: scripts/ not found"
                    '''
                }
            }
        }

        stage('Environment Setup') {
            steps {
                script {
                    sh '''
                        echo "ğŸš€ Jenkins Backup Pipeline"
                        echo "ğŸ¯ Environment: ${params.ENVIRONMENT}"
                        echo "ğŸ“¦ Backup Type: ${params.BACKUP_TYPE}"
                        echo "ğŸ·ï¸ Backup Tag: ${params.CUSTOM_TAG ?: BACKUP_TIMESTAMP}"
                        echo "âœ… Verify Backup: ${params.VERIFY_BACKUP}"
                        echo "ğŸ§¹ Cleanup Old: ${params.CLEANUP_OLD_BACKUPS}"
                        echo "ğŸ Running on Python Agent: ${env.NODE_NAME}"
                        python3 --version
                        pip3 --version
                        which ansible || echo "Ansible not found - will install"
                        which rsync || echo "Rsync not found - will install"
                    '''
                }
            }
        }
        
        stage('Pre-Backup Validation') {
            steps {
                script {
                    sh '''
                        echo "ğŸ” Validating backup prerequisites..."
                        echo "Checking backup destination..."
                        # Add validation for backup mount points
                        df -h || true
                        mount | grep backup || echo "Backup mount not found"
                        echo "Checking Jenkins services status..."
                        ansible -i ansible/inventories/${ENVIRONMENT}/hosts.yml \
                            jenkins_masters -m shell \
                            -a "systemctl is-active jenkins-master || true"
                    '''
                }
            }
        }
        
        stage('Execute Backup') {
            steps {
                script {
                    def backupTag = params.CUSTOM_TAG ?: BACKUP_TIMESTAMP
                    def extraVars = [
                        "backup_type=${params.BACKUP_TYPE}",
                        "backup_tag=${backupTag}",
                        "verify_backup=${params.VERIFY_BACKUP}",
                        "cleanup_old_backups=${params.CLEANUP_OLD_BACKUPS}"
                    ]
                    
                    sh """
                        echo "ğŸ“¦ Executing ${params.BACKUP_TYPE} backup..."
                        echo "ğŸš€ Running Ansible backup playbook..."
                        ansible-playbook -i ansible/inventories/${params.ENVIRONMENT}/hosts.yml \
                            ansible/site.yml \
                            --tags backup \
                            --extra-vars '${extraVars.join(' ')}' \
                            -v
                    """
                }
            }
        }
        
        stage('Backup Verification') {
            when {
                expression { params.VERIFY_BACKUP }
            }
            steps {
                script {
                    sh '''
                        echo "âœ… Verifying backup integrity..."
                        echo "Running backup verification scripts..."
                        # Add backup verification logic
                        python3 -c "print('Backup verification completed')" 
                    '''
                }
            }
        }
        
        stage('Cleanup Old Backups') {
            when {
                expression { params.CLEANUP_OLD_BACKUPS }
            }
            steps {
                script {
                    sh '''
                        echo "ğŸ§¹ Cleaning up old backups..."
                        echo "Running backup cleanup..."
                        # Add cleanup logic based on retention policies
                        find /backup -type f -name "*.tar.gz" -mtime +30 -ls || true
                    '''
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo "ğŸ“Š Backup Pipeline Summary:"
                echo "Environment: ${params.ENVIRONMENT}"
                echo "Backup Type: ${params.BACKUP_TYPE}"
                echo "Backup Tag: ${params.CUSTOM_TAG ?: BACKUP_TIMESTAMP}"
                echo "Duration: ${currentBuild.durationString}"
                
                // Archive backup logs
                archiveArtifacts artifacts: '**/backup-*.log', allowEmptyArchive: true
            }
            
            // Clean workspace on python agent
            cleanWs(
                cleanWhenAborted: true,
                cleanWhenFailure: true,
                cleanWhenNotBuilt: true,
                cleanWhenSuccess: true,
                cleanWhenUnstable: true,
                deleteDirs: true
            )
        }
        
        success {
            script {
                echo "âœ… Backup Pipeline Completed Successfully!"
            }
        }
        
        failure {
            script {
                echo "âŒ Backup Pipeline Failed!"
            }
        }
    }
}
